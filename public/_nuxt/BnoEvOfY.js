import{_ as te}from"./Bmr5wyhr.js";import{_ as oe}from"./DnQg8zF_.js";import se from"./CNFJry-h.js";import{_ as re}from"./D8Osd5Ax.js";import{_ as ne}from"./D9TSNOAg.js";import{_ as ae}from"./BsJBhgTW.js";import{_ as ie}from"./CjugPKIA.js";import{h as le,u as ce,a as de,b as pe,c as me,e as ue,_ as _e,d as fe,f as ge,g as ye}from"./Co5irYNj.js";import{_ as ve}from"./CaSHqX9y.js";import{_ as we}from"./cLgFti_O.js";import{e as he,g as ke,K as xe,r as g,i as $e,c as m,a as l,b as t,m as be,D as R,l as r,w as a,t as u,d as _,F as h,z as k,u as Ce,o as d}from"./LcRD3ia0.js";import"./DfRdkKc3.js";import"./D5ydJhlK.js";import"./DkkQ8vn7.js";import"./D8EW8v7U.js";import"./BdQOAs7V.js";import"./BOGtf0gU.js";import"./QkXyQO2w.js";import"./B-kig6KZ.js";import"./BqmAL8DW.js";import"./Pvv-dh1L.js";import"./C0YhWajo.js";import"./BcuVElyA.js";import"./mqOaxR0N.js";import"./D6LOIvye.js";import"./AeDsR3BR.js";import"./BcyKike4.js";import"./CCJdEHHg.js";import"./BgkA-2sO.js";import"./Dbg8U1qb.js";import"./DaWZu8wl.js";import"./CNLsaPwj.js";import"./BCRlC5xu.js";import"./fRExJa2e.js";import"./CP8umD4q.js";import"./Da2JRHOT.js";import"./voh6vBZz.js";const Ae={class:"flex relative"},De={class:"w-[50px] fixed"},Ue={class:"p-3 w-full ml-[50px] flex justify-center gap-3"},Me={class:"flex flex-col max-w-[720px] w-full gap-3 p-4 bg-slate-100 rounded-md shadow"},Le={class:"flex"},Ie={class:"flex font-semibold"},Ne={class:"flex font-semibold"},Fe={class:"flex"},Oe=["onClick"],ht=he({__name:"[id]",setup(Te){const{$useApi:p}=ke(),f=xe().params.id,x={id:0,title:"Пусто",price:1e4,status:"null",deadline:"-----",clothingMethod:"string",description:"string",source:"string",adTag:"string",discont:"string",sphere:"string",city:"string",region:"string",cardLink:"string",paid:"string",totalPrice:1,dopsPrice:1,recievedPayments:1,remainder:1,firstPayment:"string",clientType:"string",recievedPay:1,createdAt:"",dealers:[],client:{id:0,fullName:"string",workSpaceId:0,groupId:0,phone:"string",type:"string",chatLink:"string",gender:"string",firstContact:"string",adLink:"string",inn:"string"},preorder:{preview:"string"},deliveries:[{id:0,method:"string",type:"string",description:"string",track:"string",status:"string",price:0}]},s=g({...x}),$=g([...x.deliveries]),b=g([]),E=g(!0),C=g([]),A=async()=>{try{const{data:e}=await p.get(`production/deals/${f}`),{data:o}=await p.get("kaiten/card/"+e.card_id),{data:c}=await p.get("production/workers");o!=="Nope"&&(e.preorder=o),s.value=e,C.value=c,console.log(e.files),Ce({title:e.title?`${e.title} | Easy CRM`:"Easy CRM"})}catch(e){console.error("Ошибка при загрузке сделки:",e)}};async function P(){try{const e=await p.get("/stages");b.value=e.data}catch(e){console.error("Ошибка при загрузке стадий:",e)}finally{E.value=!1}}async function z(e,o){try{s.value.orders[e]=o,console.log("Стадия успешно изменена")}catch(c){console.error("Ошибка при изменении стадии:",c),console.log("Ошибка при изменении стадии")}}const v=async()=>{try{const{data:e}=await p.get(`/deals/${f}/deliveries`);console.log(e),$.value=e.deliveries||[];return}catch(e){console.log(e)}},D=async()=>{try{const{data:e}=await p.get(`/deals/${f}/files`);s.value.files=e.files||[];return}catch(e){console.log(e)}},S=async()=>{try{const{data:e}=await p.get(`/deals/${f}/orders`);s.value.orders=e.orders||[];return}catch(e){console.log(e)}},B=async()=>{try{await navigator.clipboard.writeText("https://easy-crm.pro/orders/"+f),console.log("Ссылка скопирована в буфер обмена!")}catch(e){console.error("Ошибка копирования ссылки:",e)}},j=async e=>{const o=`https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(e)}`,c={Accept:"application/json",Authorization:"OAuth y0_AgAEA7qkcvrzAADLWwAAAAD3ffQIQaf8Plw0QhqCi-7Zcz02CNT3scc"};try{const i=await fetch(o,{method:"GET",headers:c});if(!i.ok)throw new Error(`Ошибка: ${i.status} ${i.statusText}`);return await i.json()}catch(i){throw console.error("Ошибка при выполнении запроса:",i),i}},V=async(e,o)=>{try{const c=await j(e);if(c&&c.file){const i=document.createElement("a");i.href=c.file,i.download=o,document.body.appendChild(i),i.click(),document.body.removeChild(i)}else console.error("Ресурс не найден или ссылка отсутствует")}catch(c){console.error("Ошибка при получении ресурса:",c)}},Q=()=>{console.log("deal-updated"),A()},q=async e=>{try{await p.delete(`files/${e}`),await D()}catch(o){console.log(o)}},W=e=>{e?window.open(e,"_blank"):console.error("URL отсутствует")};return $e(()=>{A(),v(),P()}),(e,o)=>{const c=te,i=oe,w=se,U=re,M=ne,L=ae,Y=ie,I=pe,G=ue,N=me,F=de,O=_e,H=ve,K=fe,Z=we,J=ge,X=ye,ee=le;return d(),m("div",Ae,[l("div",De,[t(c)]),l("div",Ue,[l("div",Me,[r(s).preorder.preview?(d(),be(i,{key:0,src:r(s).preorder.preview,alt:"Предпросмотр",class:"mb-2 rounded w-full cursor-pointer",onClick:o[0]||(o[0]=n=>W(r(s).preorder.preview))},null,8,["src"])):R("",!0),l("div",null,[l("div",Le,[t(U,{class:"h-6 w-6 mr-2 p-0",onClick:o[1]||(o[1]=n=>B())},{default:a(()=>[t(w,{name:"bx:copy",color:"white",size:"18px"})]),_:1}),l("strong",null,u(r(s)?.title||"Неизвестная сделка"),1)]),l("div",null,"Готовность: "+u(("useMyFormatDate"in e?e.useMyFormatDate:r(ce))(r(s).deadline)),1),l("div",null,[o[2]||(o[2]=_(" Ссылка на сделку: ",-1)),t(L,null,{default:a(()=>[t(M,{to:r(s).client.chatLink,target:"_blank"},{default:a(()=>[l("span",null,u(r(s).client.chatLink.includes("amo")?"amo":"bluesaless"),1)]),_:1},8,["to"])]),_:1})]),l("div",null,[t(L,{class:"mb-2"},{default:a(()=>[t(M,{to:`${r(s).preorder.maket}?name=${encodeURIComponent(r(s).title)}.cdr&dl=true`,target:"_blank"},{default:a(()=>o[3]||(o[3]=[_(" Скачать макет ",-1)])),_:1,__:[3]},8,["to"])]),_:1})])]),l("div",null,[l("div",Ie,[t(Y,{deal:r(s),class:"mr-2 justify-between",onOrderCreated:Q},null,8,["deal"]),o[4]||(o[4]=_(" Задание: ",-1))]),(d(!0),m(h,null,k(r(s).orders,(n,y)=>(d(),m("div",{key:n.id,class:"w-full"},[t(O,{type:"single",collapsible:""},{default:a(()=>[t(F,{value:"item-1"},{default:a(()=>[t(I,{class:"p-0 pl-2 bg-slate-200/60 rounded-t-sm mb-1"},{default:a(()=>[_("Заказ "+u(`(${n.stage.title})`),1)]),_:2},1024),t(N,null,{default:a(()=>[t(G,{order:n,stages:r(b),workers:r(C),"from-page":"id",onChangeStage:T=>z(y,T.order),onUpdateOrdersList:S},null,8,["order","stages","workers","onChangeStage"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128))]),l("div",null,[l("div",Ne,[t(H,{deal:r(s),class:"mr-2",onDeliveryCreated:v},null,8,["deal"]),o[5]||(o[5]=_(" Доставка: ",-1))]),(d(!0),m(h,null,k(r($),(n,y)=>(d(),m("div",{key:n.id,class:"w-full"},[t(O,{type:"single",collapsible:""},{default:a(()=>[t(F,{value:"item-1"},{default:a(()=>[t(I,{class:"p-0 pl-2 bg-slate-200/60 rounded-t-sm mb-1"},{default:a(()=>[_(u(n.method)+" "+u(n.track?"("+n.track+")":""),1)]),_:2},1024),t(N,null,{default:a(()=>[t(K,{delivery:n,onDeliveryDeleted:v},null,8,["delivery"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128))]),t(ee,null,{default:a(()=>[l("div",Fe,[t(Z,{deal:r(s),onFileUploaded:D},null,8,["deal"]),t(J,{class:"font-semibold pl-2 w-full text-left bg-slate-200/60 flex items-center justify-between"},{default:a(()=>[o[6]||(o[6]=_(" Документы: ",-1)),t(w,{class:"ml-auto",name:"mingcute:arrows-down-line",size:"18px"})]),_:1,__:[6]})]),t(X,null,{default:a(()=>[(d(!0),m(h,null,k(r(s).files,(n,y)=>(d(),m("div",{key:y,class:"flex gap-2 p-2"},[t(U,{class:"w-5 h-5 p-0",variant:"destructive",onClick:()=>q(n.id)},{default:a(()=>[t(w,{name:"streamline:delete-1-solid",color:"",size:"11px"})]),_:2},1032,["onClick"]),n.type==="documents"?(d(),m("div",{key:0,class:"underline decoration-solid cursor-pointer text-blue-600",onClick:T=>V(`EasyCRM/documents/${n.ya_name}`,n.name)},u(n.name),9,Oe)):R("",!0)]))),128))]),_:1})]),_:1})])])])}}});export{ht as default};
