import{_ as G}from"./Bmr5wyhr.js";import{a as J,b as q,_ as Q}from"./CNLsaPwj.js";import{_ as X}from"./BCRlC5xu.js";import{_ as Y}from"./fRExJa2e.js";import{_ as Z}from"./CP8umD4q.js";import{_ as ee}from"./mqOaxR0N.js";import{_ as te,a as ae}from"./B5gfxeH_.js";import{_ as r,v as z}from"./D8Osd5Ax.js";import{b as se,_ as le,a as oe}from"./CACSUplU.js";import{_ as re}from"./BXoTK-I8.js";import{b as ne,c as ce,d as ie,e as de,_ as ue,a as ge}from"./Df1Q6CGn.js";import{u as pe,F as E,g as me,a as _e,b as fe,A as n}from"./DSl2Rovl.js";import{a as xe}from"./BcyKike4.js";import{e as L,r as P,v as he,B as O,c as k,a as w,b as i,l as f,w as c,F as D,o as u,d as M,z as U,t as W,m as V,D as ve,G as t,g as Se,u as we,J as ye,i as ke,H as Ce}from"./LcRD3ia0.js";import{u as m}from"./Dt19OLxm.js";import"./DfRdkKc3.js";import"./D5ydJhlK.js";import"./D9TSNOAg.js";import"./DkkQ8vn7.js";import"./D8EW8v7U.js";import"./BdQOAs7V.js";import"./BOGtf0gU.js";import"./QkXyQO2w.js";import"./D6LOIvye.js";import"./CNFJry-h.js";import"./B-kig6KZ.js";import"./Pvv-dh1L.js";const be={class:"flex mb-2 justify-between"},Ie={class:"rounded-md border max-h-[calc(100vh-320px)] overflow-y-scroll bg-slate-100"},Ve=L({__name:"DataTable",props:{columns:{},data:{},filters:{}},emits:["deal-clicked","table-sorted","is-plan-set"],setup(e,{emit:_}){const g=e,F=P([]),C=P([]),p=P({}),y=pe({get data(){return g.data},get columns(){return g.columns},getCoreRowModel:fe(),getSortedRowModel:_e(),getFilteredRowModel:me(),onSortingChange:s=>z(s,F),onColumnFiltersChange:s=>z(s,C),onColumnVisibilityChange:s=>z(s,p),state:{get sorting(){return F.value},get columnFilters(){return C.value},get columnVisibility(){return p.value}},meta:{onPlanSet:(s,v)=>{A("is-plan-set",{managerId:s,newPlan:v})}}}),A=_,R=he(()=>({workspaces:g.filters.workspaces.map(s=>({value:s.id,label:s.title})),groups:g.filters.groups.map(s=>({value:s.id,label:s.title})),managers:g.filters.managers.map(s=>({value:s.id,label:s.fullName}))}));return O(()=>y.getSortedRowModel().rows,s=>{console.log("Сортировка изменилась:",s);const v=s.map($=>$.original.id);A("table-sorted",v)},{deep:!0}),(s,v)=>{const $=te,j=r,a=le,l=re,S=oe,b=se,I=ie,T=ge,B=ce,N=ue,H=de,K=ne;return u(),k(D,null,[w("div",be,[i($,{table:f(y),filters:R.value},null,8,["table","filters"]),w("div",null,[i(b,null,{default:c(()=>[i(a,null,{default:c(()=>[i(j,{variant:"outline",class:"ml-auto"},{default:c(()=>[v[0]||(v[0]=M(" Колонки ",-1)),i(f(xe),{class:"w-4 h-4 ml-2"})]),_:1,__:[0]})]),_:1}),i(S,{class:"w-[180px]"},{default:c(()=>[(u(!0),k(D,null,U(f(y).getAllColumns().filter(d=>d.getCanHide()),d=>(u(),k("div",{key:d.id},[i(l,{checked:d.getIsVisible(),"onUpdate:checked":o=>{d.toggleVisibility(!!o)}},null,8,["checked","onUpdate:checked"]),M(" "+W(d.columnDef.ruName),1)]))),128))]),_:1})]),_:1})])]),w("div",Ie,[i(K,null,{default:c(()=>[i(B,{class:"bg-white"},{default:c(()=>[(u(!0),k(D,null,U(f(y).getHeaderGroups(),d=>(u(),V(T,{key:d.id},{default:c(()=>[(u(!0),k(D,null,U(d.headers,o=>(u(),V(I,{key:o.id},{default:c(()=>[o.isPlaceholder?ve("",!0):(u(),V(f(E),{key:0,render:o.column.columnDef.header,props:o.getContext()},null,8,["render","props"]))]),_:2},1024))),128))]),_:2},1024))),128))]),_:1}),i(H,null,{default:c(()=>[f(y).getRowModel().rows?.length?(u(!0),k(D,{key:0},U(f(y).getRowModel().rows,d=>(u(),V(T,{key:d.id,"data-state":d.getIsSelected()?"selected":void 0},{default:c(()=>[(u(!0),k(D,null,U(d.getVisibleCells(),o=>(u(),V(N,{key:o.id},{default:c(()=>[i(f(E),{render:o.column.columnDef.cell,props:o.getContext()},null,8,["render","props"])]),_:2},1024))),128))]),_:2},1032,["data-state"]))),128)):(u(),V(T,{key:1},{default:c(()=>[i(N,{colspan:s.columns.length,class:"text-left"},{default:c(()=>v[1]||(v[1]=[M(" Нет результатов. ",-1)])),_:1,__:[1]},8,["colspan"])]),_:1}))]),_:1})]),_:1})])],64)}}}),Te=[{accessorKey:"manager",ruName:"Менеджер",enableHiding:!1,header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Менеджер",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e,table:_})=>t("div",{class:"flex items-center gap-2"},[t(ae,{period:e.original.period,plan:e.original.plan,managerId:e.original.managerId,manager:e.original.manager,onIsPlanSet:g=>{_.options.meta?.onPlanSet?.(e.original.managerId,g)}}),t("span",{class:"whitespace-nowrap"},`${e.original.manager} ${e.original.fired?"(Уволен)":""}`)])},{accessorKey:"totalSales",ruName:"Продажи",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Продажи",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},m(e.getValue("totalSales"))+"₽")},{accessorKey:"plan",ruName:"План",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["План",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},m(e.getValue("plan"))+"₽")},{accessorKey:"salesToPlan",ruName:"% от плана",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["% от плана",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("salesToPlan")+"%")},{accessorKey:"remainder",ruName:"Остаток до плана",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Остаток до плана",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},m(e.getValue("remainder"))+"₽")},{accessorKey:"receivedPayments",ruName:"Выручка",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Выручка",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},m(e.getValue("receivedPayments"))+"₽")},{accessorKey:"averageBill",ruName:"Средний чек",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Средний чек",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},m(e.getValue("averageBill"))+"₽")},{accessorKey:"dealsSales",ruName:"Сумма сделок",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Сумма сделок",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},m(e.getValue("dealsSales"))+"₽")},{accessorKey:"dealsAmount",ruName:"Кол-во сделок",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Кол-во сделок",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("dealsAmount"))},{accessorKey:"dopsSales",ruName:"Допы (сумма)",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Допы (сумма)",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},m(e.getValue("dopsSales"))+"₽")},{accessorKey:"dopsToSales",ruName:"% от продаж",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Допы к продажам (%)",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("dopsToSales")+"%")},{accessorKey:"dopsAmount",ruName:"Кол-во допов",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Кол-во допов",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("dopsAmount"))},{accessorKey:"dealsSalesWithoutDesigners",ruName:"Продаж без дизайнеров",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Продаж без дизайнеров",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},m(e.getValue("dealsSalesWithoutDesigners"))+"₽")},{accessorKey:"dealsWithoutDesigners",ruName:"Сделки без дизайнеров",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Сделки без дизайнеров",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("dealsWithoutDesigners"))},{accessorKey:"dealsDayToDayCount",ruName:"Сделки день в день",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Сделки день в день",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("dealsDayToDayCount"))},{accessorKey:"calls",ruName:"Заявки",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Заявки",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("calls"))},{accessorKey:"makets",ruName:"Макеты",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Макеты",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("makets"))},{accessorKey:"maketsDayToDay",ruName:"Макеты день в день",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Макеты день в день",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("maketsDayToDay"))},{accessorKey:"conversionMaket",ruName:"Конверсия из заявки в макет",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Конверсия из заявки в макет",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("conversionMaket")+"%")},{accessorKey:"conversionMaketDayToDay",ruName:"Конверсия из заявки в макет день в день",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Конверсия из заявки в макет день в день",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("conversionMaketDayToDay")+"%")},{accessorKey:"conversionToSale",ruName:"Конверсия из макета в продажу",header:({column:e})=>t(r,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-wrap h-full"},()=>["Конверсия из макета в продажу",t(n,{class:"h-[20px] w-[20px]"})]),cell:({row:e})=>t("div",{class:"text-center"},e.getValue("conversionToSale")+"%")},{accessorKey:"workSpaceId",enableHiding:!1,ruName:"Отдел",header:()=>t("div",{class:"text-center"},""),cell:()=>t("div",{class:"text-center"},""),filterFn:(e,_,g)=>g.includes(e.getValue(_))},{accessorKey:"groupId",enableHiding:!1,ruName:"Группа",header:()=>t("div",{class:"text-center"},""),cell:()=>t("div",{class:"text-center"},""),filterFn:(e,_,g)=>g.includes(e.getValue(_))},{accessorKey:"managerId",enableHiding:!1,ruName:"Менеджер",header:()=>t("div",{class:"text-center"},""),cell:()=>t("div",{class:"text-center"},""),filterFn:(e,_,g)=>g.includes(e.getValue(_))}],Ne={class:"relative h-screen hidden-scrollbar"},De={class:"w-full fixed z-10"},Pe={class:"h-[full] flex p-4 gap-4 mx-[auto] max-w-[2048px] pt-16"},$e={class:"flex flex-col gap-4 min-w-[1050px] w-full"},Ke={class:"flex gap-4"},Ue={class:"text-xs text-muted-foreground"},Me={class:""},Fe={class:"mt-[-8px]"},dt=L({__name:"index",async setup(e){let _,g;const{$useApi:F}=Se();we({title:"Планы | Easy CRM"});const C=P(new Date().toISOString().slice(0,7)),p=P([]),y=P([{title:"Общий план",value:"0",content:"",footer:""},{title:"Продажи",value:"0",content:"",footer:""},{title:"Выручка(Факт)",value:"0",content:"",footer:""},{title:"Сделки",value:"0",content:"",footer:""},{title:"Доп. услуги",value:"0",content:"",footer:""}]),A=P({workspaces:[],groups:[],managers:[]}),{data:R}=([_,g]=ye(()=>F.get("/dashboards/deals")),_=await _,g(),_);A.value={workspaces:R?.workSpaces||[],groups:R?.groups||[],managers:R?.managers||[]};const s=async()=>{try{const{data:a}=await F.get("/dashboards/managers",{params:{period:C.value}});p.value=a||[];const l=a.map(S=>S.id);$(l)}catch(a){console.log(a)}},v=a=>{y.value=[{title:"Общий план",value:m(a.totalPlan)+"₽",content:"Остаток",footer:m(a.remainder)+"₽"},{title:"Продажи",value:m(a.totalSales)+"₽",content:"Процент от плана",footer:a.salesToPlan.toFixed()+"%"},{title:"Выручка(Факт)",value:m(a.receivedPayments)+"₽",content:"Средний чек",footer:m(+a.averageBill.toFixed())+"₽"},{title:"Сделки",value:m(a.dealsSales)+"₽",content:"Колличество сделок",footer:a.dealsAmount.toString()},{title:"Доп. услуги",value:m(a.dopsSales)+"₽",content:"Процент от продаж",footer:a.dopsToSales.toFixed()+"%"}]},$=a=>{const l=p.value.filter(x=>a.includes(x.id));console.log("sdasdasda");const S=l.reduce((x,h)=>x+h.dealsAmount,0),b=l.reduce((x,h)=>x+h.plan,0),I=l.reduce((x,h)=>x+h.totalSales,0),T=b-I,B=b?I/b*100:0,N=l.reduce((x,h)=>x+h.dealsSales,0),H=N/S||0,K=l.reduce((x,h)=>x+h.dopsSales,0),d=l.reduce((x,h)=>x+h.receivedPayments,0),o=K/I*100||0;v({dealsAmount:S,totalPlan:b,remainder:T,totalSales:I,receivedPayments:d,salesToPlan:B,averageBill:H,dealsSales:N,dopsSales:K,dopsToSales:o})},j=a=>{const l=p.value.findIndex(S=>S.managerId===a.managerId);l!==-1&&(p.value[l].plan=a.newPlan,p.value[l].remainder=a.newPlan-p.value[l].totalSales,p.value[l].salesToPlan=a.newPlan?+(p.value[l].totalSales/a.newPlan*100).toFixed():0,p.value=[...p.value])};return O(C,async()=>{await s()}),ke(async()=>{await s()}),(a,l)=>{const S=G,b=X,I=q,T=J,B=Y,N=Z,H=Q,K=ee,d=Ve;return u(),k("div",Ne,[w("div",De,[i(S)]),w("div",Pe,[w("div",$e,[w("div",Ke,[(u(!0),k(D,null,U(f(y),o=>(u(),V(H,{key:o.title,class:"min-w-[150px] grow"},{default:c(()=>[i(T,{class:"p-3 pb-2"},{default:c(()=>[i(b,null,{default:c(()=>[M(W(o.title),1)]),_:2},1024),i(I,{class:"text-3xl font-semibold whitespace-nowrap"},{default:c(()=>[M(W(o.value),1)]),_:2},1024)]),_:2},1024),i(B,{class:"pb-1 pl-3"},{default:c(()=>[w("div",Ue,W(o.content),1)]),_:2},1024),i(N,{class:"pl-3 pb-1"},{default:c(()=>[M(W(o.footer),1)]),_:2},1024)]),_:2},1024))),128))]),w("div",Me,[i(K,{modelValue:f(C),"onUpdate:modelValue":l[0]||(l[0]=o=>Ce(C)?C.value=o:null),type:"month",class:"w-[180px]"},null,8,["modelValue"])]),w("div",Fe,[(u(),V(d,{key:f(p).length,columns:f(Te),data:f(p),filters:f(A),onTableSorted:l[1]||(l[1]=o=>$(o)),onIsPlanSet:j},null,8,["columns","data","filters"]))])])])])}}});export{dt as default};
