import{_ as we}from"./Bye7C16d.js";import he from"./ROxBBV8N.js";import{_ as ke}from"./CDst0A0O.js";import{_ as $e,a as be,b as xe,c as Ue,d as Ce}from"./JYeLPbKT.js";import{_ as De}from"./DLLw9AXE.js";import{_ as Ae}from"./BFj2DODp.js";import{_ as Se}from"./BWn7SjA7.js";import{_ as Le}from"./CprHmdOe.js";import{_ as Te}from"./Bh3bOtDY.js";import{_ as Ve}from"./CaPtdwNj.js";import{_ as j,a as q,b as Q,c as G,d as Ee,u as Ne,e as Be}from"./CaE-P5HS.js";import{e as H,g as Y,r as v,c as u,o as i,F as A,z as S,l,b as s,w as a,d as $,t as m,u as Ie,B as ze,i as Me,a as c,m as C,D as k,H as O}from"./BbheI0mw.js";import{_ as Pe,a as Re,b as Fe}from"./DFGFWj04.js";import"./D0Fd2yXn.js";import"./B9M8ggfK.js";import"./oLxPQbNe.js";import"./D2GZmoDz.js";import"./DVdymwQ5.js";import"./KSX9JOtw.js";import"./ZTyVILcU.js";import"./s39mgViW.js";import"./CJOOd8Dx.js";import"./BR3DQNok.js";import"./odSmgr3d.js";import"./DzJc7hp_.js";import"./CCknexPU.js";import"./_14b2CUj.js";import"./CssJESp-.js";import"./B7XstORc.js";import"./cStEOrWd.js";import"./BHuR11Jx.js";import"./DiZ4QL0M.js";import"./Deo3HQM0.js";import"./C30fSUvl.js";import"./D-8t_H8v.js";import"./QXfa84Px.js";import"./DaWZu8wl.js";import"./D0zfKHPR.js";import"./l1eRtAXP.js";import"./BhleEUCu.js";import"./BND4UK_1.js";import"./CaiudRgb.js";import"./jAsYS30d.js";import"./CHKwxJtM.js";import"./Sc4DFA1e.js";const Oe=H({__name:"DeliveryList",props:{deliveries:{}},emits:["delivery-deleted"],setup(M,{emit:b}){const{$useApi:E}=Y(),d=v({...M.deliveries}),h=async(U,f)=>{try{const{data:p}=await E.get(`/deliveries/${f}`);d.value[U]=p}catch(p){console.log(p)}},x=b;return(U,f)=>{const p=Q,L=Ee,y=G,N=q,D=j;return i(!0),u(A,null,S(l(d),(w,P)=>(i(),u("div",{key:w.id,class:"w-full"},[s(D,{type:"single",collapsible:""},{default:a(()=>[s(N,{value:"item-1"},{default:a(()=>[s(p,{class:"p-0 pl-2 bg-slate-200/60 rounded-t-sm mb-1"},{default:a(()=>[$(m(w.method)+" "+m(w.track?"("+w.track+")":""),1)]),_:2},1024),s(y,null,{default:a(()=>[s(L,{delivery:w,onDeliveryEdited:async()=>await h(+P,w.id),onDeliveryDeleted:f[0]||(f[0]=R=>x("delivery-deleted"))},null,8,["delivery","onDeliveryEdited"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128)}}}),je={class:"flex relative h-screen overflow-hidden"},qe={class:"w-[50px] fixed"},Qe={class:"flex flex-col p-3 h-full w-[calc(100%-0px)] items-center overflow-auto"},Ge={class:"max-w-[720px] w-full flex items-center gap-2"},He={class:"flex w-full items-center gap-2"},Ye={class:"flex items-center gap-2"},We={key:1,class:"w-full"},Ze={class:"max-w-[720px] w-full"},Je={key:0},Ke={key:1,class:"mt-4 space-y-2"},Xe={class:"flex"},et={class:"font-semibold"},tt={class:"mt-2"},ot={class:"flex"},st=["onClick"],nt={class:"mt-4 text-sm text-gray-600"},Zt=H({__name:"index",setup(M){const b=v([]),E=v(!0),_=v("1"),d=v([]),h=v(!1),x=v(0),U=v(0),f=v(!1),p=v(""),L=v([]),{$useApi:y}=Y();Ie({title:"Производство"});async function N(){try{const t=await y.get("/stages");b.value=t.data;const{data:e}=await y.get("production/workers");L.value=e}catch(t){console.error("Ошибка при загрузке стадий:",t)}finally{E.value=!1}}async function D(){if(console.log("loadDealsForStage"),!!_.value){h.value=!0;try{const t=await y.get(`production/stage/${_.value}`),e=t.data.deals;await Promise.all(e.map(async n=>{try{const o=await y.get(`kaiten/card/${n.card_id}`);n.preorder=o.data}catch(o){console.error(`Ошибка при загрузке preorder для сделки ${n.id}:`,o),n.preorder=null}})),d.value=e,x.value=t.data.total,U.value=t.data.totalPages}catch(t){console.error("Ошибка при загрузке сделок:",t)}finally{h.value=!1}}}async function w(){if(h.value=!0,!!p.value.trim())try{const t=await y.get("production/deals",{params:{title:p.value}}),e=t.data.deals;await Promise.all(e.map(async n=>{try{const o=await y.get(`kaiten/card/${n.card_id}`);n.preorder=o.data}catch(o){console.error(`Ошибка при загрузке preorder для сделки ${n.id}:`,o),n.preorder=null}})),d.value=e,x.value=t.data.total,U.value=t.data.totalPages}catch(t){console.error("Ошибка при загрузке сделок:",t)}finally{h.value=!1}}const R=((t,e)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>t(...o),e)}})(t=>w(),1e3),W=()=>{R(p.value)};async function Z(t,e,n){try{if(d.value[t].orders[e]=n,console.log(!!d.value[t].orders.filter(o=>o.stageId===+_.value).length),d.value[t].orders.filter(o=>o.stageId===+_.value).length)return console.log("stay");d.value.splice(t,1),console.log("Стадия успешно изменена")}catch(o){console.error("Ошибка при изменении стадии:",o),console.log("Ошибка при изменении стадии")}}const J=async t=>{const e=`https://cloud-api.yandex.net/v1/disk/resources?path=${encodeURIComponent(t)}`,n={Accept:"application/json",Authorization:"OAuth y0_AgAEA7qkcvrzAADLWwAAAAD3ffQIQaf8Plw0QhqCi-7Zcz02CNT3scc"};try{const o=await fetch(e,{method:"GET",headers:n});if(!o.ok)throw new Error(`Ошибка: ${o.status} ${o.statusText}`);return await o.json()}catch(o){throw console.error("Ошибка при выполнении запроса:",o),o}},K=async(t,e)=>{try{const n=await J(t);if(n&&n.file){const o=document.createElement("a");o.href=n.file,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o)}else console.error("Ресурс не найден или ссылка отсутствует")}catch(n){console.error("Ошибка при получении ресурса:",n)}},X=async t=>{try{await navigator.clipboard.writeText("https://easy-crm.pro"+t),console.log("Ссылка скопирована в буфер обмена!")}catch(e){console.error("Ошибка копирования ссылки:",e)}},ee=async(t,e)=>{try{const{data:n}=await y.get(`/deals/${e}/orders`);if(d.value[t].orders=n.orders,d.value[t].orders.filter(o=>o.stageId===+_.value).length)return console.log("stay");d.value.splice(t,1),console.log("order deleted")}catch(n){console.log(n)}};return ze(_,()=>{D()}),Me(()=>{N(),D(),console.log("sadsdasd",d.value[0])}),console.log("prod/index"),(t,e)=>{const n=we,o=he,B=ke,te=xe,oe=be,se=Ae,I=Se,ne=Ce,re=De,ae=Ue,le=$e,ie=Le,ce=Te,z=Ve,de=Q,ue=Be,me=G,pe=q,_e=j,fe=Oe,ve=Pe,ge=Re,ye=Fe;return i(),u("div",je,[c("div",null,[c("div",qe,[s(n)]),e[4]||(e[4]=c("div",{class:"mr-[50px]"},null,-1))]),c("div",Qe,[c("div",Ge,[l(f)?(i(),C(B,{key:0,variant:"outline",onClick:e[0]||(e[0]=async()=>{f.value=!1,await D(),p.value=""})},{default:a(()=>[s(o,{name:"ic:round-menu",color:"",size:"20px"})]),_:1})):k("",!0),c("div",He,[l(f)?k("",!0):(i(),C(le,{key:0,modelValue:l(_),"onUpdate:modelValue":e[1]||(e[1]=r=>O(_)?_.value=r:null),class:"w-full"},{default:a(()=>[s(oe,null,{default:a(()=>[s(te,{placeholder:"Выберите стадию"})]),_:1}),s(ae,null,{default:a(()=>[s(re,null,{default:a(()=>[s(se,null,{default:a(()=>e[5]||(e[5]=[$("Стадии",-1)])),_:1,__:[5]}),(i(!0),u(A,null,S(l(b),r=>(i(),C(ne,{key:r.id,value:r.id.toString()},{default:a(()=>[c("div",Ye,[c("div",null,m(r.title),1),r.id.toString()===l(_)?(i(),C(I,{key:0,class:"rounded-sm py-0",variant:"outline"},{default:a(()=>[$(m(l(x)),1)]),_:1})):k("",!0)])]),_:2},1032,["value"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])),l(f)?(i(),u("div",We,[s(ie,{modelValue:l(p),"onUpdate:modelValue":e[2]||(e[2]=r=>O(p)?p.value=r:null),class:"pl-8 w-full",type:"search",placeholder:"Искать сделки...",onInput:W},null,8,["modelValue"])])):k("",!0)]),l(f)?k("",!0):(i(),C(B,{key:1,variant:"outline",onClick:e[3]||(e[3]=()=>{f.value=!0,console.log(l(f))})},{default:a(()=>[s(o,{name:"humbleicons:search",color:"",size:"20px"})]),_:1}))]),c("div",Ze,[l(h)?(i(),u("div",Je,"Загрузка сделок...")):(i(),u("ul",Ke,[(i(!0),u(A,null,S(l(d),(r,F)=>(i(),u("li",{key:r.id,class:"p-4 bg-slate-100 rounded-md shadow"},[r.preorder?.preview?(i(),C(ce,{key:0,src:r.preorder.preview,alt:"Предпросмотр",class:"mb-2 rounded w-full"},null,8,["src"])):k("",!0),c("div",Xe,[s(B,{class:"h-6 w-6 mr-2 p-0",onClick:g=>X("/orders/"+r.id)},{default:a(()=>[s(o,{name:"bx:copy",color:"white",size:"18px"})]),_:2},1032,["onClick"]),s(z,{to:"/orders/"+r.id},{default:a(()=>[c("strong",null,m(r.title),1)]),_:2},1032,["to"])]),c("div",null,"Готовность: "+m(("useMyFormatDate"in t?t.useMyFormatDate:l(Ne))(r.deadline)),1),c("div",null,[e[6]||(e[6]=$(" Ссылка на сделку: ",-1)),s(I,null,{default:a(()=>[s(z,{to:r.chatLink,target:"_blank"},{default:a(()=>[c("span",null,m(r.chatLink.includes("amo")?"amo":"bluesaless"),1)]),_:2},1032,["to"])]),_:2},1024)]),s(I,{class:"mb-2"},{default:a(()=>[s(z,{to:`${r.preorder.maket}?name=${encodeURIComponent(r.title)}.cdr&dl=true`,target:"_blank"},{default:a(()=>e[7]||(e[7]=[$(" Скачать макет ",-1)])),_:2,__:[7]},1032,["to"])]),_:2},1024),c("div",et," Задание: "+m(r.orders.length?"":0),1),(i(!0),u(A,null,S(r.orders,(g,T)=>(i(),u("div",{key:g.id,class:"w-full"},[s(_e,{type:"single",collapsible:""},{default:a(()=>[s(pe,{value:"item-1"},{default:a(()=>[s(de,{class:"p-0 pl-2 bg-slate-200/60 rounded-t-sm mb-1"},{default:a(()=>[$("Заказ "+m(r.orders.length===1?"":T+1)+" "+m(g.stageId===+l(_)?"":`(${l(b).find(V=>V.id===g.stageId)?.title})`),1)]),_:2},1024),s(me,null,{default:a(()=>[s(ue,{order:g,stages:l(b),workers:l(L),"from-page":"prod",onUpdateOrdersList:()=>ee(F,r.id),onChangeStage:V=>Z(F,T,V.order)},null,8,["order","stages","workers","onUpdateOrdersList","onChangeStage"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]))),128)),e[8]||(e[8]=c("div",{class:"font-semibold"},"Доставка:",-1)),s(fe,{deliveries:r.deliveries},null,8,["deliveries"]),c("div",tt,[s(ye,null,{default:a(()=>[c("div",ot,[s(ve,{class:"font-semibold pl-2 w-full text-left bg-slate-200/60 flex items-center justify-between"},{default:a(()=>[$(" Документы: "+m(r.files.length?"":"Не нужны")+" ",1),s(o,{class:"ml-auto",name:"mingcute:arrows-down-line",size:"18px"})]),_:2},1024)]),s(ge,null,{default:a(()=>[(i(!0),u(A,null,S(r.files,(g,T)=>(i(),u("div",{key:T,class:"flex gap-2 p-2"},[g.type==="documents"?(i(),u("div",{key:0,class:"underline decoration-solid cursor-pointer text-blue-600",onClick:V=>K(`EasyCRM/documents/${g.ya_name}`,g.name)},m(g.name),9,st)):k("",!0)]))),128))]),_:2},1024)]),_:2},1024)])]))),128))]))]),c("div",nt," Всего сделок: "+m(l(x))+" | Страниц: "+m(l(U)),1)])])}}});export{Zt as default};
