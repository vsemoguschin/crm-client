import{_ as te,a as se,b as le}from"./CNLsaPwj.js";import{_ as ae}from"./BCRlC5xu.js";import{_ as oe}from"./fRExJa2e.js";import{_ as ne}from"./CP8umD4q.js";import{_ as re}from"./Da2JRHOT.js";import{_ as X}from"./DkkQ8vn7.js";import{d as z}from"./Cxp-zkhu.js";import{e as J,g as Y,r as b,i as ie,c as f,D as B,o as c,b as a,w as o,a as t,d as U,t as m,l,A as P,F as D,z as T,v as ce,B as G,m as I,H as Q,G as s}from"./LcRD3ia0.js";import{u as de}from"./1Y235EgL.js";import{_ as ue}from"./B5gfxeH_.js";import{v as E,_ as C}from"./D8Osd5Ax.js";import{b as me,_ as pe,a as fe}from"./CACSUplU.js";import{_ as _e}from"./BXoTK-I8.js";import{b as ge,c as xe,d as ve,e as we,_ as he,a as be}from"./Df1Q6CGn.js";import{u as ye,g as ke,a as Ce,b as $e,F as W,A as S}from"./DSl2Rovl.js";import{a as Se}from"./BcyKike4.js";import{a as Ue,b as Ve,c as De,d as Ie,_ as Ne}from"./B-kig6KZ.js";import{_ as Fe}from"./Pvv-dh1L.js";import{_ as Te,a as Me,b as je}from"./DkMjgWCi.js";import{_ as Be}from"./BcuVElyA.js";import{_ as Ae}from"./mqOaxR0N.js";import{_ as Re}from"./Dbg8U1qb.js";const Ke={key:0,class:"h-full"},He={class:""},Pe={class:"flex flex-col"},Le={class:"flex gap-2 mb-2 items-center"},ze={class:"gap-3"},Ge={class:"gap-1 text-gray-600"},Oe={class:"flex items-center justify-between font-semibold"},qe={class:"flex items-center justify-between"},Ee={class:"flex items-center justify-between"},Je={class:"flex items-center justify-between"},Qe={class:"flex items-center justify-between font-semibold"},We={class:"flex flex-col"},Xe={class:"flex justify-between font-semibold pb-2"},Ye={class:"flex flex-col text-gray-600"},Ze={class:"flex"},et={class:"flex justify-between grow mr-1"},tt={class:""},st={class:"flex items-center justify-between grow mr-1 mb-1"},lt={class:""},at={class:""},ot={class:""},nt={class:"gap-1"},rt={class:"flex"},it={class:"flex flex-col justify-between grow mr-1 mb-1"},ct={class:"text-muted-foreground"},dt={class:"text-muted-foreground"},ut={class:"w-full flex flex-col items-center"},Gt=J({__name:"DealCardSheet",props:{deal:{}},setup(e){const{$useApi:V}=Y(),p=e,N=b(0),y=b(0),$=b(0),w=b(0),M=b(0);return ie(()=>{N.value=p.deal.dops?.reduce((d,r)=>d+r.price,0)||0,y.value=p.deal.payments?.reduce((d,r)=>d+r.price,0)||0,$.value=p.deal.price+N.value,w.value=$.value-y.value,M.value=de(p.deal.client.firstContact,p.deal.saleDate)}),(d,r)=>{const _=le,i=ae,F=se,u=re,v=oe,n=X,j=ne,R=te;return d.deal.id!==0?(c(),f("div",Ke,[a(R,{class:"flex flex-col overflow-hidden h-full"},{default:o(()=>[a(F,{class:"flex flex-row items-start bg-slate-50 pb-1"},{default:o(()=>[t("div",He,[a(_,{class:"flex items-center gap-2 text-lg pb-2"},{default:o(()=>[U(m(d.deal.title),1)]),_:1}),a(i,null,{default:o(()=>[t("div",Pe,[t("span",null," Первый контакт: "+m(("dateFormat"in d?d.dateFormat:l(z))(d.deal.client.firstContact)),1),t("span",null," Дата продажи: "+m(("dateFormat"in d?d.dateFormat:l(z))(d.deal.saleDate)),1),t("span",null," Прошло дней: "+m(l(M)),1)]),t("div",Le,[t("span",null,"Статус:"+m(d.deal.status),1)])]),_:1})])]),_:1}),a(n,null,{default:o(()=>[a(v,{class:"p-6 text-sm h-full"},{default:o(()=>[t("div",ze,[r[5]||(r[5]=t("div",{class:"font-semibold pb-2"},"Детали оплаты",-1)),t("ul",Ge,[t("li",Oe,[r[0]||(r[0]=t("span",{class:"text-muted-foreground"}," Сумма заказа ",-1)),t("span",null,m(l($))+"₽ ",1)]),t("li",qe,[r[1]||(r[1]=t("span",{class:"text-muted-foreground"}," Стоимость вывески ",-1)),t("span",null,m(d.deal.price)+"₽ ",1)]),t("li",Ee,[r[2]||(r[2]=t("span",{class:"text-muted-foreground"}," Стоимость доп. услуг ",-1)),t("span",null,m(l(N))+"₽ ",1)]),t("li",Je,[r[3]||(r[3]=t("span",{class:"text-muted-foreground"}," Оплачено ",-1)),t("span",null,m(l(y))+"₽ ",1)]),t("li",Qe,[r[4]||(r[4]=t("span",{class:"text-muted-foreground"}," Остаток ",-1)),t("span",{class:P(l(w)>0?"text-red-600":"text-green-600")},m(l(w))+"₽ ",3)])])]),a(u,{class:"my-2"}),t("div",We,[t("div",Xe,m(d.deal.dealers.length>1?"Менеджеры":"Менеджер"),1),t("div",Ye,[(c(!0),f(D,null,T(d.deal.dealers,g=>(c(),f("ul",{key:g.id,class:"w-full flex-cols items-center mb-2"},[t("li",Ze,[t("div",et,[t("span",null,m(g.user?.fullName||"Nope"),1),t("span",null,m(g.price+"p"),1)])])]))),128))])]),a(u,{class:"my-2"}),t("div",tt,[r[6]||(r[6]=t("div",{class:"flex items-center justify-between"},[t("div",{class:"font-semibold pb-2"},"Платежи")],-1)),(c(!0),f(D,null,T(d.deal.payments,g=>(c(),f("ul",{key:g.id,class:"text-gray-600 flex"},[t("li",st,[t("span",lt,m(g.method),1),t("span",at,m(("dateFormat"in d?d.dateFormat:l(z))(g.date)),1),t("span",ot,m(g.price)+"₽ ",1)])]))),128))]),a(u,{class:"my-2"}),t("div",nt,[r[7]||(r[7]=t("div",{class:"flex items-center justify-between"},[t("div",{class:"font-semibold pb-2"},"Доп. услуги")],-1)),(c(!0),f(D,null,T(d.deal.dops,g=>(c(),f("ul",{key:g.id,class:"text-gray-600 flex flex-col"},[t("div",rt,[t("li",it,[t("span",ct,m(("dateFormat"in d?d.dateFormat:l(z))(g.saleDate)+" - "+g.type),1),t("span",dt,m(g.user.fullName+" - "+g.price+"₽"||""),1)])]),t("div",ut,[a(u,{class:"my-1"})])]))),128))])]),_:1})]),_:1}),a(j)]),_:1})])):B("",!0)}}}),mt={class:"flex mb-2 justify-end gap-2 items-center"},pt={class:"rounded-md border bg-slate-100 overflow-hidden"},Ot=J({__name:"DataTable",props:{columns:{},data:{},currentManagerId:{}},emits:["manager-clicked","table-sorted"],setup(e,{emit:V}){const p=e,N=b([]),y=b([]),$=b({}),w=ye({get data(){return p.data},get columns(){return p.columns},getCoreRowModel:$e(),getSortedRowModel:Ce(),getFilteredRowModel:ke(),onSortingChange:_=>E(_,N),onColumnFiltersChange:_=>E(_,y),onColumnVisibilityChange:_=>E(_,$),state:{get sorting(){return N.value},get columnFilters(){return y.value},get columnVisibility(){return $.value}}}),M=V,d=ce(()=>{const _=Array.from(new Set(p.data.map(u=>u.workSpace).filter(Boolean))).map(u=>({value:u,label:u})),i=Array.from(new Set(p.data.map(u=>u.group).filter(Boolean))).map(u=>({value:u,label:u})),F=Array.from(new Map(p.data.map(u=>[u.id,{value:u.fullName,label:u.fullName}]))).map(([,u])=>u);return{workspaces:_,groups:i,managers:F}}),r=_=>{M("manager-clicked",_)};return G(()=>w.getSortedRowModel().rows,_=>{const i=_.map(F=>F.original.id);M("table-sorted",i)},{deep:!0}),(_,i)=>{const F=ue,u=C,v=pe,n=_e,j=fe,R=me,g=ve,K=be,O=xe,L=he,q=we,A=ge,H=X;return c(),f(D,null,[t("div",mt,[t("div",null,[a(F,{table:l(w),filters:d.value},null,8,["table","filters"])]),t("div",null,[a(R,null,{default:o(()=>[a(v,null,{default:o(()=>[a(u,{variant:"outline",class:"ml-auto"},{default:o(()=>[i[0]||(i[0]=U(" Колонки ",-1)),a(l(Se),{class:"w-4 h-4 ml-2"})]),_:1,__:[0]})]),_:1}),a(j,{class:"w-[180px]"},{default:o(()=>[(c(!0),f(D,null,T(l(w).getAllColumns().filter(x=>x.getCanHide()),x=>(c(),f("div",{key:x.id},[a(n,{checked:x.getIsVisible(),"onUpdate:checked":k=>{x.toggleVisibility(!!k)}},null,8,["checked","onUpdate:checked"]),U(" "+m(x.columnDef.ruName),1)]))),128))]),_:1})]),_:1})])]),t("div",pt,[a(H,{class:"h-[calc(100vh-185px)]"},{default:o(()=>[a(A,{class:"relative"},{default:o(()=>[a(O,{class:"bg-white sticky top-0 z-50"},{default:o(()=>[(c(!0),f(D,null,T(l(w).getHeaderGroups(),x=>(c(),I(K,{key:x.id},{default:o(()=>[(c(!0),f(D,null,T(x.headers,k=>(c(),I(g,{key:k.id},{default:o(()=>[k.isPlaceholder?B("",!0):(c(),I(l(W),{key:0,render:k.column.columnDef.header,props:k.getContext()},null,8,["render","props"]))]),_:2},1024))),128))]),_:2},1024))),128))]),_:1}),a(q,null,{default:o(()=>[l(w).getRowModel().rows?.length?(c(!0),f(D,{key:0},T(l(w).getRowModel().rows,x=>(c(),I(K,{key:x.id,class:P(["cursor-pointer","hover:bg-slate-300",_.currentManagerId===x.original.id?"bg-slate-400/70":""]),"data-state":x.getIsSelected()?"selected":void 0,onClick:k=>r(x.original.id)},{default:o(()=>[(c(!0),f(D,null,T(x.getVisibleCells(),k=>(c(),I(L,{key:k.id},{default:o(()=>[a(l(W),{render:k.column.columnDef.cell,props:k.getContext()},null,8,["render","props"])]),_:2},1024))),128))]),_:2},1032,["class","data-state","onClick"]))),128)):(c(),I(K,{key:1},{default:o(()=>[a(L,{colspan:_.columns.length,class:"text-left"},{default:o(()=>i[1]||(i[1]=[U(" Нет результатов. ",-1)])),_:1,__:[1]},8,["colspan"])]),_:1}))]),_:1})]),_:1})]),_:1})])],64)}}}),ft={key:0,class:"text-red-500 text-sm"},_t={class:"flex flex-col gap-6 mt-2"},gt={class:"relative"},xt={class:"relative"},vt={key:0,class:"relative"},wt={key:1,class:"relative"},ht={key:0},bt={key:1},qt=J({__name:"CorrectCreateModal",props:{userId:{}},emits:["correction-created"],setup(e,{emit:V}){const{$useApi:p}=Y(),N=e,y=b(!1),$=b(null),w=b(!1),M=b(!0),d=["Вычет","Прибавка","Выплата"],r=b(d[0]),_={type:d[0],date:new Date().toISOString().slice(0,10),period:new Date().toISOString().slice(0,7),price:0,description:""},i=b({..._}),F=async()=>{w.value=!0,$.value=null;try{if(r.value==="Выплата"){const{data:n}=await p.post("/salary-pay/",{...i.value,userId:N.userId});console.log("pay set"),y.value=!1,u("correction-created",n);return}const v=await p.post("/salary-pay/correction",{...i.value,userId:N.userId});console.log(v.data),y.value=!1,u("correction-created",v.data)}catch(v){const n=v.response?.data?.message||"Ошибка при создании";$.value=n.message}finally{w.value=!1}},u=V;return G([i],()=>{const{price:v,date:n,period:j}=i.value;M.value=!(v&&n&&j)},{deep:!0}),G(y,v=>{v||(r.value=d[0],i.value={..._},$.value=null)},{deep:!0}),G(r,v=>{if(["Вычет","Прибавка"].includes(v))i.value.type=v;else return}),(v,n)=>{const j=C,R=Ue,g=Ie,K=De,O=je,L=Me,q=Te,A=Be,H=Ae,x=Re,k=Fe,Z=Ve,ee=Ne;return c(),I(ee,{open:l(y),"onUpdate:open":n[5]||(n[5]=h=>Q(y)?y.value=h:null)},{default:o(()=>[a(R,{"as-child":""},{default:o(()=>[a(j,{class:"px-1 h-5"},{default:o(()=>n[6]||(n[6]=[U("Выплаты/Корректировка",-1)])),_:1,__:[6]})]),_:1}),a(Z,{class:"max-w-[350px] flex flex-col"},{default:o(()=>[a(K,null,{default:o(()=>[a(g,null,{default:o(()=>n[7]||(n[7]=[U("Создать",-1)])),_:1,__:[7]})]),_:1}),l($)?(c(),f("div",ft,m(l($)),1)):B("",!0),t("div",_t,[a(q,{modelValue:l(r),"onUpdate:modelValue":n[0]||(n[0]=h=>Q(r)?r.value=h:null),class:"w-full"},{default:o(()=>[a(L,{class:"w-full"},{default:o(()=>[(c(),f(D,null,T(d,h=>a(O,{key:h,value:h,class:"w-full"},{default:o(()=>[U(m(h),1)]),_:2},1032,["value"])),64))]),_:1})]),_:1},8,["modelValue"]),t("div",gt,[a(A,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:o(()=>n[8]||(n[8]=[U(" Сумма ",-1)])),_:1,__:[8]}),a(H,{modelValue:l(i).price,"onUpdate:modelValue":n[1]||(n[1]=h=>l(i).price=h),type:"number",placeholder:"Сумма",class:P(l(i).price?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"])]),t("div",xt,[l(i).period?(c(),I(A,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:o(()=>n[9]||(n[9]=[U(" Период ",-1)])),_:1,__:[9]})):B("",!0),a(H,{modelValue:l(i).period,"onUpdate:modelValue":n[2]||(n[2]=h=>l(i).period=h),type:"month",placeholder:"Период",class:P(l(i).period?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"])]),l(r)!=="Выплата"?(c(),f("div",vt,[l(i).date?(c(),I(A,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:o(()=>n[10]||(n[10]=[U(" Дата вычета ",-1)])),_:1,__:[10]})):B("",!0),a(H,{modelValue:l(i).date,"onUpdate:modelValue":n[3]||(n[3]=h=>l(i).date=h),type:"date",placeholder:"Дата вычета",class:P(l(i).date?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"])])):B("",!0),l(r)!=="Выплата"?(c(),f("div",wt,[a(x,{modelValue:l(i).description,"onUpdate:modelValue":n[4]||(n[4]=h=>l(i).description=h),placeholder:"Комментарий"},null,8,["modelValue"]),l(i).description?(c(),I(A,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:o(()=>n[11]||(n[11]=[U(" Комментарий ",-1)])),_:1,__:[11]})):B("",!0)])):B("",!0)]),a(k,null,{default:o(()=>[a(j,{disabled:l(M)||l(w),onClick:F},{default:o(()=>[l(w)?(c(),f("span",ht,"Сохранение...")):(c(),f("span",bt,"Создать"))]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1},8,["open"])}}}),Et=[{accessorKey:"fullName",ruName:"Менеджер",enableHiding:!1,header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"h-full text-xl"},()=>["Менеджер",s(S,{class:"h-[25px] w-[25px] ml-1"})]),cell:({row:e})=>s("div",{class:"text-left pl-4 whitespace-nowrap flex flex-col items-start"},[s("span",{class:""},`${e.original.fullName} ${e.original.fired?"(Уволен)":""}`),s("span",{class:"text-xs text-gray-600"},e.original.role)])},{accessorKey:"totalSales",ruName:"Общие продажи",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full w-full p-2"},()=>[s("div",{class:"flex items-center text-wrap"},["Общие продажи",s(S,{class:"h-[20px] w-[20px]"})])]),cell:({row:e})=>s("div",{class:"text-center"},e.getValue("totalSales"))},{accessorKey:"dealSales",ruName:"Заказы",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full p-2 w-full"},()=>[s("div",{class:"flex items-center text-wrap"},["Заказы",s(S,{class:"h-[20px] w-[20px]"})])]),cell:({row:e})=>s("div",{class:"text-center"},e.getValue("dealSales"))},{accessorKey:"dopSales",ruName:"Допы",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full w-full p-2"},()=>[s("div",{class:"flex items-center"},["Допы",s(S,{class:"h-[20px] w-[20px]"})])]),cell:({row:e})=>s("div",{class:"text-center"},e.getValue("dopSales"))},{accessorKey:"averageBill",ruName:"Средний чек",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full w-full p-2"},()=>[s("div",{class:"flex items-center text-wrap"},["Средний чек",s(S,{class:"h-[20px] w-[20px]"})])]),cell:({row:e})=>s("div",{class:"text-center"},e.getValue("averageBill"))},{accessorKey:"drr",ruName:"ДРР",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full w-full p-2"},()=>[s("div",{class:"flex items-center text-wrap"},["ДРР",s(S,{class:"h-[20px] w-[20px]"})])]),cell:({row:e})=>s("div",{class:"text-center"},e.getValue("drr")+"%")},{accessorKey:"conversionDealsToCalls",ruName:"% из заявки в продажу",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full p-2 w-full"},()=>[s("div",{class:"flex items-center text-wrap"},["% из заявки в продажу",s(S,{class:"h-[20px] w-[20px]"})])]),cell:({row:e})=>s("div",{class:"text-center"},e.getValue("conversionDealsToCalls")+"%")},{accessorKey:"fact",ruName:"Факт",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full p-2 w-full"},()=>[s("div",{class:"flex items-center text-wrap"},["Факт",s(S,{class:"h-[20px] w-[20px]"})])]),cell:({row:e})=>s("div",{class:"text-center"},e.getValue("fact")+"")},{accessorKey:"workSpace",ruName:"Отдел",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full w-full hidden"},()=>["Отдел",s(S,{class:"ml-2 h-4 w-4"})]),cell:({row:e})=>s("div",{class:"text-center hidden"},e.getValue("workSpace")),filterFn:(e,V,p)=>p.includes(e.getValue(V))},{accessorKey:"group",ruName:"Группа",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full w-full hidden"},()=>["Группа",s(S,{class:"ml-2 h-4 w-4"})]),cell:({row:e})=>s("div",{class:"text-center hidden"},e.getValue("group")),filterFn:(e,V,p)=>p.includes(e.getValue(V))},{accessorKey:"role",ruName:"Роль",header:({column:e})=>s(C,{variant:"ghost",onClick:()=>e.toggleSorting(e.getIsSorted()==="asc"),class:"text-center h-full w-full hidden"},()=>["Роль",s(S,{class:"ml-2 h-4 w-4"})]),cell:({row:e})=>s("div",{class:"text-center hidden"},e.getValue("role")),filterFn:(e,V,p)=>p.includes(e.getValue(V))}];export{Gt as _,Ot as a,qt as b,Et as m};
