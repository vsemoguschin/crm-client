import{_ as j}from"./CaPtdwNj.js";import{a as F,_ as H}from"./CXijBUpz.js";import{v as w,O as I,g as L,P as h,Q as $,R as z,S as W,T as G,B as Q,U as X,r as Y,M as B,V as q,W as J,X as Z,l as b,Y as K,e as k,L as A,f as ee,K as ae,u as te,c as C,a as N,b as O,w as se,t as re,o as P,d as ne}from"./BbheI0mw.js";import{c as ie}from"./BuyaVAog.js";import"./B9M8ggfK.js";import"./Bay1Kywl.js";import"./D0zfKHPR.js";import"./l1eRtAXP.js";import"./BhleEUCu.js";import"./BND4UK_1.js";import"./CaiudRgb.js";import"./ROxBBV8N.js";import"./CDst0A0O.js";import"./cStEOrWd.js";import"./oLxPQbNe.js";import"./D2GZmoDz.js";import"./BHuR11Jx.js";import"./DiZ4QL0M.js";import"./C6vK2VYI.js";import"./D-8t_H8v.js";import"./C30fSUvl.js";import"./CprHmdOe.js";import"./CssJESp-.js";import"./s39mgViW.js";import"./JYeLPbKT.js";import"./CJOOd8Dx.js";import"./_14b2CUj.js";import"./DLLw9AXE.js";import"./C-JUEUN9.js";import"./DAmwS8V7.js";import"./DAy9nm00.js";import"./CHKwxJtM.js";import"./D0d2ZlUf.js";import"./QXfa84Px.js";import"./Sc4DFA1e.js";import"./C5Bd_Bx3.js";import"./BF3m7Vf0.js";import"./DzJc7hp_.js";import"./Bh3bOtDY.js";import"./DVdymwQ5.js";import"./Cxp-zkhu.js";import"./1Y235EgL.js";const oe={trailing:!0};function ce(e,a=25,o={}){if(o={...oe,...o},!Number.isFinite(a))throw new TypeError("Expected `wait` to be a finite number");let c,s,n=[],t,f;const m=(v,r)=>(t=le(e,v,r),t.finally(()=>{if(t=null,o.trailing&&f&&!s){const _=m(v,f);return f=null,_}}),t);return function(...v){return t?(o.trailing&&(f=v),t):new Promise(r=>{const _=!s&&o.leading;clearTimeout(s),s=setTimeout(()=>{s=null;const y=o.leading?c:m(this,v);for(const p of n)p(y);n=[]},a),_?(c=m(this,v),r(c)):n.push(r)})}}async function le(e,a,o){return await e.apply(a,o)}const ue=e=>e==="defer"||e===!1;function de(...e){const a=typeof e[e.length-1]=="string"?e.pop():void 0;fe(e[0],e[1])&&e.unshift(a);let[o,c,s={}]=e;const n=w(()=>I(o));if(typeof n.value!="string")throw new TypeError("[nuxt] [useAsyncData] key must be a string.");if(typeof c!="function")throw new TypeError("[nuxt] [useAsyncData] handler must be a function.");const t=L();s.server??=!0,s.default??=_e,s.getCachedData??=S,s.lazy??=!1,s.immediate??=!0,s.deep??=h.deep,s.dedupe??="cancel",s._functionName,t._asyncData[n.value];const f={cause:"initial",dedupe:s.dedupe};t._asyncData[n.value]?._init||(f.cachedData=s.getCachedData(n.value,t,{cause:"initial"}),t._asyncData[n.value]=M(t,n.value,c,s,f.cachedData));const m=t._asyncData[n.value];m._deps++;const v=()=>t._asyncData[n.value].execute(f),r=s.server!==!1&&t.payload.serverRendered;{let p=function(i){const l=t._asyncData[i];l?._deps&&(l._deps--,l._deps===0&&l?._off())};const u=$();if(u&&r&&s.immediate&&!u.sp&&(u.sp=[]),u&&!u._nuxtOnBeforeMountCbs){u._nuxtOnBeforeMountCbs=[];const i=u._nuxtOnBeforeMountCbs;z(()=>{i.forEach(l=>{l()}),i.splice(0,i.length)}),W(()=>i.splice(0,i.length))}const g=u&&(u._nuxtClientOnly||G(ie,!1));r&&t.isHydrating&&(m.error.value||m.data.value!=null)?(m.pending.value=!1,m.status.value=m.error.value?"error":"success"):u&&(!g&&t.payload.serverRendered&&t.isHydrating||s.lazy)&&s.immediate?u._nuxtOnBeforeMountCbs.push(v):s.immediate&&v();const D=K(),d=Q([n,...s.watch||[]],([i],[l])=>{if((i||l)&&i!==l){const x=t._asyncData[l]?.data.value!==h.value,U=t._asyncDataPromises[l]!==void 0;l&&p(l);const V={cause:"initial",dedupe:s.dedupe};if(!t._asyncData[i]?._init){let E;l&&x?E=t._asyncData[l]?.data.value:(E=s.getCachedData(i,t,{cause:"initial"}),V.cachedData=E),t._asyncData[i]=M(t,i,c,s,E)}t._asyncData[i]._deps++,(s.immediate||x||U)&&t._asyncData[i].execute(V)}else m._execute({cause:"watch",dedupe:s.dedupe})},{flush:"sync"});D&&X(()=>{d(),p(n.value)})}const _={data:R(()=>t._asyncData[n.value]?.data),pending:R(()=>t._asyncData[n.value]?.pending),status:R(()=>t._asyncData[n.value]?.status),error:R(()=>t._asyncData[n.value]?.error),refresh:(...p)=>t._asyncData[n.value].execute(...p),execute:(...p)=>t._asyncData[n.value].execute(...p),clear:()=>T(t,n.value)},y=Promise.resolve(t._asyncDataPromises[n.value]).then(()=>_);return Object.assign(y,_),y}function R(e){return w({get(){return e()?.value},set(a){const o=e();o&&(o.value=a)}})}function fe(e,a){return!(typeof e=="string"||typeof e=="object"&&e!==null||typeof e=="function"&&typeof a=="function")}function T(e,a){a in e.payload.data&&(e.payload.data[a]=void 0),a in e.payload._errors&&(e.payload._errors[a]=h.errorValue),e._asyncData[a]&&(e._asyncData[a].data.value=void 0,e._asyncData[a].error.value=h.errorValue,e._asyncData[a].pending.value=!1,e._asyncData[a].status.value="idle"),a in e._asyncDataPromises&&(e._asyncDataPromises[a]&&(e._asyncDataPromises[a].cancelled=!0),e._asyncDataPromises[a]=void 0)}function me(e,a){const o={};for(const c of a)o[c]=e[c];return o}function M(e,a,o,c,s){e.payload._errors[a]??=h.errorValue;const n=c.getCachedData!==S,t=o,f=c.deep?Y:B,m=s!=null,v=e.hook("app:data:refresh",async _=>{(!_||_.includes(a))&&await r.execute({cause:"refresh:hook"})}),r={data:f(m?s:c.default()),pending:B(!m),error:q(e.payload._errors,a),status:B("idle"),execute:(..._)=>{const[y,p=void 0]=_,u=y&&p===void 0&&typeof y=="object"?y:{};if(e._asyncDataPromises[a]){if(ue(u.dedupe??c.dedupe))return e._asyncDataPromises[a];e._asyncDataPromises[a].cancelled=!0}if(u.cause==="initial"||e.isHydrating){const D="cachedData"in u?u.cachedData:c.getCachedData(a,e,{cause:u.cause??"refresh:manual"});if(D!=null)return e.payload.data[a]=r.data.value=D,r.error.value=h.errorValue,r.status.value="success",Promise.resolve(D)}r.pending.value=!0,r.status.value="pending";const g=new Promise((D,d)=>{try{D(t(e))}catch(i){d(i)}}).then(async D=>{if(g.cancelled)return e._asyncDataPromises[a];let d=D;c.transform&&(d=await c.transform(D)),c.pick&&(d=me(d,c.pick)),e.payload.data[a]=d,r.data.value=d,r.error.value=h.errorValue,r.status.value="success"}).catch(D=>{if(g.cancelled)return e._asyncDataPromises[a];r.error.value=Z(D),r.data.value=b(c.default()),r.status.value="error"}).finally(()=>{g.cancelled||(r.pending.value=!1,delete e._asyncDataPromises[a])});return e._asyncDataPromises[a]=g,e._asyncDataPromises[a]},_execute:ce((..._)=>r.execute(..._),0,{leading:!0}),_default:c.default,_deps:0,_init:!0,_hash:void 0,_off:()=>{v(),e._asyncData[a]?._init&&(e._asyncData[a]._init=!1),n||J(()=>{e._asyncData[a]?._init||(T(e,a),r.execute=()=>Promise.resolve(),r.data.value=h.value)})}};return r}const _e=()=>h.value,S=(e,a,o)=>{if(a.isHydrating)return a.payload.data[e];if(o.cause!=="refresh:manual"&&o.cause!=="refresh:hook")return a.static.data[e]},ve={class:"flex flex-col gap-6 p-6"},De={class:"flex items-center gap-3 text-sm text-muted-foreground"},pe=["title"],ye={class:"w-full max-w-4xl"},he={key:0,class:"rounded-lg border border-border bg-card p-8 text-center text-muted-foreground"},ge={key:1,class:"rounded-lg border border-destructive/40 bg-destructive/10 p-6 text-sm text-destructive"},be={key:2,class:"rounded-lg border border-border bg-card p-6 text-sm text-muted-foreground"},we={key:3,class:"rounded-lg border border-border bg-card p-6 text-sm text-muted-foreground"},Ce={key:4,class:"min-w-[450px] w-[450px]"},fa=k({__name:"index",async setup(e){let a,o;const c=A(),s=ee(),{getDeal:n}=F(),t=w(()=>{const d=c.params.id,i=Array.isArray(d)?d[0]:d,l=Number.parseInt(String(i??""),10);return Number.isFinite(l)&&l>0?l:null}),{data:f,pending:m,error:v,refresh:r}=([a,o]=ae(async()=>de(()=>t.value?`deal:${t.value}`:"deal:invalid",async()=>{if(!t.value)return null;try{return await n(t.value)}catch(d){if(d?.response?.status===404)return null;throw d}},{watch:[t]})),a=await a,o(),a),_=w(()=>f.value?.title?`Сделка ${f.value.title} | Easy CRM`:"Сделка | Easy CRM");te(()=>({title:_.value}));const y=w(()=>t.value===null),p=w(()=>!y.value&&!m.value&&!v.value&&!f.value),u=w(()=>!!v.value),g=async d=>{await r()},D=async()=>{await r(),s.replace("/deals")};return(d,i)=>{const l=j,x=H;return P(),C("div",ve,[N("div",De,[O(l,{to:"/deals",class:"transition-colors hover:text-primary"},{default:se(()=>i[0]||(i[0]=[ne(" ← Назад к сделкам ",-1)])),_:1,__:[0]}),i[1]||(i[1]=N("span",{class:"text-muted-foreground/70"},"/",-1)),N("span",{class:"truncate",title:b(f)?.title||"Сделка"},re(b(f)?.title||"Сделка"),9,pe)]),N("div",ye,[b(m)?(P(),C("div",he," Загрузка сделки... ")):b(u)?(P(),C("div",ge," Не удалось загрузить данные сделки. Попробуйте обновить страницу. ")):b(y)?(P(),C("div",be," Некорректный идентификатор сделки. ")):b(p)?(P(),C("div",we," Сделка не найдена или была удалена. ")):(P(),C("div",Ce,[O(x,{deal:b(f),onDealUpdated:g,onDealDeleted:D},null,8,["deal"])]))])])}}});export{fa as default};
