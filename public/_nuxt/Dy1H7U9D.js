import{_ as Ae}from"./Bmr5wyhr.js";import{_ as Be,a as je,b as ze}from"./DkMjgWCi.js";import{_ as Ee}from"./CY7rJOej.js";import{_ as ae}from"./D8Osd5Ax.js";import{a as oe,b as se,c as ne,d as ue,_ as ie}from"./B-kig6KZ.js";import{_ as de}from"./BqmAL8DW.js";import{_ as re}from"./BcuVElyA.js";import{_ as me,a as _e,b as fe,c as pe,d as ce}from"./AeDsR3BR.js";import{_ as ve}from"./CCJdEHHg.js";import{_ as ge}from"./mqOaxR0N.js";import{e as Ue,g as X,r as w,v as xe,i as we,m as b,o as d,w as t,b as l,a as r,l as o,d as m,k as Ge,D as k,A as F,H,c as g,F as L,z as P,t as M,u as He}from"./LcRD3ia0.js";import{b as Oe,c as Fe,a as We,d as qe,e as Je,_ as Ke}from"./Df1Q6CGn.js";import{_ as Qe,e as Xe}from"./DkkQ8vn7.js";import"./DfRdkKc3.js";import"./D5ydJhlK.js";import"./D9TSNOAg.js";import"./BdQOAs7V.js";import"./BOGtf0gU.js";import"./QkXyQO2w.js";import"./BcyKike4.js";import"./D6LOIvye.js";import"./D8EW8v7U.js";const Ye=["aria-hidden"],Ze={class:"relative"},el={class:"relative"},ll={class:"relative"},tl={class:"relative"},al={class:"relative"},ol=Ue({__name:"CreateModal",props:{group:{}},emits:["user-created"],setup(T,{emit:A}){const{$useApi:C}=X(),B=T,z=A,x=w(!1),p=w([]),n=w({fullName:"",tg:"",email:"",password:"",roleId:0}),a=xe({get:()=>n.value.roleId?String(n.value.roleId):"",set:c=>{n.value.roleId=c?Number(c):0}});we(async()=>{try{const{data:c}=await C.get("/roles");p.value=c||[]}catch(c){console.log(c)}});function h(c){return c==null||String(c).trim()===""||c===0}async function E(){if(h(n.value.fullName)||h(n.value.email)||h(n.value.password)||h(n.value.roleId))return;const s={...n.value,workSpaceId:B.group.workSpaceId,groupId:B.group.id};try{const{data:y}=await C.post("/users",s);y&&(z("user-created",y),x.value=!1,n.value={fullName:"",tg:"",email:"",password:"",roleId:0})}catch(y){console.log(y)}}return(c,s)=>{const y=ae,$=oe,O=ue,W=ne,I=de,R=re,q=fe,J=_e,K=ce,u=ve,e=pe,_=me,v=ge,U=se,S=ie;return d(),b(S,{open:o(x),"onUpdate:open":s[5]||(s[5]=f=>H(x)?x.value=f:null)},{default:t(()=>[l($,{"as-child":""},{default:t(()=>[r("div",{"aria-hidden":o(x)?"false":"true"},[l(y,{class:"h-8 px-2 py-0 text-nowrap"},{default:t(()=>s[6]||(s[6]=[m(" Создать пользователя ",-1)])),_:1,__:[6]})],8,Ye)]),_:1}),l(U,{class:"max-w-[400px] flex flex-col"},{default:t(()=>[l(W,null,{default:t(()=>[l(O,null,{default:t(()=>s[7]||(s[7]=[m("Создать",-1)])),_:1,__:[7]})]),_:1}),l(I,null,{default:t(()=>s[8]||(s[8]=[m(" Заполни форму ",-1)])),_:1,__:[8]}),r("form",{class:"flex flex-col gap-5",onSubmit:Ge(E,["prevent"])},[r("div",Ze,[o(n).roleId?(d(),b(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>s[9]||(s[9]=[m("Роль",-1)])),_:1,__:[9]})):k("",!0),r("div",{class:F(o(n).roleId?"":"outline-1 outline-rose-300 rounded-md")},[l(_,{modelValue:o(a),"onUpdate:modelValue":s[0]||(s[0]=f=>H(a)?a.value=f:null)},{default:t(()=>[l(J,null,{default:t(()=>[l(q,{placeholder:"Выбери роль..."})]),_:1}),l(e,null,{default:t(()=>[(d(!0),g(L,null,P(o(p),f=>(d(),b(u,{key:f.id},{default:t(()=>[l(K,{value:String(f.id)},{default:t(()=>[m(M(f.fullName),1)]),_:2},1032,["value"])]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue"])],2)]),r("div",el,[o(n).fullName?(d(),b(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>s[10]||(s[10]=[m("Имя",-1)])),_:1,__:[10]})):k("",!0),l(v,{modelValue:o(n).fullName,"onUpdate:modelValue":s[1]||(s[1]=f=>o(n).fullName=f),placeholder:"Имя",class:F(o(n).fullName?"":"outline-1 outline-rose-300"),type:"text"},null,8,["modelValue","class"])]),r("div",ll,[o(n).email?(d(),b(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>s[11]||(s[11]=[m("Email (login)",-1)])),_:1,__:[11]})):k("",!0),l(v,{modelValue:o(n).email,"onUpdate:modelValue":s[2]||(s[2]=f=>o(n).email=f),placeholder:"login",class:F(o(n).email?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"])]),r("div",tl,[o(n).password?(d(),b(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>s[12]||(s[12]=[m("Пароль",-1)])),_:1,__:[12]})):k("",!0),l(v,{modelValue:o(n).password,"onUpdate:modelValue":s[3]||(s[3]=f=>o(n).password=f),placeholder:"Пароль",class:F(o(n).password?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"])]),r("div",al,[o(n).tg?(d(),b(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>s[13]||(s[13]=[m("Ссылка на Telegram",-1)])),_:1,__:[13]})):k("",!0),l(v,{modelValue:o(n).tg,"onUpdate:modelValue":s[4]||(s[4]=f=>o(n).tg=f),placeholder:"Telegram",type:"text"},null,8,["modelValue"])]),l(y,{class:"ml-auto",type:"submit"},{default:t(()=>s[14]||(s[14]=[m(" Создать ",-1)])),_:1,__:[14]})],32)]),_:1})]),_:1},8,["open"])}}});function sl(){const{$useApi:T}=X();async function A(){const{data:x}=await T.get("/roles");return x||[]}async function C(x,p){const{data:n}=await T.patch(`/users/${x}`,p);return n}async function B(x,p){const{data:n}=await T.patch(`/users/${x}/new-pass`,{newPass:p});return n}async function z(x,p){const n=new FormData;n.append("file",p);const{data:a}=await T.post(`/users/${x}/avatar`,n,{headers:{"Content-Type":"multipart/form-data"}});return a?.user?.avatarUrl||a?.telegram?.fileUrl||null}return{getRoles:A,updateUserProfile:C,updateUserPassword:B,uploadUserAvatar:z}}const nl={class:"relative h-screen hidden-scrollbar"},ul={class:"w-full fixed z-10"},il={class:"h-[full] flex flex-col p-4 gap-4 mx-[auto] max-w-[2048px] pt-16"},dl={key:0,class:"mt-2 w-full"},rl={class:"flex items-start flex-col w-full"},ml={class:"flex items-center gap-2 w-full"},_l={key:0},fl={class:"flex items-center gap-2"},pl={key:1},cl={key:1},vl={class:"flex items-center gap-4"},gl=["src"],Ul={class:"flex flex-col gap-2"},xl={class:"relative"},wl={class:"flex gap-2"},bl={class:"relative"},yl={class:"flex gap-2"},$l={class:"relative"},Il={class:"flex gap-2"},Nl={class:"relative"},Vl={class:"flex gap-2"},kl={key:0,class:"text-red-500 text-xs -mt-2"},Sl={class:"relative"},Tl={class:"flex gap-2"},Cl={key:1,class:"text-red-500 text-xs -mt-2"},Dl={class:"flex items-center justify-between gap-2 pt-2"},hl={class:"flex gap-2"},tt=Ue({__name:"index",setup(T){const{$useApi:A}=X(),{getRoles:C,updateUserProfile:B,updateUserPassword:z,uploadUserAvatar:x}=sl();He({title:"Отделы | Easy CRM"});const p=w([]),n=w(0),a=w({id:0,password:"",fullName:"",tg:"",tg_id:0,avatarUrl:null,roleId:null}),D=w([]),h=w(null),E=xe({get:()=>a.value.roleId?String(a.value.roleId):"",set:u=>a.value.roleId=u?Number(u):null}),c=w(null),s=w(null),y=w(!1),$=w(null),O=w(!1),W=async()=>{const{data:u}=await A.get("/dashboards/workspaces");p.value=u,n.value===0&&p.value.length&&(n.value=p.value[0].id)},I=w(!1),R=async u=>{try{await A.delete(`/users/${u.id}`);const e=p.value.find(_=>_.groups?.some(v=>v.users?.some(U=>U.id===u.id)));if(e)for(const _ of e.groups)_.users=_.users.filter(v=>v.id!==u.id);I.value=!1}catch(e){console.log(e)}},q=async()=>{try{if(y.value=!0,$.value=null,c.value){const e=await x(a.value.id,c.value);if(e){a.value.avatarUrl=e;for(const _ of p.value)for(const v of _.groups){const U=v.users.findIndex(S=>S.id===a.value.id);U!==-1&&(v.users[U].avatarUrl=e,v.users[U].avatar=e)}}}const u={fullName:a.value.fullName,tg:a.value.tg};a.value.tg_id!==null&&!Number.isNaN(Number(a.value.tg_id))&&(u.tg_id=Number(a.value.tg_id)),a.value.roleId!==null&&a.value.roleId!==void 0&&(u.roleId=Number(a.value.roleId)),await B(a.value.id,u);for(const e of p.value)for(const _ of e.groups){const v=_.users.findIndex(U=>U.id===a.value.id);if(v!==-1){const U=_.users[v];if("fullName"in u&&(U.fullName=u.fullName),"tg"in u&&(U.tg=u.tg),"tg_id"in u&&(U.tg_id=u.tg_id),"roleId"in u){const S=D.value.find(f=>f.id===Number(u.roleId));S&&(U.role=S)}}}if(h.value=a.value.roleId??null,a.value.password){if(a.value.password.length<6){console.error("Пароль должен содержать минимум 6 символов");return}await z(a.value.id,a.value.password)}a.value.password="",c.value=null,s.value&&(URL.revokeObjectURL(s.value),s.value=null),I.value=!1,console.log("Данные пользователя обновлены")}catch(u){console.error("Ошибка обновления пользователя:",u),$.value=u?.response?.data?.message||"Не удалось загрузить фото"}finally{y.value=!1}},J=u=>{const e=u.target,_=e.files?.[0]||null;if($.value=null,_){if(!["image/jpeg","image/png","image/webp"].includes(_.type)){$.value="Разрешены JPG, PNG, WebP",e.value="";return}if(_.size>5*1024*1024){$.value="Размер файла не должен превышать 5MB",e.value="";return}}c.value=_||null,s.value&&(URL.revokeObjectURL(s.value),s.value=null),_&&(s.value=URL.createObjectURL(_))},K=u=>{I.value=!0,a.value.id=u.id,a.value.fullName=u.fullName,a.value.password="",a.value.tg=u.tg??"",a.value.tg_id=typeof u.tg_id=="number"?u.tg_id:u.tg??null,a.value.avatarUrl=u.avatarUrl??u.avatar??null,a.value.roleId=u.role?.id??null,h.value=a.value.roleId??null,c.value=null,s.value&&(URL.revokeObjectURL(s.value),s.value=null),D.value.length||C().then(e=>D.value=e).catch(console.log)};return we(()=>{W(),C().then(u=>D.value=u).catch(console.log)}),(u,e)=>{const _=Ae,v=ze,U=je,S=ol,f=qe,Y=We,be=Fe,Z=Xe,ee=Ke,ye=Je,$e=Oe,Ie=Qe,le=Ee,te=Be,Ne=oe,Ve=ue,ke=ne,Se=de,j=re,G=ge,Te=fe,Ce=_e,De=ce,he=ve,Re=pe,Le=me,Q=ae,Pe=se,Me=ie;return d(),g("div",nl,[r("div",ul,[l(_)]),r("div",il,[e[12]||(e[12]=r("h1",{class:"text-3xl font-semibold"},"Пользователи",-1)),o(p)&&o(n)?(d(),g("div",dl,[l(te,{modelValue:o(n),"onUpdate:modelValue":e[0]||(e[0]=i=>H(n)?n.value=i:null)},{default:t(()=>[r("div",rl,[r("div",ml,[o(p).length>1?(d(),b(U,{key:0},{default:t(()=>[(d(!0),g(L,null,P(o(p),i=>(d(),g("div",{key:i.id},[l(v,{value:i.id},{default:t(()=>[m(M(i.title),1)]),_:2},1032,["value"])]))),128))]),_:1})):k("",!0)]),(d(!0),g(L,null,P(o(p),i=>(d(),g("div",{key:i.id,class:"w-full"},[l(le,{value:i.id},{default:t(()=>[i.groups.length?(d(),g("div",_l,[l(te,{"default-value":i.groups[0].id},{default:t(()=>[r("div",fl,[i.groups.length>1?(d(),b(U,{key:0},{default:t(()=>[(d(!0),g(L,null,P(i.groups,N=>(d(),g("div",{key:N.id},[l(v,{value:N.id},{default:t(()=>[m(M(N.title),1)]),_:2},1032,["value"])]))),128))]),_:2},1024)):k("",!0)]),(d(!0),g(L,null,P(i.groups,N=>(d(),g("div",{key:N.id,class:"min-w-[fit-content]"},[l(le,{value:N.id},{default:t(()=>[l(S,{group:N,onUserCreated:V=>N.users.push(V)},null,8,["group","onUserCreated"]),l(Ie,{class:"h-[calc(100vh-270px)] mt-3"},{default:t(()=>[l($e,{class:"max-w-[720px] bg-slate-50"},{default:t(()=>[l(be,null,{default:t(()=>[l(Y,null,{default:t(()=>[l(f,{class:"w-[64px] pl-2"},{default:t(()=>e[10]||(e[10]=[m("Имя ",-1)])),_:1,__:[10]}),l(f,{class:"text-center"},{default:t(()=>e[11]||(e[11]=[m("Telegram",-1)])),_:1,__:[11]})]),_:1})]),_:1}),l(ye,null,{default:t(()=>[(d(!0),g(L,null,P(N.users,V=>(d(),b(Y,{key:V.id,class:"cursor-pointer hover:bg-muted/50",onClick:Rl=>K(V)},{default:t(()=>[l(ee,{class:"py-2"},{default:t(()=>[l(Z,{"full-name":V.fullName,"role-name":V.role?.fullName,hover:!1,"avatar-url":V.avatarUrl,size:"lg"},null,8,["full-name","role-name","avatar-url"])]),_:2},1024),l(ee,{class:"text-center"},{default:t(()=>[m(M(V.tg??V.tg_id??"—"),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"])]))),128))]),_:2},1032,["default-value"])])):(d(),g("div",pl))]),_:2},1032,["value"])]))),128))])]),_:1},8,["modelValue"])])):(d(),g("div",cl,"Загрузка"))]),l(Me,{open:o(I),"onUpdate:open":e[9]||(e[9]=i=>H(I)?I.value=i:null)},{default:t(()=>[l(Ne),l(Pe,{class:"max-w-[420px] flex flex-col gap-4"},{default:t(()=>[l(ke,null,{default:t(()=>[l(Ve,null,{default:t(()=>e[13]||(e[13]=[m("Редактировать профиль",-1)])),_:1,__:[13]})]),_:1}),l(Se,{class:"text-base font-medium"},{default:t(()=>[m(M(o(a).fullName),1)]),_:1}),r("div",vl,[o(s)?(d(),g("img",{key:1,src:o(s),alt:"avatar",class:"size-16 rounded-full object-cover border"},null,8,gl)):(d(),b(Z,{key:0,"full-name":o(a).fullName,hover:!0,"avatar-url":o(a).avatarUrl,size:"lg"},null,8,["full-name","avatar-url"])),r("div",Ul,[l(j,{class:"text-sm"},{default:t(()=>e[14]||(e[14]=[m("Загрузить аватар",-1)])),_:1,__:[14]}),l(G,{type:"file",accept:"image/*",onChange:J}),e[15]||(e[15]=r("span",{class:"text-xs text-muted-foreground"}," JPG / PNG / WebP, до ~5MB ",-1))])]),r("div",xl,[l(j,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>e[16]||(e[16]=[m("Имя",-1)])),_:1,__:[16]}),r("div",wl,[l(G,{modelValue:o(a).fullName,"onUpdate:modelValue":e[1]||(e[1]=i=>o(a).fullName=i),placeholder:"Имя"},null,8,["modelValue"])])]),r("div",bl,[l(j,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>e[17]||(e[17]=[m("Роль",-1)])),_:1,__:[17]}),r("div",yl,[l(Le,{modelValue:o(E),"onUpdate:modelValue":e[2]||(e[2]=i=>H(E)?E.value=i:null)},{default:t(()=>[l(Ce,null,{default:t(()=>[l(Te,{placeholder:"Выберите роль"})]),_:1}),l(Re,null,{default:t(()=>[(d(!0),g(L,null,P(o(D),i=>(d(),b(he,{key:i.id},{default:t(()=>[l(De,{value:String(i.id)},{default:t(()=>[m(M(i.fullName),1)]),_:2},1032,["value"])]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue"])])]),r("div",$l,[l(j,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>e[18]||(e[18]=[m("Telegram",-1)])),_:1,__:[18]}),r("div",Il,[l(G,{modelValue:o(a).tg,"onUpdate:modelValue":e[3]||(e[3]=i=>o(a).tg=i),placeholder:"@username или ссылка"},null,8,["modelValue"])])]),r("div",Nl,[l(j,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>e[19]||(e[19]=[m("Новый пароль",-1)])),_:1,__:[19]}),r("div",Vl,[l(G,{modelValue:o(a).password,"onUpdate:modelValue":e[4]||(e[4]=i=>o(a).password=i),onInput:e[5]||(e[5]=i=>O.value=!0)},null,8,["modelValue"])])]),o(O)&&o(a).password&&o(a).password.length<6?(d(),g("p",kl," Пароль должен содержать минимум 6 символов ")):k("",!0),r("div",Sl,[l(j,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>e[20]||(e[20]=[m("Telegram ID",-1)])),_:1,__:[20]}),r("div",Tl,[l(G,{modelValue:o(a).tg_id,"onUpdate:modelValue":e[6]||(e[6]=i=>o(a).tg_id=i),modelModifiers:{number:!0},type:"number",inputmode:"numeric",placeholder:"Напр., 123456789"},null,8,["modelValue"])])]),o($)?(d(),g("p",Cl,M(o($)),1)):k("",!0),r("div",Dl,[l(Q,{variant:"destructive",onClick:e[7]||(e[7]=i=>R({id:o(a).id}))},{default:t(()=>e[21]||(e[21]=[m(" Удалить ",-1)])),_:1,__:[21]}),r("div",hl,[l(Q,{variant:"secondary",onClick:e[8]||(e[8]=i=>I.value=!1)},{default:t(()=>e[22]||(e[22]=[m(" Отмена ",-1)])),_:1,__:[22]}),l(Q,{onClick:q},{default:t(()=>e[23]||(e[23]=[m("Сохранить",-1)])),_:1,__:[23]})])])]),_:1})]),_:1},8,["open"])])}}});export{tt as default};
