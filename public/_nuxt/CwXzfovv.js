import{_ as Ie}from"./Bye7C16d.js";import{_ as Ve,a as ke,b as Ne}from"./BF3m7Vf0.js";import{_ as Te}from"./C8Hj2bae.js";import{_ as te}from"./CDst0A0O.js";import{a as ae,b as oe,c as se,d as ne,_ as ie}from"./cStEOrWd.js";import{_ as ue}from"./BHuR11Jx.js";import{_ as re}from"./C30fSUvl.js";import{_ as Ce,a as Se,b as De,c as he,d as Re}from"./JYeLPbKT.js";import{_ as Le}from"./DLLw9AXE.js";import{_ as de}from"./CprHmdOe.js";import{e as me,g as X,r as y,v as fe,i as _e,m as $,o as u,w as a,b as l,a as r,l as o,d as f,k as Pe,D as T,A as F,H as G,c as v,F as B,z as M,t as j,u as Ae}from"./BbheI0mw.js";import{b as Be,c as Me,a as je,d as ze,e as Ee,_ as He}from"./C6vK2VYI.js";import{_ as Oe}from"./BR3DQNok.js";import{_ as Fe}from"./DVdymwQ5.js";import"./D0Fd2yXn.js";import"./B9M8ggfK.js";import"./oLxPQbNe.js";import"./D2GZmoDz.js";import"./CaPtdwNj.js";import"./KSX9JOtw.js";import"./ZTyVILcU.js";import"./s39mgViW.js";import"./CJOOd8Dx.js";import"./odSmgr3d.js";import"./DzJc7hp_.js";import"./CCknexPU.js";import"./_14b2CUj.js";import"./CssJESp-.js";const Ge=["aria-hidden"],We={class:"relative"},qe={class:"relative"},Je={class:"relative"},Ke={class:"relative"},Qe={class:"relative"},Xe=me({__name:"CreateModal",props:{group:{}},emits:["user-created"],setup(C,{emit:L}){const{$useApi:S}=X(),P=C,z=L,U=y(!1),c=y([]),s=y({fullName:"",tg:"",email:"",password:"",roleId:0}),t=fe({get:()=>s.value.roleId?String(s.value.roleId):"",set:d=>{s.value.roleId=d?Number(d):0}});_e(async()=>{try{const{data:d}=await S.get("/roles");c.value=d||[]}catch(d){console.log(d)}});function D(d){return d==null||String(d).trim()===""||d===0}async function h(){if(D(s.value.fullName)||D(s.value.email)||D(s.value.password)||D(s.value.roleId))return;const i={...s.value,workSpaceId:P.group.workSpaceId,groupId:P.group.id};try{const{data:x}=await S.post("/users",i);x&&(z("user-created",x),U.value=!1,s.value={fullName:"",tg:"",email:"",password:"",roleId:0})}catch(x){console.log(x)}}return(d,i)=>{const x=te,O=ae,W=ne,I=se,q=ue,R=re,J=De,K=Se,n=Re,e=Le,_=he,w=Ce,g=de,b=oe,V=ie;return u(),$(V,{open:o(U),"onUpdate:open":i[5]||(i[5]=p=>G(U)?U.value=p:null)},{default:a(()=>[l(O,{"as-child":""},{default:a(()=>[r("div",{"aria-hidden":o(U)?"false":"true"},[l(x,{class:"h-8 px-2 py-0 text-nowrap"},{default:a(()=>i[6]||(i[6]=[f(" Создать пользователя ",-1)])),_:1,__:[6]})],8,Ge)]),_:1}),l(b,{class:"max-w-[400px] flex flex-col"},{default:a(()=>[l(I,null,{default:a(()=>[l(W,null,{default:a(()=>i[7]||(i[7]=[f("Создать",-1)])),_:1,__:[7]})]),_:1}),l(q,null,{default:a(()=>i[8]||(i[8]=[f(" Заполни форму ",-1)])),_:1,__:[8]}),r("form",{class:"flex flex-col gap-5",onSubmit:Pe(h,["prevent"])},[r("div",We,[o(s).roleId?(u(),$(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:a(()=>i[9]||(i[9]=[f("Роль",-1)])),_:1,__:[9]})):T("",!0),r("div",{class:F(o(s).roleId?"":"outline-1 outline-rose-300 rounded-md")},[l(w,{modelValue:o(t),"onUpdate:modelValue":i[0]||(i[0]=p=>G(t)?t.value=p:null)},{default:a(()=>[l(K,null,{default:a(()=>[l(J,{placeholder:"Выбери роль..."})]),_:1}),l(_,null,{default:a(()=>[(u(!0),v(B,null,M(o(c),p=>(u(),$(e,{key:p.id},{default:a(()=>[l(n,{value:String(p.id)},{default:a(()=>[f(j(p.fullName),1)]),_:2},1032,["value"])]),_:2},1024))),128))]),_:1})]),_:1},8,["modelValue"])],2)]),r("div",qe,[o(s).fullName?(u(),$(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:a(()=>i[10]||(i[10]=[f("Имя",-1)])),_:1,__:[10]})):T("",!0),l(g,{modelValue:o(s).fullName,"onUpdate:modelValue":i[1]||(i[1]=p=>o(s).fullName=p),placeholder:"Имя",class:F(o(s).fullName?"":"outline-1 outline-rose-300"),type:"text"},null,8,["modelValue","class"])]),r("div",Je,[o(s).email?(u(),$(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:a(()=>i[11]||(i[11]=[f("Email (login)",-1)])),_:1,__:[11]})):T("",!0),l(g,{modelValue:o(s).email,"onUpdate:modelValue":i[2]||(i[2]=p=>o(s).email=p),placeholder:"login",class:F(o(s).email?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"])]),r("div",Ke,[o(s).password?(u(),$(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:a(()=>i[12]||(i[12]=[f("Пароль",-1)])),_:1,__:[12]})):T("",!0),l(g,{modelValue:o(s).password,"onUpdate:modelValue":i[3]||(i[3]=p=>o(s).password=p),placeholder:"Пароль",class:F(o(s).password?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"])]),r("div",Qe,[o(s).tg?(u(),$(R,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:a(()=>i[13]||(i[13]=[f("Ссылка на Telegram",-1)])),_:1,__:[13]})):T("",!0),l(g,{modelValue:o(s).tg,"onUpdate:modelValue":i[4]||(i[4]=p=>o(s).tg=p),placeholder:"Telegram",type:"text"},null,8,["modelValue"])]),l(x,{class:"ml-auto",type:"submit"},{default:a(()=>i[14]||(i[14]=[f(" Создать ",-1)])),_:1,__:[14]})],32)]),_:1})]),_:1},8,["open"])}}});function Ye(){const{$useApi:C}=X();async function L(){const{data:U}=await C.get("/roles");return U||[]}async function S(U,c){const{data:s}=await C.patch(`/users/${U}`,c);return s}async function P(U,c){const{data:s}=await C.patch(`/users/${U}/new-pass`,{newPass:c});return s}async function z(U,c){const s=new FormData;s.append("file",c);const{data:t}=await C.post(`/users/${U}/avatar`,s,{headers:{"Content-Type":"multipart/form-data"}});return t?.user?.avatarUrl||t?.telegram?.fileUrl||null}return{getRoles:L,updateUserProfile:S,updateUserPassword:P,uploadUserAvatar:z}}const Ze={class:"relative h-screen hidden-scrollbar"},el={class:"w-full fixed z-10"},ll={class:"h-[full] flex flex-col p-4 gap-4 mx-[auto] max-w-[2048px] pt-16"},tl={key:0,class:"mt-2 w-full"},al={class:"flex items-start flex-col w-full"},ol={class:"flex items-center gap-2 w-full"},sl={key:0},nl={class:"flex items-center gap-2"},il={key:1},ul={key:1},rl={class:"flex items-center gap-4"},dl=["src"],ml={class:"flex flex-col gap-2"},fl={class:"relative"},_l={class:"flex gap-2"},pl={class:"relative"},cl={class:"flex gap-2"},vl={class:"relative"},gl={class:"flex gap-2"},Ul={key:0,class:"text-red-500 text-xs -mt-2"},xl={class:"relative"},wl={class:"flex gap-2"},bl={key:1,class:"text-red-500 text-xs -mt-2"},yl={class:"flex items-center justify-between gap-2 pt-2"},$l={class:"flex gap-2"},Zl=me({__name:"index",setup(C){const{$useApi:L}=X(),{getRoles:S,updateUserProfile:P,updateUserPassword:z,uploadUserAvatar:U}=Ye();Ae({title:"Отделы | Easy CRM"});const c=y([]),s=y(0),t=y({id:0,password:"",fullName:"",tg:"",tg_id:"",avatarUrl:null,roleId:null}),A=y([]),D=y(null);fe({get:()=>t.value.roleId?String(t.value.roleId):"",set:n=>t.value.roleId=n?Number(n):null});const h=y(null),d=y(null),i=y(!1),x=y(null),O=y(!1),W=async()=>{const{data:n}=await L.get("/dashboards/workspaces");c.value=n,s.value===0&&c.value.length&&(s.value=c.value[0].id)},I=y(!1),q=async n=>{try{await L.delete(`/users/${n.id}`);const e=c.value.find(_=>_.groups?.some(w=>w.users?.some(g=>g.id===n.id)));if(e)for(const _ of e.groups)_.users=_.users.filter(w=>w.id!==n.id);I.value=!1}catch(e){console.log(e)}},R=async()=>{try{if(i.value=!0,x.value=null,h.value){const _=await U(t.value.id,h.value);if(_){t.value.avatarUrl=_;for(const w of c.value)for(const g of w.groups){const b=g.users.findIndex(V=>V.id===t.value.id);b!==-1&&(g.users[b].avatarUrl=_,g.users[b].avatar=_)}}}const n={fullName:t.value.fullName,tg:t.value.tg},e=t.value.tg_id.trim();n.tg_id=e||"",t.value.tg_id=e,t.value.roleId!==null&&t.value.roleId!==void 0&&(n.roleId=Number(t.value.roleId)),await P(t.value.id,n);for(const _ of c.value)for(const w of _.groups){const g=w.users.findIndex(b=>b.id===t.value.id);if(g!==-1){const b=w.users[g];if("fullName"in n&&(b.fullName=n.fullName),"tg"in n&&(b.tg=n.tg),"tg_id"in n&&(b.tg_id=n.tg_id??""),"roleId"in n){const V=A.value.find(p=>p.id===Number(n.roleId));V&&(b.role=V)}}}if(D.value=t.value.roleId??null,t.value.password){if(t.value.password.length<6){console.error("Пароль должен содержать минимум 6 символов");return}await z(t.value.id,t.value.password)}t.value.password="",h.value=null,d.value&&(URL.revokeObjectURL(d.value),d.value=null),I.value=!1,console.log("Данные пользователя обновлены")}catch(n){console.error("Ошибка обновления пользователя:",n),x.value=n?.response?.data?.message||"Не удалось загрузить фото"}finally{i.value=!1}},J=n=>{const e=n.target,_=e.files?.[0]||null;if(x.value=null,_){if(!["image/jpeg","image/png","image/webp"].includes(_.type)){x.value="Разрешены JPG, PNG, WebP",e.value="";return}if(_.size>5*1024*1024){x.value="Размер файла не должен превышать 5MB",e.value="";return}}h.value=_||null,d.value&&(URL.revokeObjectURL(d.value),d.value=null),_&&(d.value=URL.createObjectURL(_))},K=n=>{I.value=!0,t.value.id=n.id,t.value.fullName=n.fullName,t.value.password="",t.value.tg=n.tg??"";const e=n.tg_id;e!=null&&e!==""?t.value.tg_id=String(e):t.value.tg_id=n.tg?String(n.tg):"",t.value.avatarUrl=n.avatarUrl??n.avatar??null,t.value.roleId=n.role?.id??null,D.value=t.value.roleId??null,h.value=null,d.value&&(URL.revokeObjectURL(d.value),d.value=null),A.value.length||S().then(_=>A.value=_).catch(console.log)};return _e(()=>{W(),S().then(n=>A.value=n).catch(console.log)}),(n,e)=>{const _=Ie,w=Ne,g=ke,b=Xe,V=ze,p=je,pe=Me,Y=Oe,Z=He,ce=Ee,ve=Be,ge=Fe,ee=Te,le=Ve,Ue=ae,xe=ne,we=se,be=ue,E=re,H=de,Q=te,ye=oe,$e=ie;return u(),v("div",Ze,[r("div",el,[l(_)]),r("div",ll,[e[11]||(e[11]=r("h1",{class:"text-3xl font-semibold"},"Пользователи",-1)),o(c)&&o(s)?(u(),v("div",tl,[l(le,{modelValue:o(s),"onUpdate:modelValue":e[0]||(e[0]=m=>G(s)?s.value=m:null)},{default:a(()=>[r("div",al,[r("div",ol,[o(c).length>1?(u(),$(g,{key:0},{default:a(()=>[(u(!0),v(B,null,M(o(c),m=>(u(),v("div",{key:m.id},[l(w,{value:m.id},{default:a(()=>[f(j(m.title),1)]),_:2},1032,["value"])]))),128))]),_:1})):T("",!0)]),(u(!0),v(B,null,M(o(c),m=>(u(),v("div",{key:m.id,class:"w-full"},[l(ee,{value:m.id},{default:a(()=>[m.groups.length?(u(),v("div",sl,[l(le,{"default-value":m.groups[0].id},{default:a(()=>[r("div",nl,[m.groups.length>1?(u(),$(g,{key:0},{default:a(()=>[(u(!0),v(B,null,M(m.groups,k=>(u(),v("div",{key:k.id},[l(w,{value:k.id},{default:a(()=>[f(j(k.title),1)]),_:2},1032,["value"])]))),128))]),_:2},1024)):T("",!0)]),(u(!0),v(B,null,M(m.groups,k=>(u(),v("div",{key:k.id,class:"min-w-[fit-content]"},[l(ee,{value:k.id},{default:a(()=>[l(b,{group:k,onUserCreated:N=>k.users.push(N)},null,8,["group","onUserCreated"]),l(ge,{class:"h-[calc(100vh-270px)] mt-3"},{default:a(()=>[l(ve,{class:"max-w-[720px] bg-slate-50"},{default:a(()=>[l(pe,null,{default:a(()=>[l(p,null,{default:a(()=>[l(V,{class:"w-[64px] pl-2"},{default:a(()=>e[9]||(e[9]=[f("Имя ",-1)])),_:1,__:[9]}),l(V,{class:"text-center"},{default:a(()=>e[10]||(e[10]=[f("Telegram",-1)])),_:1,__:[10]})]),_:1})]),_:1}),l(ce,null,{default:a(()=>[(u(!0),v(B,null,M(k.users,N=>(u(),$(p,{key:N.id,class:"cursor-pointer hover:bg-muted/50",onClick:Il=>K(N)},{default:a(()=>[l(Z,{class:"py-2"},{default:a(()=>[l(Y,{"full-name":N.fullName,"role-name":N.role?.fullName,hover:!1,"avatar-url":N.avatarUrl,size:"lg"},null,8,["full-name","role-name","avatar-url"])]),_:2},1024),l(Z,{class:"text-center"},{default:a(()=>[f(j(N.tg??N.tg_id??"—"),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["value"])]))),128))]),_:2},1032,["default-value"])])):(u(),v("div",il))]),_:2},1032,["value"])]))),128))])]),_:1},8,["modelValue"])])):(u(),v("div",ul,"Загрузка"))]),l($e,{open:o(I),"onUpdate:open":e[8]||(e[8]=m=>G(I)?I.value=m:null)},{default:a(()=>[l(Ue),l(ye,{class:"max-w-[420px] flex flex-col gap-4"},{default:a(()=>[l(we,null,{default:a(()=>[l(xe,null,{default:a(()=>e[12]||(e[12]=[f("Редактировать профиль",-1)])),_:1,__:[12]})]),_:1}),l(be,{class:"text-base font-medium"},{default:a(()=>[f(j(o(t).fullName),1)]),_:1}),r("div",rl,[o(d)?(u(),v("img",{key:1,src:o(d),alt:"avatar",class:"size-16 rounded-full object-cover border"},null,8,dl)):(u(),$(Y,{key:0,"full-name":o(t).fullName,hover:!0,"avatar-url":o(t).avatarUrl,size:"lg"},null,8,["full-name","avatar-url"])),r("div",ml,[l(E,{class:"text-sm"},{default:a(()=>e[13]||(e[13]=[f("Загрузить аватар",-1)])),_:1,__:[13]}),l(H,{type:"file",accept:"image/*",onChange:J}),e[14]||(e[14]=r("span",{class:"text-xs text-muted-foreground"}," JPG / PNG / WebP, до ~5MB ",-1))])]),r("div",fl,[l(E,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:a(()=>e[15]||(e[15]=[f("Имя",-1)])),_:1,__:[15]}),r("div",_l,[l(H,{modelValue:o(t).fullName,"onUpdate:modelValue":e[1]||(e[1]=m=>o(t).fullName=m),placeholder:"Имя"},null,8,["modelValue"])])]),r("div",pl,[l(E,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:a(()=>e[16]||(e[16]=[f("Telegram",-1)])),_:1,__:[16]}),r("div",cl,[l(H,{modelValue:o(t).tg,"onUpdate:modelValue":e[2]||(e[2]=m=>o(t).tg=m),placeholder:"@username или ссылка"},null,8,["modelValue"])])]),r("div",vl,[l(E,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:a(()=>e[17]||(e[17]=[f("Новый пароль",-1)])),_:1,__:[17]}),r("div",gl,[l(H,{modelValue:o(t).password,"onUpdate:modelValue":e[3]||(e[3]=m=>o(t).password=m),onInput:e[4]||(e[4]=m=>O.value=!0)},null,8,["modelValue"])])]),o(O)&&o(t).password&&o(t).password.length<6?(u(),v("p",Ul," Пароль должен содержать минимум 6 символов ")):T("",!0),r("div",xl,[l(E,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:a(()=>e[18]||(e[18]=[f("Telegram ID",-1)])),_:1,__:[18]}),r("div",wl,[l(H,{modelValue:o(t).tg_id,"onUpdate:modelValue":e[5]||(e[5]=m=>o(t).tg_id=m),inputmode:"numeric",placeholder:"Напр., 123456789"},null,8,["modelValue"])])]),o(x)?(u(),v("p",bl,j(o(x)),1)):T("",!0),r("div",yl,[l(Q,{variant:"destructive",onClick:e[6]||(e[6]=m=>q({id:o(t).id}))},{default:a(()=>e[19]||(e[19]=[f(" Удалить ",-1)])),_:1,__:[19]}),r("div",$l,[l(Q,{variant:"secondary",onClick:e[7]||(e[7]=m=>I.value=!1)},{default:a(()=>e[20]||(e[20]=[f(" Отмена ",-1)])),_:1,__:[20]}),l(Q,{onClick:R},{default:a(()=>e[21]||(e[21]=[f("Сохранить",-1)])),_:1,__:[21]})])])]),_:1})]),_:1},8,["open"])])}}});export{Zl as default};
