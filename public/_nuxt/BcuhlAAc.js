import{_ as Qe,a as Ye,b as Ze,c as et,d as tt}from"./JYeLPbKT.js";import{_ as mt}from"./CHKwxJtM.js";import{_ as go}from"./CVX95dZ7.js";import{_ as ke,c as yo}from"./CDst0A0O.js";import{_ as xo}from"./D0zfKHPR.js";import{_ as ho,a as bo}from"./l1eRtAXP.js";import{_ as Co}from"./BND4UK_1.js";import{_ as wo}from"./CaiudRgb.js";import{_ as nt,a as st,b as lt}from"./BF3m7Vf0.js";import{_ as Et}from"./C8Hj2bae.js";import{_ as ze}from"./CprHmdOe.js";import{_ as ft,a as ko}from"./DVdymwQ5.js";import{_ as Me,a as vt,b as Ve,c as Fe,d as Ee}from"./cStEOrWd.js";import{_ as Re}from"./BHuR11Jx.js";import{_ as Ne}from"./C30fSUvl.js";import{_ as rt}from"./QXfa84Px.js";import{_ as it}from"./C5Bd_Bx3.js";import{e as he,g as ot,h as Po,v as te,r as C,B as le,i as Ge,m as A,o as s,l as o,H as Ce,w as t,D as H,b as e,d as p,a as n,t as B,c as I,A as we,bg as se,S as Rt,F as ee,z as re,W as _t,$ as Lt,n as At,x as Bt,T as jt,C as Io,k as Se,ar as $o,y as Uo,ap as To,G as ce,u as Oo}from"./BbheI0mw.js";import{_ as Do}from"./DLLw9AXE.js";import{b as gt,_ as yt,a as xt}from"./DAmwS8V7.js";import{_ as ht,a as bt,b as Ct,c as wt,d as kt,e as Pt}from"./DAy9nm00.js";import{_ as It,C as zt}from"./DFFUo3JN.js";import{C as So}from"./CJOOd8Dx.js";import{_ as Nt}from"./BWn7SjA7.js";import{_ as Mo,a as Vo,d as Fo,b as Eo,c as Ro}from"./KSX9JOtw.js";import{S as Lo,c as Gt,aD as Ao,O as Bo,aE as jo,v as Dt}from"./B9M8ggfK.js";import{C as Ht}from"./_14b2CUj.js";import{b as zo,c as No,d as Go,e as Ho,_ as Ko,a as qo}from"./C6vK2VYI.js";import{u as Wo,F as St,g as Xo,a as Jo,b as Qo}from"./lvbecDJM.js";import{_ as Yo}from"./D-8t_H8v.js";import{_ as Zo}from"./DiZ4QL0M.js";import{b as ea,_ as ta,a as oa}from"./DFGFWj04.js";import{_ as aa,a as na,b as sa,c as la}from"./ZTyVILcU.js";import{c as $t}from"./D2GZmoDz.js";import{E as Mt}from"./BdpCbTaQ.js";import{Q as ra}from"./C_rPMSjE.js";import{L as Vt}from"./C_iKoqeV.js";import{X as ia}from"./oLxPQbNe.js";import{u as ua}from"./s39mgViW.js";import"./CssJESp-.js";/**
 * @license lucide-vue-next v0.514.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const da=$t("list",[["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 18h.01",key:"1tta3j"}],["path",{d:"M3 6h.01",key:"1rqtza"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 18h13",key:"1lx6n3"}],["path",{d:"M8 6h13",key:"ik3vkj"}]]);/**
 * @license lucide-vue-next v0.514.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ca=$t("minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-vue-next v0.514.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pa=$t("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),ma={class:"space-y-5"},fa={class:"relative w-full"},va={key:0,class:"text-sm font-medium text-slate-700"},_a={key:1,class:"text-sm font-medium text-slate-700"},ga={key:0,class:"relative"},ya={class:"flex gap-2 items-center"},xa={class:"relative"},ha={class:"relative"},ba={class:"flex justify-end gap-2 mt-4"},Kt=he({__name:"CreateModal",props:{type:{},expenseCategories:{},parent:{},isOpen:{type:Boolean},category:{}},emits:["category-created","category-updated","update:isOpen","error"],setup(F,{emit:h}){const{$useApi:u}=ot(),{toast:U}=Po(),l=F,v=h,O=te(()=>!!l.category),D=C(l.isOpen||!1),K=te({get:()=>l.isOpen!==void 0?l.isOpen:D.value,set:E=>{l.isOpen!==void 0?v("update:isOpen",E):D.value=E}}),_=C([]),b=C(l.type||"Доходы"),L=C(!0),x=te(()=>{if(i.value.parentId===null||i.value.parentId===void 0)return l.expenseCategories&&l.expenseCategories.length>0,"Не принадлежит";const E=_.value.find($=>$.id===i.value.parentId);return E?E.name:l.parent?l.parent.name:"Не принадлежит"}),i=C({name:l.category?.name||"",type:l.category?.type||l.type||"Доходы",description:l.category?.description||"",parentId:l.category?.parentId??l.parent?.id??null}),a=async E=>{if(l.expenseCategories&&l.expenseCategories.length>0){let $=l.expenseCategories.map(z=>({id:z.id,name:z.name,type:E,createdAt:"",updatedAt:""}));O.value&&l.category&&($=$.filter(z=>z.id!==l.category.id)),_.value=$;return}try{const{data:$}=await u.get("planfact/expense-categories-by-type",{params:{type:E}});let z=$;O.value&&l.category&&(z=z.filter(N=>N.id!==l.category.id)),_.value=z}catch($){console.error($),U({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить категории."})}},r=async()=>{try{L.value=!0;let E;if(O.value&&l.category){const $={name:i.value.name,description:i.value.description,parentId:i.value.parentId===null||i.value.parentId===void 0?null:i.value.parentId},{data:z}=await u.patch(`planfact/expense-categories/${l.category.id}`,$);E=z,U({title:"Успех",description:"Категория успешно обновлена."}),v("category-updated",E)}else{const{data:$}=await u.post("planfact/expense-categories",i.value);E=$,U({title:"Успех",description:"Категория успешно создана."}),v("category-created",E)}K.value=!1,L.value=!1,O.value||(i.value={name:"",type:l.type||"Доходы",description:"",parentId:l.parent?.id||null})}catch(E){console.error(E),L.value=!1,U({variant:"destructive",title:"Ошибка",description:O.value?"Не удалось обновить категорию.":"Не удалось создать категорию."}),v("error")}};return le(()=>[l.type,l.parent,l.category],()=>{l.category?(i.value={name:l.category.name,type:l.category.type,description:l.category.description||"",parentId:l.category.parentId??null},b.value=l.category.type):(l.type&&(i.value.type=l.type,b.value=l.type),l.parent&&(i.value.parentId=l.parent.id))},{immediate:!0}),le(()=>l.expenseCategories,async E=>{K.value&&(E&&E.length>0?await a(b.value):l.expenseCategories||await a(b.value))},{immediate:!0,deep:!0}),le(K,async E=>{E?(l.type&&(i.value.type=l.type,b.value=l.type),!l.expenseCategories||l.expenseCategories.length===0?await a(b.value):await a(b.value),l.parent&&(i.value.parentId=l.parent.id)):i.value={name:"",type:l.type||"Доходы",description:"",parentId:l.parent?.id||null}}),Ge(async()=>{}),le(b,async E=>{i.value.type=E,await a(E)},{deep:!0}),le(i,E=>{console.log(E);const{name:$,type:z}=E;if($&&z)return L.value=!1;L.value=!0},{deep:!0}),(E,$)=>{const z=ke,N=vt,R=Ee,X=Re,W=Fe,Y=lt,c=st,k=nt,w=Ne,d=it,m=ze,M=rt,Z=Ve,S=Me;return s(),A(S,{open:o(K),"onUpdate:open":$[5]||($[5]=q=>Ce(K)?K.value=q:null)},{default:t(()=>[l.isOpen===void 0?(s(),A(N,{key:0},{default:t(()=>[e(z,{variant:"secondary"},{default:t(()=>$[6]||($[6]=[p("Создать статью",-1)])),_:1,__:[6]})]),_:1})):H("",!0),e(Z,{class:""},{default:t(()=>[e(W,null,{default:t(()=>[e(R,null,{default:t(()=>[p(B(o(O)?"Редактирование статьи":"Создание статьи"),1)]),_:1}),e(X)]),_:1}),n("div",ma,[n("div",fa,[o(O)&&l.category?(s(),I("div",va," Тип: "+B(l.category.type),1)):l.type?(s(),I("div",_a," Статья для "+B(l.type)+B(l.parent?"/"+l.parent?.name:""),1)):(s(),A(k,{key:2,modelValue:o(b),"onUpdate:modelValue":$[0]||($[0]=q=>Ce(b)?b.value=q:null)},{default:t(()=>[e(c,{class:"w-full"},{default:t(()=>[e(Y,{class:"w-full",value:"Расходы"},{default:t(()=>$[7]||($[7]=[p("Расходы",-1)])),_:1,__:[7]}),e(Y,{class:"w-full",value:"Доходы"},{default:t(()=>$[8]||($[8]=[p("Доходы",-1)])),_:1,__:[8]}),e(Y,{class:"w-full",value:"Обязательства"},{default:t(()=>$[9]||($[9]=[p("Обязательства",-1)])),_:1,__:[9]}),e(Y,{class:"w-full",value:"Капитал"},{default:t(()=>$[10]||($[10]=[p("Капитал",-1)])),_:1,__:[10]}),e(Y,{class:"w-full",value:"Активы"},{default:t(()=>$[11]||($[11]=[p("Активы",-1)])),_:1,__:[11]})]),_:1})]),_:1},8,["modelValue"]))]),l.type||o(O)||l.expenseCategories&&l.expenseCategories.length>0?(s(),I("div",ga,[e(w,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>$[12]||($[12]=[p(" Принадлежит к ",-1)])),_:1,__:[12]}),n("div",ya,[(s(),A(d,{key:o(_).length,class:"min-w-[462px] w-[462px] overflow-hidden",items:[...l.expenseCategories&&l.expenseCategories.length>0?[{value:-1,label:"Не принадлежит"}]:[],...o(_).map(q=>({value:q.id,label:q.name}))],label:o(x),"model-value":o(i).parentId,onSelectedItem:$[1]||($[1]=q=>{o(i).parentId=q===-1?null:q||null})},null,8,["items","label","model-value"]))])])):H("",!0),n("div",xa,[e(m,{modelValue:o(i).name,"onUpdate:modelValue":$[2]||($[2]=q=>o(i).name=q),placeholder:"Название категории",class:we(o(i).name?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"]),o(i).name?(s(),A(w,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>$[13]||($[13]=[p(" Название категории ",-1)])),_:1,__:[13]})):H("",!0)]),n("div",ha,[e(M,{modelValue:o(i).description,"onUpdate:modelValue":$[3]||($[3]=q=>o(i).description=q),placeholder:"Описание"},null,8,["modelValue"]),o(i).description?(s(),A(w,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>$[14]||($[14]=[p(" Описание ",-1)])),_:1,__:[14]})):H("",!0)])]),n("div",ba,[e(z,{variant:"outline",onClick:$[4]||($[4]=q=>K.value=!1)},{default:t(()=>$[15]||($[15]=[p("Отмена",-1)])),_:1,__:[15]}),e(z,{disabled:o(L),onClick:r},{default:t(()=>[p(B(o(O)?"Сохранить":"Создать"),1)]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["open"])}}});function He(){const{$useApi:F}=ot(),h=F,u=C([]),U=C([]),l=C({page:1,limit:20,total:0,totalPages:1,hasNext:!1,hasPrev:!1}),v=C(""),O=C([]),D=C([]),K=C({counterPartyTotals:[],expenseCategoryTotals:[],mainTotals:{}}),_=C({page:1,limit:50,total:0,totalPages:1,hasNext:!1,hasPrev:!1}),b=C(!1),L=C(!1),x=C(!1),i=C(!1),a=C(!1);return{accounts:u,counterPartiesFilters:U,counterPartiesFiltersPagination:l,counterPartiesFiltersSearchTerm:v,expenseCategoriesFilters:O,operationsData:D,operationsTotals:K,pagination:_,loading:b,isLoadingMore:L,isLoadingOperations:x,isLoadingTotals:i,isLoadingCounterParties:a,getAccounts:async()=>{try{const{data:k}=await h.get("planfact/accounts");u.value=k.map(w=>({value:w.id,label:w.name,account:w.account}))}catch(k){console.error(k),se({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить счета."})}},getCounterPartiesFilters:async(k=!0,w)=>{if(!a.value){a.value=!0,b.value=!0;try{const d=k?1:l.value.page+1,m=w!==void 0?w.trim()||void 0:k?void 0:v.value.trim()||void 0,{data:M}=await h.get("planfact/counter-parties-filters",{params:{page:d,limit:20,...m&&{title:m}}});k?(U.value=M.data,v.value=m||""):U.value=[...U.value,...M.data],l.value=M.pagination}catch(d){console.error(d),se({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить контрагентов."})}finally{b.value=!1,a.value=!1}}},getOriginalOperationsTotals:async(k,w,d)=>{try{const M={from:k,to:w,accountId:d==="all"?void 0:d},{data:Z}=await h.get("planfact/original-operations-totals",{params:M});K.value=Z}catch(m){console.error(m),se({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить тоталы операций."})}},getOriginalOperations:async k=>{const{reset:w=!0,...d}=k;w||(L.value=!0);try{const m=d.accountId==="all"?void 0:d.accountId,M={from:d.from,to:d.to,page:d.page,limit:d.limit,accountId:m,...d.distributionFilter&&d.distributionFilter!=="all"&&{distributionFilter:d.distributionFilter}};d.counterPartyId&&d.counterPartyId.length>0&&(M.counterPartyId=d.counterPartyId.join(",")),d.expenseCategoryId&&d.expenseCategoryId.length>0&&(M.expenseCategoryId=d.expenseCategoryId.join(",")),d.typeOfOperation&&d.typeOfOperation!=="all"&&(M.typeOfOperation=d.typeOfOperation),d.searchText&&(M.searchText=d.searchText);const Z=await h.get("/planfact/original-operations",{params:M}),{operations:S,pagination:q}=Z.data;w?D.value=S:D.value=[...D.value,...S],_.value=q}catch(m){console.error(m),se({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить операции."})}finally{w||(L.value=!1)}},getExpenseCategoriesMini:async k=>{try{let w="";k==="Debit"?w="Расходы":k==="Credit"&&(w="Доходы");const d=w?{type:w}:{},{data:m}=await h.get("planfact/expense-categories-mini",{params:d});return m}catch(w){throw console.error(w),se({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить статьи расходов."}),w}},updateOperationPositions:async(k,w)=>{try{await h.patch(`planfact/original-operation/${k}/positions`,w)}catch(d){console.error(d);const m=d,M=m?.response?.data?.message||m?.response?.data?.detail||m?.message||"Не удалось обновить позиции операции.";throw se({variant:"destructive",title:"Ошибка",description:M}),d}},deleteOperation:async k=>{try{await h.delete(`planfact/operation/${k}`),se({title:"Успех",description:"Операция успешно удалена."})}catch(w){throw console.error(w),se({variant:"destructive",title:"Ошибка",description:"Не удалось удалить операцию."}),w}},removeCategoryFromPosition:async k=>{try{await h.patch(`planfact/position/${k}/remove-category`),se({title:"Успех",description:"Категория удалена из позиции."})}catch(w){console.error(w);const d=w;throw se({variant:"destructive",title:"Ошибка",description:d.response?.data?.message||d.response?.data?.detail||"Не удалось удалить категорию."}),w}},createCounterParty:async k=>{try{const{data:w}=await h.post("planfact/counter-parties",k);return se({title:"Успех",description:"Контрагент успешно создан."}),w}catch(w){console.error(w);const d=w;throw se({variant:"destructive",title:"Ошибка",description:d.response?.data?.message||d.response?.data?.detail||"Не удалось создать контрагента."}),w}},createCounterPartyRule:async k=>{try{const{data:w}=await h.patch("planfact/counter-parties/expense-categories",k);return se({title:"Успех",description:`Правило создано. Обновлено позиций: ${w.updatedPositionsCount}`}),w}catch(w){console.error(w);const d=w;throw se({variant:"destructive",title:"Ошибка",description:d.response?.data?.message||d.response?.data?.detail||"Не удалось создать правило."}),w}}}}const Ca={class:"space-y-5"},wa={class:"relative"},ka={class:"relative w-full"},Pa={class:"relative"},Ia={class:"flex gap-2"},$a={class:"relative"},Ua={class:"flex gap-2"},Ta={class:"relative"},Oa={class:"relative"},Da={class:"relative"},Sa={class:"flex justify-end gap-2 mt-4"},qt=he({__name:"CreateModal",emits:["counterparty-created"],setup(F,{emit:h}){const{getExpenseCategoriesMini:u,createCounterParty:U}=He(),l=C(!1),v=C([]),O=C([]),D=C(!0),K=h,_=C({title:"",inn:"",kpp:"",account:"",bankBic:"",bankName:"",contrAgentGroup:"",incomeExpenseCategoryId:null,outcomeExpenseCategoryId:null}),b=async()=>{try{const i=await u("Credit");v.value=i}catch(i){console.error(i)}},L=async()=>{try{const i=await u("Debit");O.value=i}catch(i){console.error(i)}},x=async()=>{try{D.value=!0;const i=await U({title:_.value.title,inn:_.value.inn||"",kpp:_.value.kpp||"",account:_.value.account||"",bankBic:_.value.bankBic||"",bankName:_.value.bankName||"",contrAgentGroup:_.value.contrAgentGroup||"",incomeExpenseCategoryId:_.value.incomeExpenseCategoryId||null,outcomeExpenseCategoryId:_.value.outcomeExpenseCategoryId||null});K("counterparty-created",i),l.value=!1,D.value=!1,_.value={title:"",inn:"",kpp:"",account:"",bankBic:"",bankName:"",contrAgentGroup:"",incomeExpenseCategoryId:null,outcomeExpenseCategoryId:null}}catch(i){console.error(i)}finally{D.value=!1}};return le(l,async i=>{i?(await b(),await L()):_.value={title:"",inn:"",kpp:"",account:"",bankBic:"",bankName:"",contrAgentGroup:"",incomeExpenseCategoryId:null,outcomeExpenseCategoryId:null}}),Ge(async()=>{}),le(_,i=>{const{title:a}=i;D.value=!a},{deep:!0}),(i,a)=>{const r=ke,E=vt,$=Ee,z=Re,N=Fe,R=ze,X=Ne,W=Ze,Y=Ye,c=tt,k=Do,w=et,d=Qe,m=it,M=Ve,Z=Me;return s(),A(Z,{open:o(l),"onUpdate:open":a[8]||(a[8]=S=>Ce(l)?l.value=S:null)},{default:t(()=>[e(E,null,{default:t(()=>[e(r,{variant:"secondary"},{default:t(()=>a[9]||(a[9]=[p("Создать контрагента",-1)])),_:1,__:[9]})]),_:1}),e(M,{class:""},{default:t(()=>[e(N,null,{default:t(()=>[e($,null,{default:t(()=>a[10]||(a[10]=[p("Создание контрагента",-1)])),_:1,__:[10]}),e(z)]),_:1}),n("div",Ca,[n("div",wa,[e(R,{modelValue:o(_).title,"onUpdate:modelValue":a[0]||(a[0]=S=>o(_).title=S),placeholder:"Название контрагента",class:we(o(_).title?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"]),o(_).title?(s(),A(X,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>a[11]||(a[11]=[p(" Название контрагента ",-1)])),_:1,__:[11]})):H("",!0)]),n("div",ka,[e(d,{modelValue:o(_).contrAgentGroup,"onUpdate:modelValue":a[1]||(a[1]=S=>o(_).contrAgentGroup=S)},{default:t(()=>[e(Y,null,{default:t(()=>[e(W,{placeholder:"Группа"})]),_:1}),e(w,null,{default:t(()=>[e(k,null,{default:t(()=>[e(c,{class:"w-full",value:"Банки"},{default:t(()=>a[12]||(a[12]=[p("Банки",-1)])),_:1,__:[12]}),e(c,{class:"w-full",value:"Гос. органы"},{default:t(()=>a[13]||(a[13]=[p("Гос. органы",-1)])),_:1,__:[13]}),e(c,{class:"w-full",value:"Клиенты"},{default:t(()=>a[14]||(a[14]=[p("Клиенты",-1)])),_:1,__:[14]}),e(c,{class:"w-full",value:"Поставщики"},{default:t(()=>a[15]||(a[15]=[p("Поставщики",-1)])),_:1,__:[15]}),e(c,{class:"w-full",value:"Сотрудники"},{default:t(()=>a[16]||(a[16]=[p("Сотрудники",-1)])),_:1,__:[16]})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),n("div",Pa,[e(X,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>a[17]||(a[17]=[p(" Категория для входящих операций ",-1)])),_:1,__:[17]}),n("div",Ia,[(s(),A(m,{key:o(v).length,class:"min-w-[462px] w-[462px] overflow-hidden",items:o(v).map(S=>({value:S.id,label:S.name})),label:o(v).find(S=>S.id===o(_).incomeExpenseCategoryId)?.name??"Выбрать","model-value":o(_).incomeExpenseCategoryId,onSelectedItem:a[2]||(a[2]=S=>o(_).incomeExpenseCategoryId=S)},null,8,["items","label","model-value"]))])]),n("div",$a,[e(X,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>a[18]||(a[18]=[p(" Категория для исходящих операций ",-1)])),_:1,__:[18]}),n("div",Ua,[(s(),A(m,{key:o(O).length,class:"min-w-[462px] w-[462px] overflow-hidden",items:o(O).map(S=>({value:S.id,label:S.name})),label:o(O).find(S=>S.id===o(_).outcomeExpenseCategoryId)?.name??"Выбрать","model-value":o(_).outcomeExpenseCategoryId,onSelectedItem:a[3]||(a[3]=S=>o(_).outcomeExpenseCategoryId=S)},null,8,["items","label","model-value"]))])]),n("div",Ta,[e(R,{modelValue:o(_).inn,"onUpdate:modelValue":a[4]||(a[4]=S=>o(_).inn=S),placeholder:"ИНН"},null,8,["modelValue"]),o(_).inn?(s(),A(X,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>a[19]||(a[19]=[p(" ИНН ",-1)])),_:1,__:[19]})):H("",!0)]),n("div",Oa,[e(R,{modelValue:o(_).kpp,"onUpdate:modelValue":a[5]||(a[5]=S=>o(_).kpp=S),placeholder:"КПП"},null,8,["modelValue"]),o(_).kpp?(s(),A(X,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>a[20]||(a[20]=[p(" КПП ",-1)])),_:1,__:[20]})):H("",!0)]),n("div",Da,[e(R,{modelValue:o(_).account,"onUpdate:modelValue":a[6]||(a[6]=S=>o(_).account=S),placeholder:"Расчетный счет"},null,8,["modelValue"]),o(_).account?(s(),A(X,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>a[21]||(a[21]=[p(" Расчетный счет ",-1)])),_:1,__:[21]})):H("",!0)])]),n("div",Sa,[e(r,{variant:"outline",onClick:a[7]||(a[7]=S=>l.value=!1)},{default:t(()=>a[22]||(a[22]=[p("Отмена",-1)])),_:1,__:[22]}),e(r,{disabled:o(D),onClick:x},{default:t(()=>a[23]||(a[23]=[p("Создать",-1)])),_:1,__:[23]},8,["disabled"])])]),_:1})]),_:1},8,["open"])}}});function Ue(F){const h=[[/ОБЩЕСТВО\s+С\s+ОГРАНИЧЕННОЙ\s+ОТВЕТСТВЕННОСТЬЮ|Общество\s+с\s+ограниченной\s+ответственностью/gi,"ООО"],[/ИНДИВИДУАЛЬНЫЙ\s+ПРЕДПРИНИМАТЕЛЬ|Индивидуальный\s+предприниматель/gi,"ИП"],[/АКЦИОНЕРНОЕ\s+ОБЩЕСТВО|Акционерное\s+общество/gi,"АО"],[/ЗАКРЫТОЕ\s+АКЦИОНЕРНОЕ\s+ОБЩЕСТВО|Закрытое\s+акционерное\s+общество/gi,"ЗАО"],[/ОТКРЫТОЕ\s+АКЦИОНЕРНОЕ\s+ОБЩЕСТВО|Открытое\s+акционерное\s+общество/gi,"ОАО"]];let u=F;for(const[U,l]of h)u=u.replace(U,l);return u.trim().replace(/\s+/g," ")}const Ma={class:"w-full"},Va={class:"truncate min-w-0 flex-1 text-left"},Fa={key:1,class:"flex items-center justify-center py-2 text-sm text-slate-500"},Wt=he({__name:"SelectPopover",props:{items:{},selectedId:{},label:{},placeholder:{default:""},onLoadMore:{type:[Function,null],default:null},onSearch:{type:[Function,null],default:null},hasMore:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1}},emits:["update:selectedId"],setup(F,{emit:h}){const u=F,U=h,l=C(""),v=C(!1),O=C(null),D=te(()=>u.items.find(a=>a.id===u.selectedId)),K=te(()=>u.items),_=a=>{u.selectedId===a?U("update:selectedId",null):U("update:selectedId",a),v.value=!1},b=()=>{U("update:selectedId",null),v.value=!1};let L=null;const x=a=>{L&&clearTimeout(L),L=setTimeout(()=>{u.onSearch&&u.onSearch(a||"")},300)};le(l,a=>{x(a)});const i=a=>{const r=a.target;if(!r||!O.value||!u.hasMore||u.isLoading)return;const $=O.value.getBoundingClientRect(),z=r.getBoundingClientRect();$.top<=z.bottom+100&&$.bottom>=z.top&&u.onLoadMore&&u.onLoadMore()};return le(v,a=>{a?_t(()=>{u.onSearch&&u.onSearch("")}):l.value=""}),Rt(()=>{L&&clearTimeout(L)}),(a,r)=>{const E=ke,$=yt,z=bt,N=wt,R=Pt,X=kt,W=It,Y=Ct,c=ht,k=xt,w=gt;return s(),I("div",Ma,[e(w,{open:v.value,"onUpdate:open":r[2]||(r[2]=d=>v.value=d)},{default:t(()=>[e($,{"as-child":""},{default:t(()=>[e(E,{variant:"outline",size:"sm",class:"h-8 justify-between max-w-[300px] w-full"},{default:t(()=>[n("span",Va,B(D.value?D.value.title:a.label),1),e(o(So),{class:"ml-2 h-4 w-4 shrink-0 opacity-50"})]),_:1})]),_:1}),e(k,{class:"w-full max-w-[300px] p-0",align:"start"},{default:t(()=>[e(c,{"should-filter":!1},{default:t(()=>[e(z,{"model-value":l.value,placeholder:a.placeholder||a.label,"onUpdate:modelValue":r[0]||(r[0]=d=>{l.value=d}),onInput:r[1]||(r[1]=d=>{const m=d.target;m?.value!==void 0&&(l.value=m.value)})},null,8,["model-value","placeholder"]),e(Y,{class:"max-h-[300px]",onScroll:i},{default:t(()=>[!a.isLoading&&K.value.length===0?(s(),A(N,{key:0},{default:t(()=>r[3]||(r[3]=[p(" Нет совпадений. ",-1)])),_:1,__:[3]})):H("",!0),e(X,null,{default:t(()=>[(s(!0),I(ee,null,re(K.value,d=>(s(),A(R,{key:d.id,value:d,class:"py-2",onSelect:m=>_(d.id)},{default:t(()=>[n("span",{class:we(a.selectedId===d.id?"flex-1 break-words whitespace-normal font-medium leading-relaxed":"flex-1 break-words whitespace-normal leading-relaxed")},B(d.title),3)]),_:2},1032,["value","onSelect"]))),128)),a.hasMore&&!a.isLoading?(s(),I("div",{key:0,ref_key:"loadMoreRef",ref:O,class:"h-4"},null,512)):H("",!0),a.isLoading?(s(),I("div",Fa," Загрузка... ")):H("",!0)]),_:1}),a.selectedId!==null?(s(),I(ee,{key:1},[e(W),e(X,null,{default:t(()=>[e(R,{value:{label:"Очистить"},class:"justify-center text-center",onSelect:b},{default:t(()=>r[4]||(r[4]=[p(" Очистить ",-1)])),_:1,__:[4]})]),_:1})],64)):H("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["open"])])}}}),Ea={class:"flex gap-2 min-h-[600px]"},Ra={class:"space-y-5 min-w-[450px]"},La={class:"relative w-full"},Aa={class:"relative"},Ba={class:"relative"},ja={class:"space-y-3"},za={class:"flex gap-4 justify-between"},Na={class:"relative"},Ga={class:"relative flex-1"},Ha={class:"relative"},Ka={class:"relative grow"},qa={class:"flex flex-col mt-6"},Wa={class:"flex justify-end gap-2 mt-4"},Xa=he({__name:"OperationCreateModal",props:{accountId:{}},emits:["operation-created"],setup(F,{emit:h}){const{$useApi:u}=ot(),{counterPartiesFilters:U,counterPartiesFiltersPagination:l,isLoadingCounterParties:v,getCounterPartiesFilters:O,getExpenseCategoriesMini:D}=He(),K=F,_=C(!1),b=C([]),L=C("Поступление"),x=C(!0),i=te(()=>U.value.map(d=>({id:d.id,title:Ue(d.title)+" (..."+d.account.slice(-4)+")"}))),a=h,r=C({operationDate:"",operationType:"Credit",payPurpose:"",accountId:K.accountId,operationPositions:[{amount:0,counterPartyId:null,expenseCategoryId:null}]}),E=te(()=>r.value.operationDate&&r.value.operationType&&r.value.accountId&&r.value.operationPositions?.length>0&&r.value.operationPositions.every(d=>d.amount>0&&d.counterPartyId&&d.expenseCategoryId)),$=te(()=>r.value.operationPositions?.reduce((d,m)=>d+(m.amount||0),0)||0),z=d=>d==="Поступление"?"Credit":d==="Выплата"||d==="Начисление"?"Debit":d,N=async d=>{try{const m=z(d),M=await D(m);b.value=M}catch(m){console.error(m),se({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить категории."})}},R=async d=>{await O(!0,d)},X=async()=>{await O(!1)},W=async()=>{try{x.value=!0;const{data:d}=await u.post("planfact/operation",{...r.value,operationPositions:r.value.operationPositions.map(m=>({amount:m.amount,counterPartyId:m.counterPartyId||null,expenseCategoryId:m.expenseCategoryId||null}))});se({title:"Успех",description:"Операция успешно создана."}),a("operation-created",d),_.value=!1,x.value=!1,r.value={operationDate:"",operationType:"Credit",payPurpose:"",accountId:K.accountId,operationPositions:[{amount:0,counterPartyId:null,expenseCategoryId:null}]}}catch(d){console.error(d),se({variant:"destructive",title:"Ошибка",description:"Не удалось создать операцию."})}},Y=()=>{r.value.operationPositions=[...r.value.operationPositions||[],{amount:0,counterPartyId:null,expenseCategoryId:null}]},c=d=>{r.value.operationPositions&&r.value.operationPositions.length>1?r.value.operationPositions.splice(d,1):se({variant:"destructive",title:"Ошибка",description:"Нельзя удалить последнюю позицию."})},k=async d=>{b.value.push(d)},w=async()=>{await O(!0)};return Ge(async()=>{}),le(_,async d=>{d?(await N(L.value),await O(!0)):r.value={operationDate:"",operationType:"Credit",payPurpose:"",accountId:K.accountId,operationPositions:[{amount:0,counterPartyId:null,expenseCategoryId:null}]}}),le(L,async d=>{const m=z(d);r.value.operationType=m,await N(d),r.value.operationPositions=r.value.operationPositions?.map(M=>({...M,expenseCategoryId:null}))||[{amount:0,counterPartyId:null,expenseCategoryId:null}]},{deep:!0}),le(r,()=>{x.value=!E.value},{deep:!0}),(d,m)=>{const M=ke,Z=vt,S=Ee,q=Re,ae=Fe,f=lt,y=st,pe=nt,de=ze,ne=Ne,_e=rt,Q=Kt,J=qt,ge=it,ye=Ve,Pe=Me;return s(),A(Pe,{open:_.value,"onUpdate:open":m[4]||(m[4]=ie=>_.value=ie)},{default:t(()=>[e(Z,{class:"z-[1]"},{default:t(()=>[e(M,{class:"h-8"},{default:t(()=>m[5]||(m[5]=[p("+",-1)])),_:1,__:[5]})]),_:1}),e(ye,{class:"max-w-[1200px]"},{default:t(()=>[e(ae,null,{default:t(()=>[e(S,null,{default:t(()=>m[6]||(m[6]=[p("Создание операции",-1)])),_:1,__:[6]}),e(q)]),_:1}),n("div",Ea,[n("div",Ra,[n("div",La,[e(pe,{modelValue:L.value,"onUpdate:modelValue":m[0]||(m[0]=ie=>L.value=ie)},{default:t(()=>[e(y,{class:"w-full"},{default:t(()=>[e(f,{class:"w-full",value:"Поступление"},{default:t(()=>m[7]||(m[7]=[p("Поступление",-1)])),_:1,__:[7]}),e(f,{class:"w-full",value:"Выплата"},{default:t(()=>m[8]||(m[8]=[p("Выплата",-1)])),_:1,__:[8]}),e(f,{class:"w-full",value:"Начисление"},{default:t(()=>m[9]||(m[9]=[p("Начисление",-1)])),_:1,__:[9]})]),_:1})]),_:1},8,["modelValue"])]),n("div",Aa,[e(de,{modelValue:r.value.operationDate,"onUpdate:modelValue":m[1]||(m[1]=ie=>r.value.operationDate=ie),type:"date",placeholder:"Дата операции",class:we(r.value.operationDate?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"]),e(ne,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>m[10]||(m[10]=[p(" Дата операции ",-1)])),_:1,__:[10]})]),n("div",Ba,[e(_e,{modelValue:r.value.payPurpose,"onUpdate:modelValue":m[2]||(m[2]=ie=>r.value.payPurpose=ie),placeholder:"Назначение платежа"},null,8,["modelValue"]),r.value.payPurpose?(s(),A(ne,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>m[11]||(m[11]=[p(" Назначение платежа ",-1)])),_:1,__:[11]})):H("",!0)])]),n("div",ja,[n("div",za,[n("div",Na,[e(de,{value:$.value,type:"number",placeholder:"Общая сумма",disabled:"",class:"bg-gray-100"},null,8,["value"]),e(ne,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>m[12]||(m[12]=[p(" Общая сумма ",-1)])),_:1,__:[12]})]),e(Q,{onCategoryCreated:k}),e(J,{onCounterpartyCreated:w})]),(s(!0),I(ee,null,re(r.value.operationPositions,(ie,Ie)=>(s(),I("div",{key:Ie,class:"flex gap-2 items-center"},[n("div",Ga,[e(de,{modelValue:ie.amount,"onUpdate:modelValue":ue=>ie.amount=ue,modelModifiers:{number:!0},type:"number",placeholder:"Сумма",class:we(ie.amount>0?"":"outline-1 outline-rose-300")},null,8,["modelValue","onUpdate:modelValue","class"]),e(ne,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>m[13]||(m[13]=[p(" Сумма ",-1)])),_:1,__:[13]})]),n("div",Ha,[e(ne,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>m[14]||(m[14]=[p(" Статья ",-1)])),_:1,__:[14]}),e(ge,{class:"min-w-[200px] w-[200px] overflow-hidden",items:b.value.map(ue=>({value:ue.id,label:ue.name})),label:b.value.find(ue=>ue.id===ie.expenseCategoryId)?.name??"Выбрать","model-value":ie.expenseCategoryId,onSelectedItem:ue=>ie.expenseCategoryId=ue},null,8,["items","label","model-value","onSelectedItem"])]),n("div",Ka,[e(ne,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>m[15]||(m[15]=[p(" Контрагент ",-1)])),_:1,__:[15]}),e(Wt,{items:i.value,"selected-id":ie.counterPartyId,label:(()=>{const ue=i.value.find(Le=>Le.id===ie.counterPartyId);return ue?ue.title:"Выберите контрагента"})(),placeholder:"Поиск контрагента...","has-more":o(l).hasNext,"is-loading":o(v),"on-search":R,"on-load-more":X,"onUpdate:selectedId":ue=>ie.counterPartyId=ue},null,8,["items","selected-id","label","has-more","is-loading","onUpdate:selectedId"])]),e(M,{variant:"destructive",disabled:r.value.operationPositions?.length===1,onClick:ue=>c(Ie)},{default:t(()=>m[16]||(m[16]=[p(" X ",-1)])),_:2,__:[16]},1032,["disabled","onClick"])]))),128)),n("div",qa,[e(M,{class:"ml-auto",onClick:Y},{default:t(()=>m[17]||(m[17]=[p("Добавить позицию",-1)])),_:1,__:[17]})])])]),n("div",Wa,[e(M,{variant:"outline",onClick:m[3]||(m[3]=ie=>_.value=!1)},{default:t(()=>m[18]||(m[18]=[p("Отмена",-1)])),_:1,__:[18]}),e(M,{disabled:x.value,onClick:W},{default:t(()=>m[19]||(m[19]=[p("Создать",-1)])),_:1,__:[19]},8,["disabled"])])]),_:1})]),_:1},8,["open"])}}}),Ja=he({__name:"ToggleGroup",props:{rovingFocus:{type:Boolean},disabled:{type:Boolean},orientation:{},dir:{},loop:{type:Boolean},asChild:{type:Boolean},as:{},type:{},modelValue:{},defaultValue:{},class:{},variant:{},size:{}},emits:["update:modelValue"],setup(F,{emit:h}){const u=F,U=h;Lt("toggleGroup",{variant:u.variant,size:u.size});const l=te(()=>{const{class:O,...D}=u;return D}),v=Lo(l,U);return(O,D)=>(s(),A(o(Ao),Bt(o(v),{class:o(Gt)("flex items-center justify-center gap-1",u.class)}),{default:t(()=>[At(O.$slots,"default")]),_:3},16,["class"]))}}),Qa=yo("inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-white transition-colors hover:bg-slate-100 hover:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-slate-100 data-[state=on]:text-slate-900 dark:ring-offset-slate-950 dark:hover:bg-slate-800 dark:hover:text-slate-400 dark:focus-visible:ring-slate-300 dark:data-[state=on]:bg-slate-800 dark:data-[state=on]:text-slate-50",{variants:{variant:{default:"bg-transparent",outline:"border border-slate-200 bg-transparent hover:bg-slate-100 hover:text-slate-900 dark:border-slate-800 dark:hover:bg-slate-800 dark:hover:text-slate-50"},size:{default:"h-10 px-3",sm:"h-9 px-2.5",lg:"h-11 px-5"}},defaultVariants:{variant:"default",size:"default"}}),Ya=he({__name:"ToggleGroupItem",props:{value:{},disabled:{type:Boolean},asChild:{type:Boolean},as:{},class:{},variant:{},size:{}},setup(F){const h=F,u=jt("toggleGroup"),U=te(()=>{const{class:v,variant:O,size:D,...K}=h;return K}),l=Bo(U);return(v,O)=>(s(),A(o(jo),Bt(o(l),{class:o(Gt)(o(Qa)({variant:o(u)?.variant||v.variant,size:o(u)?.size||v.size}),h.class)}),{default:t(()=>[At(v.$slots,"default")]),_:3},16,["class"]))}}),Za={class:"flex items-center justify-between"},en={class:"flex flex-1 items-center gap-2"},tn={class:"hidden space-x-1 lg:flex"},on={class:"relative"},an={class:"p-2 space-y-4"},nn={class:"space-y-1"},sn={class:""},ln={class:"space-y-2"},rn={class:"text-sm"},un=he({__name:"DataTableToolbar",props:{table:{},counterPartiesFilters:{},expenseCategoriesFilters:{},distributionFilter:{},typeOfOperationFilter:{},selectedCounterPartyIds:{},selectedExpenseCategoryIds:{},counterPartiesFiltersPagination:{},isLoadingCounterParties:{type:Boolean},onCounterPartiesLoadMore:{type:Function},onCounterPartiesSearch:{type:Function}},emits:["counter-parties-filter-change","expense-categories-filter-change","distribution-filter-change","type-of-operation-filter-change"],setup(F,{emit:h}){const u=F,U=h,l=C(u.selectedCounterPartyIds||[]),v=C(u.selectedExpenseCategoryIds||[]),O=C(u.distributionFilter),D=C(u.typeOfOperationFilter);te(()=>u.table.getState().columnFilters.length>0||l.value.length>0||v.value.length>0||O.value!=="all"||D.value!=="all");const K=x=>{const i=v.value.indexOf(x);i>-1?v.value.splice(i,1):v.value.push(x),U("expense-categories-filter-change",[...v.value])},_=()=>{v.value=[],U("expense-categories-filter-change",[])},b=x=>{O.value=x,U("distribution-filter-change",x)},L=x=>{D.value=x,U("type-of-operation-filter-change",x)};return le(()=>u.distributionFilter,x=>{O.value=x}),le(()=>u.typeOfOperationFilter,x=>{D.value=x}),le(()=>u.selectedCounterPartyIds,x=>{x?l.value=[...x]:l.value=[]},{immediate:!0}),le(()=>u.selectedExpenseCategoryIds,x=>{x?v.value=[...x]:v.value=[]},{immediate:!0}),(x,i)=>{const a=mt,r=Nt,E=ke,$=yt,z=bt,N=wt,R=Pt,X=kt,W=It,Y=Ct,c=ht,k=xt,w=gt,d=Eo,m=Ya,M=Ja,Z=Ro,S=Fo,q=Vo,ae=Mo;return s(),I("div",Za,[n("div",en,[x.expenseCategoriesFilters.length>0?(s(),A(w,{key:0},{default:t(()=>[e($,{"as-child":""},{default:t(()=>[e(E,{variant:"outline",size:"sm",class:"h-8 border-dashed"},{default:t(()=>[e(o(zt),{class:"mr-2 h-4 w-4"}),i[2]||(i[2]=p(" Статья ",-1)),v.value.length>0?(s(),I(ee,{key:0},[e(a,{orientation:"vertical",class:"mx-2 h-4"}),e(r,{variant:"secondary",class:"rounded-sm px-1 font-normal lg:hidden"},{default:t(()=>[p(B(v.value.length),1)]),_:1}),n("div",tn,[v.value.length>0?(s(),A(r,{key:0,variant:"secondary",class:"rounded-sm px-1 font-normal"},{default:t(()=>[p(B(v.value.length),1)]),_:1})):(s(!0),I(ee,{key:1},re(x.expenseCategoriesFilters.filter(f=>v.value.includes(f.id)),f=>(s(),A(r,{key:f.id,variant:"secondary",class:"rounded-sm px-1 font-normal"},{default:t(()=>[p(B(f.name),1)]),_:2},1024))),128))])],64)):H("",!0)]),_:1,__:[2]})]),_:1}),e(k,{class:"w-[250px] p-0",align:"start"},{default:t(()=>[e(c,{"filter-function":(f,y)=>f.filter(pe=>pe.name.toLowerCase()?.includes(y))},{default:t(()=>[e(z,{placeholder:"Статья"}),e(Y,null,{default:t(()=>[e(N,null,{default:t(()=>i[3]||(i[3]=[p("Нет совпадений.",-1)])),_:1,__:[3]}),e(X,null,{default:t(()=>[(s(!0),I(ee,null,re(x.expenseCategoriesFilters,f=>(s(),A(R,{key:f.id,value:f,onSelect:y=>K(f.id)},{default:t(()=>[n("div",{class:we(v.value.includes(f.id)?"mr-2 flex h-4 w-4 items-center justify-center rounded-sm border border-primary bg-primary text-primary-foreground":"mr-2 flex h-4 w-4 items-center justify-center rounded-sm border border-primary opacity-50 [&_svg]:invisible")},[e(o(Ht),{class:"h-4 w-4"})],2),n("span",null,B(f.name),1)]),_:2},1032,["value","onSelect"]))),128))]),_:1}),v.value.length>0?(s(),I(ee,{key:0},[e(W),e(X,null,{default:t(()=>[e(R,{value:{label:"Очистить"},class:"justify-center text-center",onSelect:_},{default:t(()=>i[4]||(i[4]=[p(" Очистить ",-1)])),_:1,__:[4]})]),_:1})],64)):H("",!0)]),_:1})]),_:1},8,["filter-function"])]),_:1})]),_:1})):H("",!0),n("div",on,[e(ae,{viewport:!1,class:"z-50"},{default:t(()=>[e(q,null,{default:t(()=>[e(S,null,{default:t(()=>[e(d,{class:"h-8"},{default:t(()=>i[5]||(i[5]=[p(" ФИЛЬТРЫ ",-1)])),_:1,__:[5]}),e(Z,{class:"!right-0 !left-auto"},{default:t(()=>[n("div",an,[n("div",nn,[i[6]||(i[6]=n("div",{class:"text-sm font-semibold mb-2"}," Фильтр операций ",-1)),e(M,{type:"single","model-value":O.value,class:"flex flex-col gap-1","onUpdate:modelValue":i[0]||(i[0]=f=>f&&typeof f=="string"&&b(f))},{default:t(()=>[(s(),I(ee,null,re([{value:"all",label:"Все"},{value:"hasCat",label:"Распределенные"},{value:"hasntCat",label:"Нераспределенные"}],f=>e(m,{key:f.value,value:f.value,class:"justify-between w-full"},{default:t(()=>[n("span",sn,B(f.label),1)]),_:2},1032,["value"])),64))]),_:1},8,["model-value"])]),e(a),n("div",ln,[i[7]||(i[7]=n("div",{class:"text-sm font-semibold mb-2"},"Тип операции",-1)),e(M,{type:"single","model-value":D.value,class:"flex flex-col gap-1","onUpdate:modelValue":i[1]||(i[1]=f=>f&&typeof f=="string"&&L(f))},{default:t(()=>[(s(),I(ee,null,re([{value:"all",label:"Все"},{value:"Credit",label:"Поступления"},{value:"Debit",label:"Выплаты"},{value:"Transfer",label:"Перемещения"}],f=>e(m,{key:f.value,value:f.value,class:"justify-between w-full"},{default:t(()=>[n("span",rn,B(f.label),1)]),_:2},1032,["value"])),64))]),_:1},8,["model-value"])])])]),_:1})]),_:1})]),_:1})]),_:1})])])])}}}),dn={class:"bg-slate-100 rounded-sm overflow-hidden"},cn=he({__name:"DataTable",props:{columns:{},data:{},isLoading:{type:Boolean},isLoadingMore:{type:Boolean},hasMore:{type:Boolean},sorting:{},isInitialLoad:{type:Boolean}},emits:["item-clicked","load-more","sort-change","counter-parties-filter-change","expense-categories-filter-change","distribution-filter-change","type-of-operation-filter-change"],setup(F,{emit:h}){const u=F,U=te(()=>u.sorting??[]),l=C([]),v=C({}),O=i=>typeof i=="function"?i([...U.value]):i??[],D=Wo({get data(){return u.data},get columns(){return u.columns},getCoreRowModel:Qo(),getSortedRowModel:Jo(),getFilteredRowModel:Xo(),onSortingChange:i=>{const a=O(i);K("sort-change",a)},onColumnFiltersChange:i=>Dt(i,l),onColumnVisibilityChange:i=>Dt(i,v),state:{get sorting(){return U.value},get columnFilters(){return l.value},get columnVisibility(){return v.value}}}),K=h,_=i=>{K("item-clicked",i)},b=C(null);let L=null;const x=()=>{u.isLoadingMore||u.isLoading||!u.hasMore||K("load-more")};return Ge(()=>{L=new IntersectionObserver(i=>{if(u.hasMore){for(const a of i)if(a.isIntersecting){x();break}}},{rootMargin:"128px 0px"})}),le(()=>b.value,i=>{L?.disconnect(),i&&u.hasMore&&L?.observe(i)},{immediate:!0}),le(()=>u.hasMore,i=>{L&&(L.disconnect(),i&&b.value&&L.observe(b.value))}),Io(()=>{L?.disconnect(),L=null}),(i,a)=>{const r=Go,E=qo,$=No,z=Ko,N=Ho,R=zo,X=ko,W=ft;return s(),I("div",dn,[e(W,{class:"h-[calc(100vh-125px)]"},{default:t(()=>[e(R,{class:"bg-white relative"},{default:t(()=>[e($,{class:"bg-gray-50 sticky top-0"},{default:t(()=>[(s(!0),I(ee,null,re(o(D).getHeaderGroups(),Y=>(s(),A(E,{key:Y.id},{default:t(()=>[(s(!0),I(ee,null,re(Y.headers,c=>(s(),A(r,{key:c.id},{default:t(()=>[c.isPlaceholder?H("",!0):(s(),A(o(St),{key:0,render:c.column.columnDef.header,props:c.getContext()},null,8,["render","props"]))]),_:2},1024))),128))]),_:2},1024))),128))]),_:1}),e(N,null,{default:t(()=>[u.isLoading&&!u.data.length?(s(),A(E,{key:0},{default:t(()=>[e(z,{colspan:u.columns.length,class:"text-left"},{default:t(()=>a[0]||(a[0]=[p(" Загрузка... ",-1)])),_:1,__:[0]},8,["colspan"])]),_:1})):o(D).getRowModel().rows?.length?(s(),I(ee,{key:1},[(s(!0),I(ee,null,re(o(D).getRowModel().rows,Y=>(s(),A(E,{key:Y.id,class:"cursor-pointer hover:bg-slate-300/50",onClick:c=>_(Y.original.operationId)},{default:t(()=>[(s(!0),I(ee,null,re(Y.getVisibleCells(),c=>(s(),A(z,{key:c.id},{default:t(()=>[e(o(St),{render:c.column.columnDef.cell,props:c.getContext()},null,8,["render","props"])]),_:2},1024))),128))]),_:2},1032,["onClick"]))),128)),u.isLoadingMore?(s(),A(E,{key:0},{default:t(()=>[e(z,{colspan:u.columns.length,class:"text-center"},{default:t(()=>a[1]||(a[1]=[p(" Догружаем... ",-1)])),_:1,__:[1]},8,["colspan"])]),_:1})):u.hasMore?(s(),A(E,{key:1},{default:t(()=>[e(z,{colspan:u.columns.length,class:"p-0"},{default:t(()=>[n("div",{ref_key:"loadMoreRef",ref:b,class:"h-6","aria-hidden":"true"},null,512)]),_:1},8,["colspan"])]),_:1})):H("",!0)],64)):(s(),A(E,{key:2},{default:t(()=>[e(z,{colspan:i.columns.length,class:"text-left"},{default:t(()=>a[2]||(a[2]=[p(" Нет результатов. ",-1)])),_:1,__:[2]},8,["colspan"])]),_:1}))]),_:1})]),_:1}),e(X,{orientation:"horizontal"})]),_:1})])}}});function pn(){const{$useApi:F}=ot(),h=F,u=C([]),U=C(!1),l=C(0);return{rules:u,rulesTotal:l,loading:U,fetchRules:async()=>{U.value=!0;try{const{data:x}=await h.get("auto-category-rules");let i=[];if(Array.isArray(x))i=x,l.value=x.length;else if(x&&typeof x=="object"&&"items"in x)Array.isArray(x.items)&&(i=x.items,l.value=typeof x.total=="number"?x.total:x.items.length);else if(x&&typeof x=="object"){for(const a in x)if(Array.isArray(x[a])){i=x[a],l.value=typeof x.total=="number"?x.total:x[a].length;break}}u.value=i}finally{U.value=!1}},fetchRule:async x=>{const{data:i}=await h.get(`auto-category-rules/${x}`);return i||null},createRule:async x=>{const{data:i}=await h.post("auto-category-rules",x);return i},updateRule:async(x,i)=>{const{data:a}=await h.patch(`auto-category-rules/${x}`,i);return a},deleteRule:async x=>{const{data:i}=await h.delete(`auto-category-rules/${x}`);return i},testRule:async(x,i=50,a=0)=>{const{data:r}=await h.post(`auto-category-rules/${x}/test`,{},{params:{take:i,skip:a}});return r},testRuleDraft:async(x,i=50,a=0)=>{const{data:r}=await h.post("auto-category-rules/test",x,{params:{take:i,skip:a}});return r}}}const mn={class:"hidden space-x-1 lg:flex"},fn={class:"flex-1 break-words whitespace-normal leading-relaxed"},vn={key:1,class:"flex items-center justify-center py-2 text-sm text-slate-500"},Ft=he({__name:"FilterPopover",props:{items:{},selectedIds:{},label:{},placeholder:{default:""},onLoadMore:{type:[Function,null],default:null},onSearch:{type:[Function,null],default:null},hasMore:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1}},emits:["update:selectedIds","clear"],setup(F,{emit:h}){const u=F,U=h,l=C(""),v=C(!1),O=C(null),D=te(()=>u.items.filter(a=>u.selectedIds.includes(a.id))),K=te(()=>u.items),_=a=>{const r=[...u.selectedIds],E=r.indexOf(a);E>-1?r.splice(E,1):r.push(a),U("update:selectedIds",r)},b=()=>{U("update:selectedIds",[]),U("clear")};let L=null;const x=a=>{L&&clearTimeout(L),L=setTimeout(()=>{u.onSearch&&u.onSearch(a||"")},300)};le(l,a=>{x(a)});const i=a=>{const r=a.target;if(!r||!O.value||!u.hasMore||u.isLoading)return;const $=O.value.getBoundingClientRect(),z=r.getBoundingClientRect();$.top<=z.bottom+100&&$.bottom>=z.top&&u.onLoadMore&&u.onLoadMore()};return le(v,a=>{a?_t(()=>{u.onSearch&&u.onSearch("")}):l.value=""}),Rt(()=>{L&&clearTimeout(L)}),(a,r)=>{const E=mt,$=Nt,z=ke,N=yt,R=bt,X=wt,W=Pt,Y=kt,c=It,k=Ct,w=ht,d=xt,m=gt;return s(),A(m,{open:v.value,"onUpdate:open":r[3]||(r[3]=M=>v.value=M)},{default:t(()=>[e(N,{"as-child":""},{default:t(()=>[e(z,{variant:"outline",size:"sm",class:"h-8 border-dashed"},{default:t(()=>[e(o(zt),{class:"mr-2 h-4 w-4"}),p(" "+B(a.label)+" ",1),a.selectedIds.length>0?(s(),I(ee,{key:0},[e(E,{orientation:"vertical",class:"mx-2 h-4"}),e($,{variant:"secondary",class:"rounded-sm px-1 font-normal lg:hidden"},{default:t(()=>[p(B(a.selectedIds.length),1)]),_:1}),n("div",mn,[a.selectedIds.length<=0?(s(!0),I(ee,{key:0},re(D.value,M=>(s(),A($,{key:M.id,variant:"secondary",class:"rounded-sm px-1 font-normal"},{default:t(()=>[p(B(M.title),1)]),_:2},1024))),128)):(s(),A($,{key:1,variant:"secondary",class:"rounded-sm px-1 font-normal"},{default:t(()=>[p(B(a.selectedIds.length),1)]),_:1})),e($,{variant:"destructive",class:"rounded-sm px-1 font-normal h-6 ml-1",onClick:r[0]||(r[0]=Se(()=>{b(),v.value=!1},["stop"]))},{default:t(()=>r[4]||(r[4]=[p(" x ",-1)])),_:1,__:[4]})])],64)):H("",!0)]),_:1})]),_:1}),e(d,{class:"w-[250px] p-0",align:"start"},{default:t(()=>[e(w,{"should-filter":!1},{default:t(()=>[e(R,{"model-value":l.value,placeholder:a.placeholder||a.label,"onUpdate:modelValue":r[1]||(r[1]=M=>{l.value=M}),onInput:r[2]||(r[2]=M=>{const Z=M.target;Z?.value!==void 0&&(l.value=Z.value)})},null,8,["model-value","placeholder"]),e(k,{class:"max-h-[300px]",onScroll:i},{default:t(()=>[e(X,null,{default:t(()=>r[5]||(r[5]=[p("Нет совпадений.",-1)])),_:1,__:[5]}),e(Y,null,{default:t(()=>[(s(!0),I(ee,null,re(K.value,M=>(s(),A(W,{key:M.id,value:M,class:"py-2",onSelect:Z=>_(M.id)},{default:t(()=>[n("div",{class:we(a.selectedIds.includes(M.id)?"mr-2 flex h-4 w-4 flex-shrink-0 items-center justify-center rounded-sm border border-primary bg-primary text-primary-foreground":"mr-2 flex h-4 w-4 flex-shrink-0 items-center justify-center rounded-sm border border-primary opacity-50 [&_svg]:invisible")},[e(o(Ht),{class:"h-4 w-4"})],2),n("span",fn,B(M.title),1)]),_:2},1032,["value","onSelect"]))),128)),a.hasMore&&!a.isLoading?(s(),I("div",{key:0,ref_key:"loadMoreRef",ref:O,class:"h-4"},null,512)):H("",!0),a.isLoading?(s(),I("div",vn," Загрузка... ")):H("",!0)]),_:1}),a.selectedIds.length>0?(s(),I(ee,{key:0},[e(c),e(Y,null,{default:t(()=>[e(W,{value:{label:"Очистить"},class:"justify-center text-center",onSelect:b},{default:t(()=>r[6]||(r[6]=[p(" Очистить ",-1)])),_:1,__:[6]})]),_:1})],64)):H("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["open"])}}}),_n={class:"grid grid-cols-3 grow min-h-0 gap-6"},gn={class:"space-y-3 border rounded-md p-3 flex flex-col min-h-0"},yn={class:"flex justify-between items-center"},xn={class:"flex-1 min-h-0 overflow-auto border rounded"},hn=["onClick"],bn={class:"flex items-center justify-between"},Cn={class:"font-medium truncate max-w-[220px]"},wn={class:"text-xs text-slate-500 flex gap-2"},kn={class:"space-y-4 flex flex-col min-h-0"},Pn={class:"flex-1 min-h-0 space-y-4"},In={class:"flex items-center justify-between"},$n={class:"relative flex-1 mr-3"},Un={class:"flex items-center gap-2"},Tn={class:"grid grid-cols-2 gap-3"},On={class:"relative"},Dn={class:"relative"},Sn={class:"relative"},Mn={class:"grid grid-cols-2 gap-3"},Vn={class:"relative col-span-2"},Fn={class:"flex gap-2 mt-1"},En={class:"flex flex-wrap gap-2 mt-2"},Rn=["onClick"],Ln={class:"relative"},An={class:"relative"},Bn={class:"relative"},jn={class:"flex justify-end gap-2"},zn={key:0},Nn={key:1},Gn={class:"space-y-4 flex flex-col min-h-0"},Hn={class:"border rounded-md p-3 space-y-3 flex-1 min-h-0 overflow-hidden flex flex-col"},Kn={class:"flex gap-2 justify-between items-center"},qn={key:0},Wn={key:1},Xn={key:0,class:"flex-1 min-h-0 h-full overflow-auto border rounded"},Jn={class:"w-full text-sm table-fixed"},Qn={class:"p-2"},Yn={class:"text-xs text-slate-500 mb-1"},Zn={key:0,class:"text-slate-400"},es={class:"font-semibold break-words whitespace-pre-wrap"},ts={class:"italic underline"},os=["innerHTML"],as={class:"p-2 whitespace-nowrap"},ns={key:1,class:"p-3 border-t bg-slate-50 text-sm text-slate-600"},ss=he({__name:"RuleModal",props:{isOpen:{type:Boolean},rule:{}},emits:["update:isOpen","saved","deleted"],setup(F,{emit:h}){const u=F,U=h,{rules:l,fetchRules:v,fetchRule:O,createRule:D,updateRule:K,deleteRule:_,testRule:b,testRuleDraft:L}=pn(),{accounts:x,counterPartiesFilters:i,counterPartiesFiltersPagination:a,isLoadingCounterParties:r,getAccounts:E,getCounterPartiesFilters:$,getExpenseCategoriesMini:z}=He(),N=C(!1),R=C(!1),X=C([]),W=C(null),Y=te(()=>l.value),c=C({enabled:!0,priority:100,name:"",description:"",keywords:[],operationType:"Debit",accountIds:[],counterPartyIds:[],expenseCategoryId:0}),k=te(()=>W.value!=null),w=C({take:50,skip:0}),d=C(null),m=te(()=>!c.value.name||!c.value.operationType||!c.value.expenseCategoryId?!1:Array.isArray(c.value.keywords)&&c.value.keywords.length>0),M=te(()=>{if(k.value)return!0;const g=Array.isArray(c.value.keywords)&&c.value.keywords.length>0,P=!!c.value.operationType;return g&&P}),Z=te({get:()=>c.value.expenseCategoryId?String(c.value.expenseCategoryId):"",set:g=>{c.value.expenseCategoryId=g?Number(g):0}}),S=async g=>{try{X.value=await z(g)}catch(P){console.error(P),se({variant:"destructive",title:"Ошибка",description:"Не удалось загрузить категории."})}},q=async()=>{await E()},ae=async g=>{await $(!0,g)},f=async()=>{await $(!1)},y=te(()=>x.value.map(g=>({id:Number(g.value),title:g.label}))),pe=te(()=>i.value.map(g=>({id:g.id,title:Ue(g.title)+" [..."+g.account.slice(-4)+"]"}))),de=()=>{c.value={enabled:!0,priority:100,name:"",description:"",keywords:[],operationType:"Debit",accountIds:[],counterPartyIds:[],expenseCategoryId:0},w.value={take:50,skip:0},d.value=null,W.value=null},ne=g=>{c.value={enabled:g.enabled,priority:g.priority,name:g.name,description:g.description||"",keywords:g.keywords||[],operationType:g.operationType,accountIds:g.accountIds||[],counterPartyIds:g.counterPartyIds||[],expenseCategoryId:g.expenseCategoryId}};le(()=>u.isOpen,async g=>{if(g){if(await v(),await S(c.value.operationType),await q(),await $(!0),u.rule&&u.rule.id!=null)try{const oe=await O(u.rule.id);oe&&(W.value=oe.id,ne(oe))}catch(oe){console.error(oe),de()}else de();await _t(),await new Promise(oe=>setTimeout(oe,200));let P=10;for(;l.value.length===0&&P>0;)await new Promise(oe=>setTimeout(oe,100)),P--;console.log("[RulesModal] After fetchRules:",{rulesCount:l.value.length})}else de()}),le(()=>c.value.operationType,async g=>{await S(g)});const _e=async()=>{if(!m.value){se({variant:"destructive",title:"Форма невалидна",description:"Проверьте обязательные поля."});return}N.value=!0;try{const g={enabled:c.value.enabled,priority:c.value.priority,name:c.value.name,description:c.value.description||"",keywords:c.value.keywords,operationType:c.value.operationType,accountIds:c.value.accountIds||[],counterPartyIds:c.value.counterPartyIds||[],expenseCategoryId:c.value.expenseCategoryId};let P;k.value&&W.value!=null?P=await K(W.value,g):P=await D(g),se({title:"Успех",description:"Правило сохранено."}),await v(),W.value=P.id,ne(P),U("saved",P)}catch(g){console.error(g),se({variant:"destructive",title:"Ошибка",description:g?.response?.data?.message||"Не удалось сохранить правило."})}finally{N.value=!1}},Q=async()=>{if(!(!k.value||W.value==null))try{const g=W.value;await _(g),se({title:"Удалено",description:"Правило удалено."}),await v(),U("deleted",g),de()}catch(g){console.error(g),se({variant:"destructive",title:"Ошибка",description:g?.response?.data?.message||"Не удалось удалить правило."})}},J=async()=>{R.value=!0,d.value=null;try{k.value&&W.value!=null?d.value=await b(W.value,w.value.take,w.value.skip):d.value=await L({operationType:c.value.operationType,keywords:c.value.keywords,accountIds:c.value.accountIds&&c.value.accountIds.length>0?c.value.accountIds:void 0,counterPartyIds:c.value.counterPartyIds&&c.value.counterPartyIds.length>0?c.value.counterPartyIds:void 0},w.value.take,w.value.skip)}catch(g){console.error(g),se({variant:"destructive",title:"Ошибка",description:g?.response?.data?.message||"Не удалось выполнить предпросмотр."})}finally{R.value=!1}},ge=()=>{U("update:isOpen",!1)},ye=C(""),Pe=()=>{const g=(ye.value||"").trim();if(!g)return;const P=g.split(",").map(Te=>Te.trim()).filter(Boolean);if(P.length===0)return;const oe=new Set([...c.value.keywords||[],...P]);c.value.keywords=Array.from(oe),ye.value=""},ie=(g,P)=>{c.value.keywords=(c.value.keywords||[]).filter(oe=>oe!==P)},Ie=g=>{W.value=g.id,ne(g)},ue=()=>{de()},Le=g=>g==="Debit"?"Списание":g==="Credit"?"Поступление":g,Ke=te(()=>k.value&&W.value!=null?l.value.find(P=>P.id===W.value)?.keywords||[]:c.value.keywords||[]),qe=(g,P)=>{if(!g||!P||P.length===0)return g.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;");const oe=P.filter(fe=>fe&&fe.trim()).map(fe=>fe.trim());if(oe.length===0)return g.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;");oe.sort((fe,Oe)=>Oe.length-fe.length);const Te=fe=>fe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;");let Ae=Te(g);return oe.forEach(fe=>{const be=Te(fe).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),We=new RegExp(`(${be})`,"gi");Ae=Ae.replace(We,'<span class="bg-green-200">$1</span>')}),Ae};return(g,P)=>{const oe=Ee,Te=Re,Ae=Fe,fe=ke,Oe=ze,be=Ne,We=Yo,at=Ze,Be=Ye,Xe=tt,Je=et,je=Qe,G=rt,V=Ve,me=Me;return s(),A(me,{open:g.isOpen,"onUpdate:open":P[11]||(P[11]=T=>U("update:isOpen",T))},{default:t(()=>[e(V,{class:"max-w-[1200px] h-[80vh] flex flex-col"},{default:t(()=>[e(Ae,null,{default:t(()=>[e(oe),e(Te)]),_:1}),n("div",_n,[n("div",gn,[n("div",yn,[P[13]||(P[13]=n("div",{class:"text-sm font-medium"},"Список правил",-1)),e(fe,{size:"sm",variant:"secondary",onClick:ue},{default:t(()=>P[12]||(P[12]=[p("Создать",-1)])),_:1,__:[12]})]),n("div",xn,[(s(!0),I(ee,null,re(Y.value,T=>(s(),I("div",{key:T.id,class:we(["p-2 border-b cursor-pointer hover:bg-slate-50",{"bg-slate-100":W.value===T.id}]),onClick:xe=>Ie(T)},[n("div",bn,[n("div",Cn,B(T.name),1),n("span",{class:we(["text-[10px] px-2 py-0.5 rounded",T.enabled?"bg-green-100 text-green-700":"bg-slate-100 text-slate-600"])},B(T.enabled?"on":"off"),3)]),n("div",wn,[n("span",null,"#"+B(T.id),1),n("span",null,"Приоритет: "+B(T.priority),1),n("span",null,B(Le(T.operationType)),1)])],10,hn))),128))])]),n("div",kn,[n("div",Pn,[n("div",In,[n("div",$n,[e(Oe,{modelValue:c.value.name,"onUpdate:modelValue":P[0]||(P[0]=T=>c.value.name=T),placeholder:"Название правила",class:we(c.value.name?"":"outline-1 outline-rose-300")},null,8,["modelValue","class"]),e(be,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>P[14]||(P[14]=[p("Название",-1)])),_:1,__:[14]})]),n("div",Un,[e(be,null,{default:t(()=>P[15]||(P[15]=[p("Включено",-1)])),_:1,__:[15]}),e(We,{checked:c.value.enabled,"onUpdate:checked":P[1]||(P[1]=T=>c.value.enabled=T)},null,8,["checked"])])]),n("div",Tn,[n("div",On,[e(Oe,{modelValue:c.value.priority,"onUpdate:modelValue":P[2]||(P[2]=T=>c.value.priority=T),modelModifiers:{number:!0},type:"number",placeholder:"Приоритет"},null,8,["modelValue"]),e(be,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>P[16]||(P[16]=[p("Приоритет",-1)])),_:1,__:[16]})]),n("div",Dn,[e(je,{modelValue:c.value.operationType,"onUpdate:modelValue":P[3]||(P[3]=T=>c.value.operationType=T)},{default:t(()=>[e(Be,null,{default:t(()=>[e(at,{placeholder:"Тип операции"})]),_:1}),e(Je,null,{default:t(()=>[e(Xe,{value:"Credit"},{default:t(()=>P[17]||(P[17]=[p("Поступление",-1)])),_:1,__:[17]}),e(Xe,{value:"Debit"},{default:t(()=>P[18]||(P[18]=[p("Списание",-1)])),_:1,__:[18]})]),_:1})]),_:1},8,["modelValue"]),e(be,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>P[19]||(P[19]=[p("Тип операции",-1)])),_:1,__:[19]})])]),n("div",Sn,[e(je,{modelValue:Z.value,"onUpdate:modelValue":P[4]||(P[4]=T=>Z.value=T)},{default:t(()=>[e(Be,null,{default:t(()=>[e(at,{placeholder:"Статья расходов/доходов"})]),_:1}),e(Je,null,{default:t(()=>[(s(!0),I(ee,null,re(X.value,T=>(s(),A(Xe,{key:T.id,value:String(T.id)},{default:t(()=>[p(B(T.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"]),e(be,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>P[20]||(P[20]=[p("Категория",-1)])),_:1,__:[20]})]),n("div",Mn,[n("div",Vn,[e(be,{class:"text-sm font-medium"},{default:t(()=>P[21]||(P[21]=[p("Ключевые слова",-1)])),_:1,__:[21]}),n("div",Fn,[e(Oe,{modelValue:ye.value,"onUpdate:modelValue":P[5]||(P[5]=T=>ye.value=T),placeholder:"слово, слово2, ...",onKeydown:$o(Se(Pe,["prevent"]),["enter"])},null,8,["modelValue","onKeydown"]),e(fe,{variant:"secondary",onClick:Pe},{default:t(()=>P[22]||(P[22]=[p("Добавить",-1)])),_:1,__:[22]})]),n("div",En,[(s(!0),I(ee,null,re(c.value.keywords,T=>(s(),I("span",{key:T,class:"px-2 py-1 bg-slate-100 rounded text-xs flex items-center gap-2"},[p(B(T)+" ",1),n("button",{class:"text-red-500",onClick:xe=>ie("keywords",T)}," x ",8,Rn)]))),128))])])]),n("div",Ln,[e(Ft,{items:y.value,"selected-ids":c.value.accountIds||[],label:"Счета",placeholder:"Поиск счетов...","has-more":!1,"is-loading":!1,"onUpdate:selectedIds":P[6]||(P[6]=T=>c.value.accountIds=T),onClear:P[7]||(P[7]=T=>c.value.accountIds=[])},null,8,["items","selected-ids"]),e(be,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>P[23]||(P[23]=[p("Счета",-1)])),_:1,__:[23]})]),n("div",An,[e(Ft,{items:pe.value,"selected-ids":c.value.counterPartyIds||[],label:"Контрагенты",placeholder:"Поиск контрагентов...","has-more":o(a).hasNext,"is-loading":o(r),"on-search":ae,"on-load-more":f,"onUpdate:selectedIds":P[8]||(P[8]=T=>c.value.counterPartyIds=T),onClear:P[9]||(P[9]=T=>c.value.counterPartyIds=[])},null,8,["items","selected-ids","has-more","is-loading"]),e(be,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>P[24]||(P[24]=[p("Контрагенты",-1)])),_:1,__:[24]})]),n("div",Bn,[e(G,{modelValue:c.value.description,"onUpdate:modelValue":P[10]||(P[10]=T=>c.value.description=T),placeholder:"Описание (необязательно)"},null,8,["modelValue"]),c.value.description?(s(),A(be,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1"},{default:t(()=>P[25]||(P[25]=[p("Описание",-1)])),_:1,__:[25]})):H("",!0)])]),n("div",jn,[e(fe,{variant:"outline",onClick:ge},{default:t(()=>P[26]||(P[26]=[p("Отмена",-1)])),_:1,__:[26]}),k.value?(s(),A(fe,{key:0,variant:"destructive",onClick:Q},{default:t(()=>P[27]||(P[27]=[p("Удалить",-1)])),_:1,__:[27]})):H("",!0),e(fe,{disabled:N.value||!m.value,onClick:_e},{default:t(()=>[N.value?(s(),I("span",zn,"Сохранение...")):(s(),I("span",Nn,B(k.value?"Сохранить":"Создать"),1))]),_:1},8,["disabled"])])]),n("div",Gn,[n("div",Hn,[n("div",Kn,[P[28]||(P[28]=n("div",{class:"text-sm font-medium"},"Совпадения",-1)),e(fe,{size:"sm",variant:"secondary",disabled:R.value||!M.value,onClick:J},{default:t(()=>[R.value?(s(),I("span",qn,"Тестируем...")):(s(),I("span",Wn,"Тестировать"))]),_:1},8,["disabled"])]),d.value?(s(),I("div",Xn,[n("table",Jn,[P[29]||(P[29]=n("thead",{class:"sticky top-0 z-10 bg-slate-50"},[n("tr",null,[n("th",{class:"text-left p-2 w-[70%]"},"Назначение"),n("th",{class:"text-left p-2 w-[30%]"},"Сумма")])],-1)),n("tbody",null,[(s(!0),I(ee,null,re(d.value.items,T=>(s(),I("tr",{key:T.id,class:"border-t"},[n("td",Qn,[n("div",Yn,[p(B(T.account?.name||"Счет не указан")+" ",1),T.account?.accountNumber?(s(),I("span",Zn," ("+B(T.account.accountNumber.slice(-4))+") ",1)):H("",!0)]),n("div",es,B(o(Ue)(T.counterPartyTitle||"Нет контрагента")),1),n("div",ts,[T.operationPositions&&T.operationPositions.length?(s(!0),I(ee,{key:0},re(T.operationPositions,(xe,ve)=>(s(),I("span",{key:ve,class:"mr-2"},B(xe.expenseCategory&&xe.expenseCategory.name||"Без категории"),1))),128)):(s(),I(ee,{key:1},[p(B(T.expenseCategoryName||"Без категории"),1)],64))]),n("div",{class:"text-slate-600 break-words whitespace-pre-wrap",innerHTML:qe(T.payPurpose,Ke.value)},null,8,os)]),n("td",as,[n("span",{class:we(T.typeOfOperation==="Debit"?"text-red-600":"text-green-600")},B((T.typeOfOperation==="Debit"?"-":"+")+Math.abs(T.accountAmount).toLocaleString("ru-RU")),3)])]))),128))])])])):H("",!0),d.value?(s(),I("div",ns," Всего совпадений: "+B(d.value.total),1)):H("",!0)])])])]),_:1})]),_:1},8,["open"])}}});function Xt(F){const h=new Date(F),u=h.getTimezoneOffset();return new Date(h.getTime()+u*6e4)}function ls(F){const h=F.getTimezoneOffset();return new Date(F.getTime()-h*6e4).toISOString()}function rs(F){const h=Xt(F),u=h.getDate().toString().padStart(2,"0"),U=(h.getMonth()+1).toString().padStart(2,"0"),l=h.getFullYear(),v=h.getHours().toString().padStart(2,"0"),O=h.getMinutes().toString().padStart(2,"0");return{date:`${u}.${U}.${l}`,time:`${v}:${O}`}}function is(F){const h=Xt(F),u=h.getFullYear(),U=String(h.getMonth()+1).padStart(2,"0"),l=String(h.getDate()).padStart(2,"0"),v=String(h.getHours()).padStart(2,"0"),O=String(h.getMinutes()).padStart(2,"0");return`${u}-${U}-${l}T${v}:${O}`}const us={class:"space-y-6"},ds={key:0,class:"space-y-2"},cs={key:1,class:"space-y-2"},ps={class:"flex justify-end gap-2 mt-6"},ms={key:0},fs={key:1},vs=he({__name:"CreateRuleModal",props:{isOpen:{type:Boolean},counterParty:{},operationType:{}},emits:["update:isOpen","rule-created"],setup(F,{emit:h}){const u=F,U=h,{getExpenseCategoriesMini:l,createCounterPartyRule:v}=He(),O=C(void 0),D=C(void 0),K=C([]),_=C([]),b=C(!1),L=te(()=>!u.operationType||u.operationType==="Credit"),x=te(()=>!u.operationType||u.operationType==="Debit"),i=te(()=>L.value&&x.value?O.value!==void 0||D.value!==void 0:L.value?O.value!==void 0:x.value?D.value!==void 0:!1),a=async()=>{if(!(!u.counterParty||!i.value)){b.value=!0;try{const N={counterPartyAccount:u.counterParty.counterPartyAccount};O.value!==void 0&&(N.incomeExpenseCategoryId=Number(O.value)),D.value!==void 0&&(N.outcomeExpenseCategoryId=Number(D.value)),await v(N),U("rule-created"),U("update:isOpen",!1),O.value=void 0,D.value=void 0}catch(N){console.error(N)}finally{b.value=!1}}},r=async N=>{try{if(N){if(N==="Credit"){const R=await l("Credit");K.value=R}else if(N==="Debit"){const R=await l("Debit");_.value=R}}else{const[R,X]=await Promise.all([l("Credit"),l("Debit")]);K.value=R,_.value=X}}catch(R){console.error(R)}},E=()=>{U("update:isOpen",!1),O.value=void 0,D.value=void 0},$=te(()=>K.value),z=te(()=>_.value);return le(()=>u.isOpen,async N=>{N&&await r(u.operationType)}),(N,R)=>{const X=Ee,W=Re,Y=Fe,c=Ne,k=Ze,w=Ye,d=tt,m=et,M=Qe,Z=ke,S=Ve,q=Me;return s(),A(q,{open:N.isOpen,"onUpdate:open":R[2]||(R[2]=ae=>U("update:isOpen",ae))},{default:t(()=>[e(S,{class:"max-w-[600px]"},{default:t(()=>[e(Y,null,{default:t(()=>[e(X,null,{default:t(()=>R[3]||(R[3]=[p("Присвоить статью контрагенту",-1)])),_:1,__:[3]}),e(W,null,{default:t(()=>[p(' Выберите категории для автоматического назначения операций контрагента "'+B(N.counterParty?.counterPartyTitle)+'" ',1)]),_:1})]),_:1}),n("div",us,[L.value?(s(),I("div",ds,[e(c,{class:"text-sm font-medium"},{default:t(()=>R[4]||(R[4]=[p("Категория для поступлений (Credit)",-1)])),_:1,__:[4]}),e(M,{modelValue:O.value,"onUpdate:modelValue":R[0]||(R[0]=ae=>O.value=ae)},{default:t(()=>[e(w,null,{default:t(()=>[e(k,{placeholder:"Выберите категорию для поступлений"})]),_:1}),e(m,null,{default:t(()=>[(s(!0),I(ee,null,re($.value,ae=>(s(),A(d,{key:ae.id,value:String(ae.id)},{default:t(()=>[p(B(ae.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])])):H("",!0),x.value?(s(),I("div",cs,[e(c,{class:"text-sm font-medium"},{default:t(()=>R[5]||(R[5]=[p("Категория для выплат (Debit)",-1)])),_:1,__:[5]}),e(M,{modelValue:D.value,"onUpdate:modelValue":R[1]||(R[1]=ae=>D.value=ae)},{default:t(()=>[e(w,null,{default:t(()=>[e(k,{placeholder:"Выберите категорию для выплат"})]),_:1}),e(m,null,{default:t(()=>[(s(!0),I(ee,null,re(z.value,ae=>(s(),A(d,{key:ae.id,value:String(ae.id)},{default:t(()=>[p(B(ae.name),1)]),_:2},1032,["value"]))),128))]),_:1})]),_:1},8,["modelValue"])])):H("",!0),R[6]||(R[6]=n("div",{class:"text-sm text-muted-foreground"},[n("p",null," После создания правила все операции этого контрагента будут автоматически распределяться по выбранным категориям. ")],-1))]),n("div",ps,[e(Z,{variant:"outline",disabled:b.value,onClick:E},{default:t(()=>R[7]||(R[7]=[p(" Отмена ",-1)])),_:1,__:[7]},8,["disabled"]),e(Z,{disabled:!i.value||b.value,onClick:a},{default:t(()=>[b.value?(s(),I("span",ms,"Создание...")):(s(),I("span",fs,"Создать правило"))]),_:1},8,["disabled"])])]),_:1})]),_:1},8,["open"])}}}),_s={class:"flex gap-2 min-h-[600px]"},gs={class:"space-y-5 min-w-[450px]"},ys={class:"relative"},xs={class:"relative"},hs={class:"relative"},bs={class:"relative"},Cs={class:"relative"},ws={key:0,class:"relative"},ks={class:"space-y-4 grow"},Ps={class:"flex gap-2"},Is={class:"relative flex-1 min-w-[100px] max-w-[100px]"},$s={class:"relative"},Us={class:"flex items-center gap-2"},Ts=["onClick"],Os={class:"relative grow"},Ds={class:"flex flex-col gap-3 mt-6"},Ss={class:"flex justify-end gap-2 mt-4"},Ms=he({__name:"OperationModal",props:{operation:{},isOpen:{type:Boolean}},emits:["update:isOpen","save","delete","refresh-operations"],setup(F,{emit:h}){const{counterPartiesFilters:u,counterPartiesFiltersPagination:U,isLoadingCounterParties:l,getCounterPartiesFilters:v,getExpenseCategoriesMini:O,updateOperationPositions:D,deleteOperation:K,removeCategoryFromPosition:_}=He(),b=F,L=C([]),x=te(()=>u.value.map(f=>({id:f.id,title:Ue(f.title)+" (..."+f.account.slice(-4)+")"}))),i=async f=>{try{const y=await O(f);L.value=y}catch(y){console.error(y)}},a=h,r=C({}),E=C({}),$=C(!1);le(()=>b.operation,f=>{f?(r.value={...f,operationPositions:f.operationPositions?.map(y=>({...y}))||[{amount:0,counterPartyId:null,expenseCategoryId:null}]},E.value={...f,operationPositions:f.operationPositions?.map(y=>({...y}))||[{amount:0,counterPartyId:null,expenseCategoryId:null}]}):(r.value={operationPositions:[{amount:0,counterPartyId:null,expenseCategoryId:null,operationId:b.operation.id}],accountAmount:0,counterPartyTitle:"",typeOfOperation:"Credit"},E.value={operationPositions:[{amount:0,counterPartyId:null,expenseCategoryId:null,operationId:b.operation.id}],accountAmount:0,counterPartyTitle:"",typeOfOperation:"Credit"})},{immediate:!0});const z=te(()=>JSON.stringify(r.value)!==JSON.stringify(E.value)),N=C(0),R=te({get:()=>r.value.operationDate?is(r.value.operationDate):"",set:f=>{if(f){const y=new Date(f);r.value.operationDate=ls(y)}}}),X=te(()=>r.value.operationPositions&&r.value.operationPositions?.length>0&&r.value.operationPositions.every(f=>f.amount>0&&f.counterPartyId&&f.expenseCategoryId)),W=()=>{r.value={...E.value,operationPositions:E.value.operationPositions?.map(f=>({...f}))||[{amount:0,counterPartyId:null,expenseCategoryId:null,operationId:b.operation.id}]},a("update:isOpen",!1)},Y=async()=>{if(r.value&&r.value.operationId)try{r.value.operationPositions&&r.value.operationPositions.length>0&&await D(r.value.operationId,r.value.operationPositions.map(f=>({counterPartyId:f.counterPartyId||null,expenseCategoryId:f.expenseCategoryId||null,amount:f.amount||0}))),a("save",b.operation),a("update:isOpen",!1),se({title:"Успех",description:"Позиции операции успешно обновлены."})}catch(f){console.error(f)}else se({variant:"destructive",title:"Ошибка",description:"Не удалось сохранить позиции операции."})},c=async()=>{if(r.value?.operationId)try{await K(r.value.operationId),a("delete"),a("update:isOpen",!1),a("refresh-operations")}catch(f){console.error(f)}},k=()=>{r.value.operationPositions=[...r.value.operationPositions||[],{amount:0,counterPartyId:null,expenseCategoryId:null,operationId:b.operation.id}]},w=f=>{r.value.operationPositions&&r.value.operationPositions.length>1?r.value.operationPositions.splice(f,1):se({variant:"destructive",title:"Ошибка",description:"Нельзя удалить последнюю позицию."})},d=async f=>{if(f)try{await _(f);const y=r.value.operationPositions?.find(pe=>pe.id===f);y&&(y.expenseCategoryId=null)}catch(y){console.error(y)}},m=()=>{se({title:"Успех",description:"Контрагент добавлен в список."})},M=te(()=>({counterPartyAccount:r.value.counterPartyAccount||"",counterPartyTitle:r.value.counterPartyTitle||""})),Z=te(()=>!!(r.value.counterPartyTitle&&r.value.counterPartyAccount)),S=()=>{se({title:"Успех",description:"Правило создано. Операции контрагента будут автоматически распределяться."}),a("refresh-operations")};Ge(async()=>{N.value=b.operation.operationPositions.reduce((f,y)=>f+y.amount,0),b.operation&&await i(b.operation.typeOfOperation)}),le(b,f=>{f.isOpen||W()}),le(r,f=>{N.value=f.operationPositions?f.operationPositions.reduce((y,pe)=>y+pe.amount,0):0},{deep:!0});const q=async f=>{await v(!0,f)},ae=async()=>{await v(!1)};return le([()=>b.isOpen,()=>b.operation],async([f,y])=>{f&&y&&await i(y.typeOfOperation)}),(f,y)=>{const pe=Ee,de=Re,ne=Fe,_e=ze,Q=Ne,J=Ze,ge=Ye,ye=tt,Pe=et,ie=Qe,Ie=rt,ue=ke,Le=it,Ke=Ve,qe=Me;return s(),A(qe,{open:f.isOpen,"onUpdate:open":y[8]||(y[8]=g=>a("update:isOpen",g))},{default:t(()=>[e(Ke,{class:"max-w-[1200px]"},{default:t(()=>[e(ne,null,{default:t(()=>[e(pe,null,{default:t(()=>y[9]||(y[9]=[p("Редактирование операции",-1)])),_:1,__:[9]}),e(de)]),_:1}),n("div",_s,[n("div",gs,[n("div",ys,[e(_e,{modelValue:R.value,"onUpdate:modelValue":y[0]||(y[0]=g=>R.value=g),type:"datetime-local",placeholder:"Дата операции",disabled:f.operation.account.isReal,class:we(r.value.operationDate?"":"outline-1 outline-rose-300")},null,8,["modelValue","disabled","class"]),e(Q,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>y[10]||(y[10]=[p(" Дата операции ",-1)])),_:1,__:[10]})]),n("div",xs,[e(ie,{modelValue:r.value.typeOfOperation,"onUpdate:modelValue":y[1]||(y[1]=g=>r.value.typeOfOperation=g),disabled:f.operation.account.isReal},{default:t(()=>[e(ge,null,{default:t(()=>[e(J,{placeholder:"Выберите тип операции"})]),_:1}),e(Pe,null,{default:t(()=>[e(ye,{value:"Debit"},{default:t(()=>y[11]||(y[11]=[p("Выплата",-1)])),_:1,__:[11]}),e(ye,{value:"Credit"},{default:t(()=>y[12]||(y[12]=[p("Поступление",-1)])),_:1,__:[12]})]),_:1})]),_:1},8,["modelValue","disabled"]),e(Q,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>y[13]||(y[13]=[p(" Тип операции ",-1)])),_:1,__:[13]})]),n("div",hs,[e(_e,{modelValue:r.value.counterPartyTitle,"onUpdate:modelValue":[y[2]||(y[2]=g=>r.value.counterPartyTitle=g),y[3]||(y[3]=g=>r.value.counterPartyTitle=o(Ue)(String(g)))],placeholder:"Контрагент",disabled:f.operation.account.isReal,class:"text-right truncate",style:{"text-overflow":"ellipsis","white-space":"nowrap",direction:"rtl","text-align":"left"}},null,8,["modelValue","disabled"]),r.value.counterPartyTitle?(s(),A(Q,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>y[14]||(y[14]=[p(" Контрагент ",-1)])),_:1,__:[14]})):H("",!0)]),n("div",bs,[e(Ie,{modelValue:r.value.payPurpose,"onUpdate:modelValue":y[4]||(y[4]=g=>r.value.payPurpose=g),placeholder:"Назначение платежа",disabled:f.operation.account.isReal},null,8,["modelValue","disabled"]),r.value.payPurpose?(s(),A(Q,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>y[15]||(y[15]=[p(" Назначение платежа ",-1)])),_:1,__:[15]})):H("",!0)]),n("div",Cs,[e(_e,{modelValue:r.value.accountAmount,"onUpdate:modelValue":y[5]||(y[5]=g=>r.value.accountAmount=g),type:"number",placeholder:"Сумма",disabled:f.operation.account.isReal},null,8,["modelValue","disabled"]),r.value.accountAmount?(s(),A(Q,{key:0,class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>y[16]||(y[16]=[p(" Сумма ",-1)])),_:1,__:[16]})):H("",!0)]),Z.value?(s(),I("div",ws,[e(ue,{variant:"outline",class:"w-full",onClick:y[6]||(y[6]=g=>$.value=!0)},{default:t(()=>y[17]||(y[17]=[p(" Присвоить статью контрагенту ",-1)])),_:1,__:[17]})])):H("",!0),e(vs,{"is-open":$.value,"counter-party":M.value,"operation-type":r.value.typeOfOperation,"onUpdate:isOpen":y[7]||(y[7]=g=>$.value=g),onRuleCreated:S},null,8,["is-open","counter-party","operation-type"])]),n("div",ks,[n("div",Ps,[e(qt,{onCounterpartyCreated:m})]),(s(!0),I(ee,null,re(r.value.operationPositions,(g,P)=>(s(),I("div",{key:P,class:"flex gap-2 items-center"},[n("div",Is,[e(_e,{modelValue:g.amount,"onUpdate:modelValue":oe=>g.amount=oe,modelModifiers:{number:!0},type:"number",placeholder:"Сумма",class:we(g.amount>0?"":"outline-1 outline-rose-300")},null,8,["modelValue","onUpdate:modelValue","class"]),e(Q,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>y[18]||(y[18]=[p(" Сумма ",-1)])),_:1,__:[18]})]),n("div",$s,[e(Q,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>y[19]||(y[19]=[p(" Статья ",-1)])),_:1,__:[19]}),n("div",Us,[e(Le,{class:"min-w-[200px] w-[200px] overflow-hidden",items:L.value.map(oe=>({value:oe.id,label:oe.name})),label:L.value.find(oe=>oe.id===g.expenseCategoryId)?.name??"Выбрать","model-value":g.expenseCategoryId,onSelectedItem:oe=>g.expenseCategoryId=oe},null,8,["items","label","model-value","onSelectedItem"]),g.expenseCategoryId&&g.id?(s(),I("button",{key:0,class:"flex-shrink-0 p-1 text-red-500 hover:text-red-700 hover:bg-red-50 rounded",title:"Удалить категорию",onClick:oe=>d(g.id)},y[20]||(y[20]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)]),8,Ts)):H("",!0)])]),n("div",Os,[e(Q,{class:"font-medium text-slate-400 absolute left-2 top-[-13px] bg-white rounded-md p-1 whitespace-nowrap"},{default:t(()=>y[21]||(y[21]=[p(" Контрагент ",-1)])),_:1,__:[21]}),e(Wt,{items:x.value,"selected-id":g.counterPartyId,label:g.counterPartyId?o(Ue)(g.counterParty?.title??"")??"":"Выберите контрагента",placeholder:"Поиск контрагента...","has-more":o(U).hasNext,"is-loading":o(l),"on-search":q,"on-load-more":ae,"onUpdate:selectedId":oe=>g.counterPartyId=oe},null,8,["items","selected-id","label","has-more","is-loading","onUpdate:selectedId"])]),e(ue,{variant:"destructive",disabled:r.value.operationPositions?.length===1,onClick:oe=>w(P)},{default:t(()=>y[22]||(y[22]=[p(" X ",-1)])),_:2,__:[22]},1032,["disabled","onClick"])]))),128)),n("div",Ds,[e(ue,{class:"ml-auto",onClick:k},{default:t(()=>y[23]||(y[23]=[p("Добавить позицию",-1)])),_:1,__:[23]})])])]),n("div",Ss,[e(ue,{variant:"destructive",class:"mr-auto",onClick:c},{default:t(()=>y[24]||(y[24]=[p("Удалить",-1)])),_:1,__:[24]}),e(ue,{variant:"outline",onClick:W},{default:t(()=>y[25]||(y[25]=[p("Отмена",-1)])),_:1,__:[25]}),e(ue,{disabled:!z.value||!X.value,onClick:Y},{default:t(()=>y[26]||(y[26]=[p("Сохранить",-1)])),_:1,__:[26]},8,["disabled"])])]),_:1})]),_:1},8,["open"])}}}),Vs={class:"flex items-center gap-2 pt-1.5 pl-2 border-t border-l border-slate-200 rounded-xs transition-colors"},Fs={style:{paddingLeft:"10px"},class:"flex items-center gap-2 flex-1 min-w-0 w-full"},Es={class:"flex items-center gap-2 flex-1 min-w-0 w-full"},Rs={class:"text-sm font-medium truncate"},Ls={class:"w-4 h-4 flex items-center justify-center flex-shrink-0 border border-slate-300 rounded"},As={key:1,class:"flex items-center gap-2 flex-1 min-w-0 w-full"},Bs={class:"text-sm font-medium truncate flex-1"},Jt=he({__name:"CategoryItem",props:{category:{},level:{}},emits:["edit","create"],setup(F,{emit:h}){const u=F,U=jt("collapseState",{isAllCollapsed:C(!1),toggleAll:()=>{}}),l=C(!0),v=te(()=>u.category.children&&u.category.children.length>0);le(()=>U.isAllCollapsed.value,_=>{v.value&&(l.value=!_)},{immediate:!0});const O=h,D=()=>{O("edit",u.category)},K=()=>{O("create",u.category)};return(_,b)=>{const L=ta,x=ke,i=na,a=la,r=sa,E=aa,$=Jt,z=oa,N=ea;return s(),I("div",Vs,[n("div",Fs,[o(v)?(s(),A(N,{key:0,open:o(l),"onUpdate:open":b[3]||(b[3]=R=>Ce(l)?l.value=R:null),class:"flex-1 w-full"},{default:t(()=>[n("div",Es,[e(L,{class:"flex items-center gap-2 flex-1 min-w-0 rounded px-1 py-0.5 -ml-1"},{default:t(()=>[n("span",Rs,B(_.category.name),1),n("div",Ls,[o(l)?(s(),A(o(ca),{key:1,class:"w-2.5 h-2.5 text-slate-600"})):(s(),A(o(pa),{key:0,class:"w-2.5 h-2.5 text-slate-600"}))])]),_:1}),e(E,null,{default:t(()=>[e(i,{"as-child":"",class:"cursor-pointer"},{default:t(()=>[e(x,{variant:"ghost",size:"icon",class:"h-6 w-6 hover:bg-slate-100 rounded flex-shrink-0 cursor-pointer",onClick:b[0]||(b[0]=Se(()=>{},["stop"]))},{default:t(()=>[e(o(Mt),{class:"w-4 h-4 text-slate-400"})]),_:1})]),_:1}),e(r,null,{default:t(()=>[e(a,{class:"cursor-pointer",onClick:Se(D,["stop"])},{default:t(()=>b[5]||(b[5]=[p(" Изменить ",-1)])),_:1,__:[5]}),e(a,{class:"cursor-pointer",onClick:Se(K,["stop"])},{default:t(()=>b[6]||(b[6]=[p(" Создать статью ",-1)])),_:1,__:[6]})]),_:1})]),_:1})]),e(z,{class:"pl-0"},{default:t(()=>[(s(!0),I(ee,null,re(_.category.children,R=>(s(),A($,{key:R.id,category:R,level:(u.level||0)+1,onCreate:b[1]||(b[1]=X=>O("create",X)),onEdit:b[2]||(b[2]=X=>O("edit",X))},null,8,["category","level"]))),128))]),_:1})]),_:1},8,["open"])):(s(),I("div",As,[n("span",Bs,B(_.category.name),1),e(E,null,{default:t(()=>[e(i,{"as-child":""},{default:t(()=>[e(x,{variant:"ghost",size:"icon",class:"h-6 w-6 hover:bg-slate-100 rounded flex-shrink-0 cursor-pointer",onClick:b[4]||(b[4]=Se(()=>{},["stop"]))},{default:t(()=>[e(o(Mt),{class:"w-4 h-4 text-slate-400"})]),_:1})]),_:1}),e(r,null,{default:t(()=>[e(a,{class:"cursor-pointer",onClick:Se(D,["stop"])},{default:t(()=>b[7]||(b[7]=[p(" Изменить ",-1)])),_:1,__:[7]}),e(a,{class:"cursor-pointer",onClick:Se(K,["stop"])},{default:t(()=>b[8]||(b[8]=[p(" Создать статью ",-1)])),_:1,__:[8]})]),_:1})]),_:1})]))])])}}}),js={class:"flex-1 min-h-0 overflow-hidden flex flex-col"},zs={class:"flex-1 min-h-0 overflow-hidden mt-4"},Ns={class:"mb-4 flex justify-between items-center"},Gs={key:0,class:"text-sm text-slate-500 text-center py-8"},Hs={key:1,class:"text-sm text-slate-500 text-center py-8"},Ks={key:2,class:"flex flex-col gap-1"},qs=he({__name:"CategoriesListModal",props:{isOpen:{type:Boolean}},emits:["update:isOpen"],setup(F,{emit:h}){const u=F,U=h,{$useApi:l}=ot(),v=l,O=te({get:()=>u.isOpen,set:c=>U("update:isOpen",c)}),D=C({}),K=C(!1),_=C(""),b=C(!1),L=C(!1),x=C(null),i=Uo({}),a=C(!1),r=C(null);Lt("collapseState",{isAllCollapsed:b,toggleAll:()=>{b.value=!b.value}}),le(O,async c=>{c&&(await Y(),b.value=!1)});const E=()=>{b.value=!b.value},$=c=>{x.value=c,L.value=!0},z=c=>{r.value=c,a.value=!0},N=c=>[...c].sort((k,w)=>{const d=k.name.toLowerCase(),m=w.name.toLowerCase();return d.localeCompare(m,"ru")}),R=(c,k)=>{const w=D.value[k]||[],d=c.parentId??null,m=(M,Z,S)=>{for(let q=0;q<M.length;q++){if(M[q].id===Z)return M[q].children||(M[q].children=[]),M[q].children.push({...S,children:[]}),!0;const ae=M[q].children;if(ae&&ae.length>0&&m(ae,Z,S))return!0}return!1};d==null?w.push({...c,children:[]}):m(w,d,c)||w.push({...c,children:[]}),D.value[k]=N(w),D.value={...D.value}},X=(c,k)=>{const w=D.value[k]||[],d=(m,M,Z)=>{for(let S=0;S<m.length;S++){if(m[S].id===M){const ae=m[S].parentId,f=Z.parentId??null;if(Object.assign(m[S],{...Z,children:m[S].children||[]}),ae!==f){const y={...m[S]};if(m.splice(S,1),f==null)w.push(y);else{const pe=(de,ne,_e)=>{for(let Q=0;Q<de.length;Q++){if(de[Q].id===ne)return de[Q].children||(de[Q].children=[]),de[Q].children.push(_e),!0;const J=de[Q].children;if(J&&J.length>0&&pe(J,ne,_e))return!0}return!1};pe(w,f,y)}}return!0}const q=m[S].children;if(q&&q.length>0&&d(q,M,Z))return!0}return!1};d(w,c.id,c),D.value[k]=N(w),D.value={...D.value}},W=(c,k)=>{const w=D.value[c]||[],d=(m,M)=>{const Z=[];return m.forEach(S=>{M&&S.id===M||(Z.push({id:S.id,name:S.name}),S.children&&S.children.length>0&&Z.push(...d(S.children,M)))}),Z};return d(w,k)},Y=async()=>{K.value=!0;try{const{data:c}=await v.get("planfact/expense-categories-list"),k={};for(const[w,d]of Object.entries(c))k[w]=N(d);if(D.value=k,!_.value){const w=Object.keys(k)[0];w&&(_.value=w)}}catch(c){console.error("Ошибка загрузки категорий:",c)}finally{K.value=!1}};return(c,k)=>{const w=Ee,d=Re,m=Fe,M=lt,Z=st,S=ke,q=Jt,ae=ft,f=Et,y=nt,pe=Zo,de=Ve,ne=Kt,_e=Me;return s(),A(_e,{open:o(O),"onUpdate:open":k[7]||(k[7]=Q=>Ce(O)?O.value=Q:null)},{default:t(()=>[e(de,{class:"max-w-[800px] h-[95vh] flex flex-col"},{default:t(()=>[e(m,{class:"flex-shrink-0"},{default:t(()=>[e(w,null,{default:t(()=>k[8]||(k[8]=[p("Список статей",-1)])),_:1,__:[8]}),e(d)]),_:1}),n("div",js,[e(y,{modelValue:o(_),"onUpdate:modelValue":k[0]||(k[0]=Q=>Ce(_)?_.value=Q:null),class:"flex flex-col flex-1 min-h-0"},{default:t(()=>[e(Z,{class:"grid w-full flex-shrink-0",style:To({gridTemplateColumns:`repeat(${Object.keys(o(D)).length}, 1fr)`})},{default:t(()=>[(s(!0),I(ee,null,re(o(D),(Q,J)=>(s(),A(M,{key:J,value:J},{default:t(()=>[p(B(J),1)]),_:2},1032,["value"]))),128))]),_:1},8,["style"]),n("div",zs,[(s(!0),I(ee,null,re(o(D),(Q,J)=>(s(),A(f,{key:J,value:J,class:"h-full mt-0"},{default:t(()=>[e(ae,{class:"h-full pr-4"},{default:t(()=>[n("div",Ns,[e(S,{variant:"secondary",onClick:ge=>o(i)[J]=!0},{default:t(()=>k[9]||(k[9]=[p(" Создать статью ",-1)])),_:2,__:[9]},1032,["onClick"]),e(S,{variant:"ghost",class:"text-xs text-neutral-500",onClick:E},{default:t(()=>[p(B(o(b)?"Развернуть все":"Свернуть все"),1)]),_:1})]),o(K)?(s(),I("div",Gs," Загрузка... ")):Q.length===0?(s(),I("div",Hs," Нет данных ")):(s(),I("div",Ks,[(s(!0),I(ee,null,re(Q,ge=>(s(),A(q,{key:ge.id,category:ge,level:0,onCreate:$,onEdit:z},null,8,["category"]))),128))]))]),_:2},1024)]),_:2},1032,["value"]))),128))])]),_:1},8,["modelValue"])]),e(pe)]),_:1}),o(x)&&o(_)?(s(),A(ne,{key:0,type:o(_),parent:{id:o(x).id,name:o(x).name},"expense-categories":W(o(_)),"is-open":o(L),"onUpdate:isOpen":k[1]||(k[1]=Q=>L.value=Q),onCategoryCreated:k[2]||(k[2]=Q=>{o(x)&&o(_)&&(R(Q,o(_)),L.value=!1,x.value=null)}),onError:k[3]||(k[3]=()=>{Y()})},null,8,["type","parent","expense-categories","is-open"])):H("",!0),(s(!0),I(ee,null,re(o(D),(Q,J)=>(s(),I(ee,{key:J},[o(i)[J]?(s(),A(ne,{key:0,type:J,"expense-categories":W(J),"is-open":!!o(i)[J],"onUpdate:isOpen":ge=>o(i)[J]=ge,onCategoryCreated:ge=>{R(ge,J),o(i)[J]=!1},onError:Y},null,8,["type","expense-categories","is-open","onUpdate:isOpen","onCategoryCreated"])):H("",!0)],64))),128)),o(r)&&o(_)?(s(),A(ne,{key:1,category:o(r),type:o(_),"expense-categories":W(o(_),o(r).id),"is-open":o(a),"onUpdate:isOpen":k[4]||(k[4]=Q=>a.value=Q),onCategoryUpdated:k[5]||(k[5]=Q=>{o(r)&&o(_)&&(X(Q,o(_)),a.value=!1,r.value=null)}),onError:k[6]||(k[6]=()=>{Y()})},null,8,["category","type","expense-categories","is-open"])):H("",!0)]),_:1},8,["open"])}}}),Ws=[{accessorKey:"operationDate",ruName:"Дата",header:()=>ce("div",{class:"text-center"},"Дата"),cell:({row:F})=>{const h=F.getValue("operationDate"),{date:u,time:U}=rs(h);return ce("div",{class:"text-center flex flex-col"},[ce("div",{class:"text-neutral-700"},u),ce("div",{class:"text-xs text-neutral-500"},U)])}},{accessorKey:"typeOfOperation",ruName:"Тип",size:200,minSize:200,maxSize:200,header:()=>ce("div",{class:"text-center"},"Тип"),cell:({row:F})=>{const h=F.getValue("typeOfOperation"),u=F.getValue("category"),U=F.original,v=U.isTransferOperation===!0?"text-slate-500":h==="Debit"?"text-red-500":"text-green-600",O=(b,L)=>{if(!b)return L==="Debit"?"Выплата":"Поступление";const x={cardOperation:"Оплата картой",cashOut:"Снятие наличных",fee:"Услуги банка",penalty:"Штрафы",contragentPeople:"Исходящие платежи",selfIncomeOuter:"Перевод себе в другой банк",selfTransferOuter:"Перевод между своими счетами в T‑Бизнесе",salary:"Выплаты",contragentOutcome:"Перевод контрагенту",contragentRefund:"Возврат контрагенту",budget:"Платежи в бюджет",tax:"Налоговые платежи",creditPaymentOuter:"Погашение кредита","sme-c2c":"С карты на карту",otherOut:"Другое",unspecifiedOut:"Без категории"},i={incomePeople:"Входящие платежи",selfTransferInner:"Перевод между своими счетами в T‑Бизнесе",selfOutcomeOuter:"Перевод себе из другого банка",contragentIncome:"Пополнение от контрагента",acquiring:"Эквайринг",acquiringPos:"Торговый эквайринг",acquiringInternet:"Интернет‑эквайринг",incomeLoan:"Получение кредита",refundIn:"Возврат средств",cashIn:"Взнос наличных",cashInRevenue:"Взнос выручки из кассы",cashInOwn:"Взнос собственных средств",income:"Проценты на остаток по счету",depositPartWithdrawal:"Частичное изъятие средств депозита",depositFullWithdrawal:"Закрытие депозитного счета ЮЛ",creditPaymentInner:"Погашение кредита",otherIn:"Другое",unspecifiedIn:"Без категории"};return L==="Debit"?x[b]||b:L==="Credit"&&i[b]||b},K=U._isGrouped===!0?"Перемещение":O(u,h),_=U.account?.name||"";return ce("div",{class:`text-center ${v} text-wrap break-words flex flex-col justify-center items-center gap-1`},[_?ce("div",{class:"text-xs text-neutral-500 font-normal"},_):null,ce("div",{},K)].filter(Boolean))},filterFn:(F,h,u)=>u.includes(F.getValue(h))},{accessorKey:"category",ruName:"Категория",header:()=>ce("div",{class:"hidden"},""),cell:()=>ce("div",{class:"hidden"},""),filterFn:(F,h,u)=>F.getValue(h)?.toLowerCase().includes(u.toLowerCase())||!1},{accessorKey:"account",ruName:"Счет",header:()=>ce("div",{class:"hidden"},""),cell:()=>ce("div",{class:"hidden"},"")},{accessorKey:"operationPositions",ruName:"Контрагент",size:300,minSize:200,maxSize:400,header:()=>ce("div",{class:"text-center"},"Контрагент"),cell:({row:F})=>{const h=F.getValue("operationPositions");if(!h||h.length===0)return ce("div",{class:"text-center text-wrap"},"");const u=h.map(U=>U.counterParty?.title).filter(Boolean).map(U=>Ue(U)).filter((U,l,v)=>v.indexOf(U)===l);return ce("div",{class:"flex flex-col gap-1 items-center justify-center max-w-[300px] text-wrap break-words text-center"},u.map(U=>ce("span",{class:"break-words text-center"},U)))},filterFn:(F,h,u)=>{const U=F.getValue(h);return U?U.map(v=>v.counterParty?.title).filter(Boolean).some(v=>u.includes(v)):!1}},{accessorKey:"payPurpose",ruName:"Назначение",header:()=>ce("div",{class:"text-center"},"Назначение"),cell:({row:F})=>{const h=F.getValue("payPurpose"),U=F.getValue("operationPositions")?.map(l=>l.expenseCategory?.name).filter(Boolean).filter((l,v,O)=>O.indexOf(l)===v)||[];return ce("div",{class:"text-left  text-wrap"},[ce("div",{class:"font-bold text-sm mb-1"},U.join(", ")),ce("div",{class:"text-sm"},h||"")])},filterFn:(F,h,u)=>{const U=F.getValue(h),v=F.getValue("operationPositions")?.map(D=>D.expenseCategory?.name).filter(Boolean).filter((D,K,_)=>_.indexOf(D)===K)||[];return[U,...v].join(" ").toLowerCase().includes(u.toLowerCase())}},{accessorKey:"accountAmount",ruName:"Сумма",header:()=>ce("div",{class:"text-center"},"Сумма"),cell:({row:F})=>{const h=F.getValue("typeOfOperation"),u=F.getValue("accountAmount"),l=F.original.isTransferOperation===!0,v=l?"text-slate-500":h==="Debit"?"text-red-500":"text-green-600",D=`${l?"±":h==="Debit"?"-":"+"}${u} ₽`;return ce("div",{class:`text-center font-semibold ${v}`},D)},filterFn:(F,h,u)=>{const U=F.getValue(h),[l,v]=u;return U>=l&&U<=v}}],Xs={class:"w-full"},Js={class:"mt-2 flex gap-4"},Qs={class:"flex flex-col gap-2"},Ys={class:"flex items-center gap-2"},Zs={class:"w-[250px] min-w-[250px]"},el={class:"p-1 w-full"},tl={key:0,class:"absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center rounded-lg"},ol={class:"mb-2 flex-shrink-0"},al={class:"p-1 rounded-md"},nl={class:"flex items-center gap-2"},sl=["onClick"],ll={class:"flex gap-1 items-end flex-col flex-shrink-0"},rl=["onClick"],il=["onClick"],ul=["onClick"],dl={key:0,class:"text-sm text-slate-400 text-center py-4"},cl={class:"mb-2 flex-shrink-0"},pl={class:"p-1 rounded-md"},ml={class:"flex items-center gap-2"},fl=["onClick"],vl={class:"flex gap-1 items-end flex-col flex-shrink-0"},_l={key:0,class:"text-xs font-semibold whitespace-nowrap text-green-600"},gl=["onClick"],yl=["onClick"],xl=["onClick"],hl={key:2,class:"text-xs font-semibold whitespace-nowrap text-red-500"},bl=["onClick"],Cl=["onClick"],wl={key:0,class:"text-sm text-slate-400 text-center py-4"},kl={class:"flex gap-1 items-end flex-col flex-shrink-0 w-full"},Pl={class:"text-xs font-semibold whitespace-nowrap text-green-600"},Il={key:0,class:"text-xs font-semibold whitespace-nowrap text-slate-500"},$l={class:"text-xs font-semibold whitespace-nowrap text-red-500"},Ul={class:"text-xs font-bold whitespace-nowrap"},Tl={class:"text-xs font-bold whitespace-nowrap"},Ol={class:"text-xs font-semibold whitespace-nowrap text-orange-600"},Dl={class:"flex flex-col flex-1 relative"},Sl={class:"flex gap-1 items-center mb-2"},Ml={class:"relative max-w-[200px]"},Vl={class:"flex gap-1 items-center"},Fl={class:"flex justify-between mb-1 mt-[-40px]"},El={class:"ml-auto"},Rl={class:"relative"},Ll={key:0,class:"absolute inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center rounded-lg"},Al={class:"flex flex-col gap-2 mt-4"},Bl={class:"flex flex-col gap-1"},jl={class:"font-semibold"},zl={class:"text-sm text-slate-500"},Nl={key:0,class:"text-xs text-slate-400 truncate"},Or=he({__name:"index",setup(F){Oo({title:"Операции | Easy CRM"});const{accounts:h,counterPartiesFilters:u,expenseCategoriesFilters:U,operationsData:l,operationsTotals:v,pagination:O,isLoadingMore:D,isLoadingOperations:K,isLoadingTotals:_,isLoadingCounterParties:b,counterPartiesFiltersPagination:L,counterPartiesFiltersSearchTerm:x,getAccounts:i,getCounterPartiesFilters:a,getOriginalOperationsTotals:r,getOriginalOperations:E}=He(),$=C(new Date().toISOString().slice(0,7)),z=C([new Date($.value).toISOString().slice(0,10),new Date(+$.value.split("-")[0],+$.value.split("-")[1],1).toISOString().slice(0,10)]),N=C(""),R=C(!0),X=C("all"),W=C("all"),Y=C(""),c=C(null),k=C(!1),w={getState:()=>({columnFilters:[]})},d=te(()=>{const G=new Map,V=new Set,me=[];return l.value.forEach(T=>{if(T.isTransferOperation===!0){const ve=`${T.operationDate}_${Math.abs(T.accountAmount)}`;G.has(ve)||G.set(ve,[]),G.get(ve).push(T),V.add(T.operationId)}}),l.value.forEach(T=>{if(V.has(T.operationId)){const xe=`${T.operationDate}_${Math.abs(T.accountAmount)}`,ve=G.get(xe);if(ve&&ve[0].operationId===T.operationId&&ve.length>=2){const ut={...T,_isGrouped:!0,_groupedOperations:ve,account:{...T.account,name:ve.map(dt=>dt.account.name).join(" ↔ ")}};me.push(ut)}else ve&&ve.length===1&&me.push(T)}else me.push(T)}),me}),m=C(!1),M=async G=>{m.value=G,G||await Promise.all([J(!0),Q()])},Z=C(null),S=C([]),q=C([]),ae=C("categories"),f=C(""),y=C(""),pe=te(()=>{if(!f.value.trim())return v.value.expenseCategoryTotals;const G=f.value.toLowerCase().trim();return v.value.expenseCategoryTotals.filter(V=>V.title.toLowerCase().includes(G))}),de=te(()=>{if(!y.value.trim())return v.value.counterPartyTotals;const G=y.value.toLowerCase().trim();return v.value.counterPartyTotals.filter(V=>Ue(V.title).toLowerCase().includes(G))}),ne=G=>{const T=(Math.round(G*100)/100).toFixed(2).split(".");return`${T[0].replace(/\B(?=(\d{3})+(?!\d))/g," ")}.${T[1]} ₽`},_e=async()=>{await i(),N.value="all"},Q=async()=>{_.value=!0;try{const G=new Date(z.value[0]).toISOString().slice(0,10),V=new Date(z.value[1]).toISOString().slice(0,10);await r(G,V,N.value)}finally{_.value=!1}},J=async(G=!0)=>{console.log("getRangeData called with reset:",G,"account:",N.value,"isInitialLoad:",R.value),G&&(K.value=!0);try{const V=new Date(z.value[0]).toISOString().slice(0,10),me=new Date(z.value[1]).toISOString().slice(0,10),T=G?1:O.value.page+1;await E({from:V,to:me,page:T,limit:O.value.limit,accountId:N.value,distributionFilter:X.value!=="all"?X.value:void 0,counterPartyId:S.value.length>0?S.value:void 0,expenseCategoryId:q.value.length>0?q.value:void 0,typeOfOperation:W.value!=="all"?W.value:void 0,searchText:Y.value||void 0,reset:G})}finally{G&&(K.value=!1)}},ge=ua(()=>{J(!0)},300),ye=C(!1),Pe=C([]),ie=C(null),Ie=C(!1),ue=G=>{const me=d.value.find(T=>T.operationId===G);if(me?._isGrouped&&me?._groupedOperations)Pe.value=me._groupedOperations,ie.value=G,ye.value=!0;else{const T=l.value.find(xe=>xe.operationId===G);c.value=T||null,k.value=!0}},Le=G=>{c.value=G,k.value=!0,ye.value=!1,Pe.value=[],ie.value=null},Ke=async()=>{D.value=!0,await J(!1),D.value=!1},qe=async()=>{console.log("Refreshing operations after modal close"),await Promise.all([J(!0),Q()])},g=async()=>{await Promise.all([J(!0),Q()])},P=async()=>{await Promise.all([J(!0),Q()])},oe=G=>G.map(V=>{const me=new Date(V).toISOString().slice(0,10).split("-"),T=me[2],xe=me[1],ve=me[0];return`${T}.${xe}.${ve}`}).join(" / ");Ge(async()=>{await _e(),await Promise.all([J(),Q()]),R.value=!1});const Te=async()=>{const G=x.value?.trim()||void 0;await a(!1,G)},Ae=async G=>{const V=G.trim()||void 0;await a(!0,V)},fe=G=>{S.value=G,J(!0)},Oe=G=>{q.value=G,J(!0)},be=G=>{X.value=G,J(!0)},We=G=>{W.value=G,J(!0)},at=G=>{S.value=[],W.value="all",X.value="all",G!==null?q.value=[G]:q.value=[0],J(!0)},Be=(G,V)=>{S.value=[],X.value="all",W.value=G,q.value=[V!==null?V:0],J(!0)},Xe=G=>{q.value=[],W.value="all",X.value="all",S.value=[G],J(!0)},Je=(G,V)=>{W.value="all",X.value="all",q.value=[G],S.value=[V],J(!0)},je=(G,V)=>{q.value=[],X.value="all",W.value=G,S.value=[V],J(!0)};return le([z,N],async([G,V],[me,T])=>{R.value||(T&&T!==V&&(S.value=[],q.value=[],W.value="all",X.value="all"),console.log("Watch triggered - loading operations for account:",V),await Promise.all([J(),Q()]))},{deep:!0}),(G,V)=>{const me=Ze,T=Ye,xe=tt,ve=mt,ut=go,dt=et,Qt=Qe,ct=ke,Yt=bo,Zt=ho,Ut=lt,eo=st,pt=ze,Tt=ft,Ot=Et,to=nt,oo=Co,ao=wo,no=xo,so=Xa,lo=un,ro=cn,io=ss,uo=Ms,co=Ee,po=Re,mo=Fe,fo=Ve,vo=Me,_o=qs;return s(),I("div",Xs,[n("div",Js,[n("div",Qs,[n("div",Ys,[n("div",Zs,[e(o(ra),{modelValue:o(z),"onUpdate:modelValue":V[0]||(V[0]=j=>Ce(z)?z.value=j:null),range:"","enable-time-picker":!1,"auto-apply":"",locale:"ru",placeholder:"Выбрать дни","select-text":"Готово","cancel-text":"Закрыть",class:"grow",format:oe,clearable:!1},null,8,["modelValue"])]),e(Qt,{modelValue:o(N),"onUpdate:modelValue":V[1]||(V[1]=j=>Ce(N)?N.value=j:null)},{default:t(()=>[e(T,{class:"w-full"},{default:t(()=>[e(me,{placeholder:"Все счета"})]),_:1}),e(dt,null,{default:t(()=>[e(xe,{value:"all"},{default:t(()=>V[15]||(V[15]=[p("Все счета",-1)])),_:1,__:[15]}),(s(!0),I(ee,null,re(o(h),(j,De)=>(s(),A(xe,{key:De,value:String(j.value)},{default:t(()=>[p(B(j.label),1)]),_:2},1032,["value"]))),128)),e(ve,{class:"my-1"}),n("div",el,[e(ut,{onAccountCreated:o(i)},null,8,["onAccountCreated"])])]),_:1})]),_:1},8,["modelValue"]),e(ct,{variant:"outline",size:"icon",class:"h-10 w-10",onClick:V[2]||(V[2]=j=>Ie.value=!0)},{default:t(()=>[e(o(da),{class:"h-6 w-10"})]),_:1})]),e(no,{class:"w-[500px] flex-shrink-0 flex flex-col h-[calc(100vh-135px)] relative"},{default:t(()=>[o(_)?(s(),I("div",tl,[e(o(Vt),{class:"h-8 w-8 animate-spin text-primary"})])):H("",!0),e(Zt,{class:"p-0 flex-shrink-0"},{default:t(()=>[e(Yt)]),_:1}),e(oo,{class:"p-2 flex flex-col flex-1 min-h-0"},{default:t(()=>[e(to,{modelValue:o(ae),"onUpdate:modelValue":V[5]||(V[5]=j=>Ce(ae)?ae.value=j:null),class:"w-full flex flex-col flex-1 min-h-0"},{default:t(()=>[e(eo,{class:"grid w-full grid-cols-2 flex-shrink-0"},{default:t(()=>[e(Ut,{value:"categories"},{default:t(()=>V[16]||(V[16]=[p("Статьи",-1)])),_:1,__:[16]}),e(Ut,{value:"counterparties"},{default:t(()=>V[17]||(V[17]=[p("Контрагенты",-1)])),_:1,__:[17]})]),_:1}),e(Ot,{value:"categories",class:"mt-4 flex-1 min-h-0 flex flex-col"},{default:t(()=>[n("div",ol,[e(pt,{modelValue:o(f),"onUpdate:modelValue":V[3]||(V[3]=j=>Ce(f)?f.value=j:null),placeholder:"Поиск по статьям...",class:"h-8"},null,8,["modelValue"])]),e(Tt,{class:"flex-1 pr-2"},{default:t(()=>[n("div",null,[(s(!0),I(ee,null,re(o(pe),(j,De)=>(s(),I(ee,{key:De},[n("div",al,[n("div",nl,[n("span",{class:"text-sm font-medium truncate pr-2 flex-1 min-w-0 hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>at(j.expenseCategoryId)},B(j.title),9,sl),n("div",ll,[j.credit!==0?(s(),I("span",{key:0,class:"text-xs font-semibold whitespace-nowrap text-green-600 hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>Be("Credit",j.expenseCategoryId)}," +"+B(ne(j.credit)),9,rl)):H("",!0),j.transfer!==0?(s(),I("span",{key:1,class:"text-xs font-semibold whitespace-nowrap text-slate-500 hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>Be("Transfer",j.expenseCategoryId)}," ±"+B(ne(j.transfer)),9,il)):H("",!0),j.debit!==0?(s(),I("span",{key:2,class:"text-xs font-semibold whitespace-nowrap text-red-500 hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>Be("Debit",j.expenseCategoryId)}," −"+B(ne(j.debit)),9,ul)):H("",!0)])])]),De<o(pe).length-1?(s(),A(ve,{key:0,class:"my-1"})):H("",!0)],64))),128)),o(pe).length===0?(s(),I("div",dl,B(o(f)?"Нет совпадений":"Нет данных"),1)):H("",!0)])]),_:1})]),_:1}),e(Ot,{value:"counterparties",class:"mt-4 flex-1 min-h-0 flex flex-col"},{default:t(()=>[n("div",cl,[e(pt,{modelValue:o(y),"onUpdate:modelValue":V[4]||(V[4]=j=>Ce(y)?y.value=j:null),placeholder:"Поиск по контрагентам...",class:"h-8"},null,8,["modelValue"])]),e(Tt,{class:"flex-1 pr-2"},{default:t(()=>[n("div",null,[(s(!0),I(ee,null,re(o(de),(j,De)=>(s(),I(ee,{key:De},[n("div",pl,[n("div",ml,[n("span",{class:"text-sm font-medium truncate flex-1 min-w-0 hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>Xe(j.counterPartyId)},B(o(Ue)(j.title)),9,fl),n("div",vl,[j.credit!==0?(s(),I("span",_l,[j.incomeExpenseCategory?(s(),I("span",{key:0,class:"text-slate-500 font-normal mr-1 hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>Je(j.incomeExpenseCategory.id,j.counterPartyId)},B(j.incomeExpenseCategory.name)+": ",9,gl)):H("",!0),n("span",{class:"hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>je("Credit",j.counterPartyId)}," +"+B(ne(j.credit)),9,yl)])):H("",!0),j.transfer!==0?(s(),I("span",{key:1,class:"text-xs font-semibold whitespace-nowrap text-slate-500 hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>je("Transfer",j.counterPartyId)}," ±"+B(ne(j.transfer)),9,xl)):H("",!0),j.debit!==0?(s(),I("span",hl,[j.outcomeExpenseCategory?(s(),I("span",{key:0,class:"text-slate-500 font-normal mr-1 hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>Je(j.outcomeExpenseCategory.id,j.counterPartyId)},B(j.outcomeExpenseCategory.name)+": ",9,bl)):H("",!0),n("span",{class:"hover:bg-slate-100 rounded px-1 py-0.5 cursor-pointer transition-colors",onClick:$e=>je("Debit",j.counterPartyId)}," −"+B(ne(j.debit)),9,Cl)])):H("",!0)])])]),De<o(de).length-1?(s(),A(ve,{key:0,class:"my-1"})):H("",!0)],64))),128)),o(de).length===0?(s(),I("div",wl,B(o(y)?"Нет совпадений":"Нет данных"),1)):H("",!0)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(ao,{class:"p-2 pt-0 border-t border-slate-200"},{default:t(()=>[n("div",kl,[n("span",Pl," Доходы: "+B(ne(o(v).mainTotals?.credit??0)),1),o(v).mainTotals?.transfer!==0?(s(),I("span",Il," Перемещения: ±"+B(ne(o(v).mainTotals?.transfer??0)),1)):H("",!0),n("span",$l," Расходы: "+B(ne(o(v).mainTotals?.debit??0)),1),n("span",Ul," Чистая прибыль: "+B(ne(o(v).mainTotals?.netProfit??0)),1),n("span",Tl," Рентабельность: "+B(o(v).mainTotals?.profitability)+"% ",1),n("span",Ol," Дивиденды: "+B(ne(o(v).mainTotals?.dividends??0)),1)])]),_:1})]),_:1})]),n("div",Dl,[n("div",Sl,[n("div",Ml,[e(pt,{modelValue:o(Y),"onUpdate:modelValue":V[6]||(V[6]=j=>Ce(Y)?Y.value=j:null),placeholder:"Поиск по операциям...",class:"max-w-[200px] h-8 z-[1] pr-8",onInput:o(ge)},null,8,["modelValue","onInput"]),o(Y)?(s(),I("button",{key:0,type:"button",class:"absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors",onClick:V[7]||(V[7]=()=>{Y.value="",J(!0)})},[e(o(ia),{class:"h-4 w-4"})])):H("",!0)]),n("div",Vl,[(s(),A(so,{key:o(N),"account-id":+o(N),onOperationCreated:V[8]||(V[8]=async()=>{await J(!0)})},null,8,["account-id"])),e(ct,{class:"h-8 z-[1]",variant:"outline",onClick:V[9]||(V[9]=()=>{Z.value=null,m.value=!0})},{default:t(()=>V[18]||(V[18]=[p(" Правила ",-1)])),_:1,__:[18]})])]),n("div",Fl,[n("div",El,[e(lo,{table:w,"counter-parties-filters":o(u),"expense-categories-filters":o(U),"distribution-filter":o(X),"type-of-operation-filter":o(W),"selected-counter-party-ids":o(S),"selected-expense-category-ids":o(q),"counter-parties-filters-pagination":o(L),"is-loading-counter-parties":o(b),"on-counter-parties-load-more":Te,"on-counter-parties-search":Ae,onCounterPartiesFilterChange:fe,onExpenseCategoriesFilterChange:Oe,onDistributionFilterChange:be,onTypeOfOperationFilterChange:We},null,8,["table","counter-parties-filters","expense-categories-filters","distribution-filter","type-of-operation-filter","selected-counter-party-ids","selected-expense-category-ids","counter-parties-filters-pagination","is-loading-counter-parties","onExpenseCategoriesFilterChange","onTypeOfOperationFilterChange"])])]),n("div",Rl,[o(K)?(s(),I("div",Ll,[e(o(Vt),{class:"h-8 w-8 animate-spin text-primary"})])):H("",!0),e(ro,{columns:o(Ws),data:o(d),"is-loading":o(K),"is-loading-more":o(D),"has-more":o(O).hasNext,"is-initial-load":o(R),onItemClicked:ue,onLoadMore:Ke},null,8,["columns","data","is-loading","is-loading-more","has-more","is-initial-load"])])])]),e(io,{"is-open":o(m),rule:o(Z),"onUpdate:isOpen":M,onSaved:V[10]||(V[10]=()=>{o(se)({title:"Успех",description:"Правило сохранено."})}),onDeleted:V[11]||(V[11]=()=>{o(se)({title:"Удалено",description:"Правило удалено."})})},null,8,["is-open","rule"]),o(c)?(s(),A(uo,{key:o(c).id,operation:o(c),"is-open":o(k),"onUpdate:isOpen":V[12]||(V[12]=j=>k.value=j),onRefreshOperations:qe,onDelete:g,onSave:P},null,8,["operation","is-open"])):H("",!0),e(vo,{open:o(ye),"onUpdate:open":V[13]||(V[13]=j=>Ce(ye)?ye.value=j:null)},{default:t(()=>[e(fo,{class:"max-w-md"},{default:t(()=>[e(mo,null,{default:t(()=>[e(co,null,{default:t(()=>V[19]||(V[19]=[p("Выберите операцию",-1)])),_:1,__:[19]}),e(po,null,{default:t(()=>V[20]||(V[20]=[p(" Выберите одну из операций перемещения для просмотра ",-1)])),_:1,__:[20]})]),_:1}),n("div",Al,[(s(!0),I(ee,null,re(o(Pe),j=>(s(),A(ct,{key:j.operationId,variant:"outline",class:"justify-start text-left h-auto py-3",onClick:De=>Le(j)},{default:t(()=>[n("div",Bl,[n("div",jl,B(j.account.name),1),n("div",zl,B(ne(Math.abs(j.accountAmount))),1),j.payPurpose?(s(),I("div",Nl,B(j.payPurpose),1)):H("",!0)])]),_:2},1032,["onClick"]))),128))])]),_:1})]),_:1},8,["open"]),e(_o,{"is-open":o(Ie),"onUpdate:isOpen":V[14]||(V[14]=j=>Ie.value=j)},null,8,["is-open"])])}}});export{Or as default};
